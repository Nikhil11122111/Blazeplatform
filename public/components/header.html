<!-- [ Header Topbar ] start -->
<header class="pc-header">
  <div class="header-wrapper">
    <!-- [Mobile Media Block] start -->
    <div class="me-auto pc-mob-drp">
      <ul class="list-unstyled">
        <li class="pc-h-item pc-sidebar-collapse">
          <a href="#" class="pc-head-link ms-0" id="sidebar-hide">
            <i class="ti ti-menu-2"></i>
          </a>
        </li>
        <li class="pc-h-item pc-sidebar-popup">
          <a href="#" class="pc-head-link ms-0" id="mobile-collapse">
            <i class="ti ti-menu-2"></i>
          </a>
        </li>
        <li class="pc-h-item">
          <a href="#" class="pc-head-link ms-0" id="refresh-data-btn" title="Refresh Data" onclick="refreshData()">
            <i class="ti ti-refresh"></i>
          </a>
        </li>
      </ul>
    </div>
    <!-- [Mobile Media Block end] -->
    <div class="ms-auto">
      <ul class="list-unstyled">
        <li class="dropdown pc-h-item">
          <a
            class="pc-head-link dropdown-toggle arrow-none me-0"
            data-bs-toggle="dropdown"
            href="#"
            role="button"
            aria-haspopup="false"
            aria-expanded="false"
            id="notificationDropdown"
          >
            <i class="ti ti-bell"></i>
            <span class="badge bg-danger pc-h-badge" id="notification-badge" style="display: none;">0</span>
          </a>

          <style>
            /* Notification badge pulse animation */
            @keyframes badgePulse {
              0% { transform: scale(1); }
              50% { transform: scale(1.2); }
              100% { transform: scale(1); }
            }
            
            .badge-pulse {
              animation: badgePulse 0.5s ease-in-out 2;
            }
            
            /* Notification dropdown styles */
            .dropdown-notification {
              max-width: 350px;
              min-width: 300px;
              max-height: none !important;
            }
            
            /* Fix dropdown positioning */
            .dropdown-notification.show {
              display: flex !important;
              flex-direction: column;
            }
            
            /* Header styles */
            .dropdown-notification .dropdown-header {
              padding: 0.75rem 1rem;
              border-bottom: 1px solid var(--bs-border-color);
              flex-shrink: 0;
            }
            
            /* Body styles with fixed height and scrolling */
            .dropdown-notification .dropdown-body {
              padding: 0;
              overflow: hidden;
              position: relative;
              height: auto;
              max-height: 300px; /* Height that fits about 4 notifications */
              overflow-y: auto;
              scrollbar-width: thin;
              scrollbar-color: rgba(var(--bs-primary-rgb), 0.2) transparent;
            }
            
            /* Scrollbar styling */
            .dropdown-notification .dropdown-body::-webkit-scrollbar {
              width: 4px;
            }
            
            .dropdown-notification .dropdown-body::-webkit-scrollbar-track {
              background: transparent;
            }
            
            .dropdown-notification .dropdown-body::-webkit-scrollbar-thumb {
              background-color: rgba(var(--bs-primary-rgb), 0.2);
              border-radius: 4px;
            }
            
            /* Notification card styles */
            .dropdown-notification .card {
              margin: 0.5rem;
              border-radius: 0.5rem;
              transition: background-color 0.2s ease;
              cursor: pointer;
              border-left: 3px solid transparent;
            }
            
            .dropdown-notification .card.bg-light-primary {
              border-left-color: var(--bs-primary);
            }
            
            .dropdown-notification .card:hover {
              background-color: rgba(var(--bs-primary-rgb), 0.1);
            }
            
            /* Date separator styles */
            .dropdown-notification .text-span {
              padding: 0.5rem 1rem;
              margin: 0;
              background: var(--bs-body-bg);
              top: 0;
              z-index: 1;
              font-weight: 500;
            }
            
            /* Footer styles */
            .dropdown-notification .dropdown-footer {
              padding: 0.75rem 1rem;
              border-top: 1px solid var(--bs-border-color);
              background: var(--bs-body-bg);
              flex-shrink: 0;
            }
            
            /* Animation for new notifications */
            @keyframes fadeIn {
              from { opacity: 0; transform: translateY(-10px); }
              to { opacity: 1; transform: translateY(0); }
            }
            
            .dropdown-notification .card {
              animation: fadeIn 0.3s ease-out;
            }
          </style>

          <div class="dropdown-menu dropdown-notification dropdown-menu-end pc-h-dropdown">
            <div class="dropdown-header d-flex align-items-center justify-content-between">
              <h5 class="m-0">Notifications</h5>
              <a href="#!" class="btn btn-link btn-sm" id="mark-all-read" onclick="typeof window.markAllNotificationsAsRead === 'function' ? window.markAllNotificationsAsRead() : (typeof markAllNotificationsAsRead === 'function' ? markAllNotificationsAsRead() : handleMarkAllRead())">Mark all read</a>
            </div>
            <div class="dropdown-body text-wrap header-notification-scroll">
              <!-- Notifications will be loaded here -->
            </div>
            <div class="dropdown-footer text-center">
                </div>
          </div>
        </li>
        <li class="dropdown pc-h-item header-user-profile">
          <a class="pc-head-link dropdown-toggle arrow-none me-0" data-bs-toggle="dropdown" href="#" role="button" aria-haspopup="false" data-bs-auto-close="outside" aria-expanded="false">
            <img src="../assets/images/user/blank-avatar.png" alt="user-image" class="user-avtar" id="header-profile-img" data-profile-picture />
          </a>
          <div class="dropdown-menu dropdown-user-profile dropdown-menu-end pc-h-dropdown">
            <div class="dropdown-body">
              <div class="profile-notification-scroll position-relative" style="max-height: calc(100vh - 225px)">
                <div class="d-flex mb-1">
                  <div class="flex-shrink-0">
                    <img src="../assets/images/user/blank-avatar.png" alt="user-image" class="user-avtar wid-35" id="header-dropdown-profile-img" data-profile-picture />
                  </div>
                  <div class="flex-grow-1 ms-3">
                    <h6 class="mb-1" id="header-user-name">Full Name</h6>
                    <span id="header-user-email">email@company.io</span>
                  </div>
                </div>
                <hr class="border-secondary border-opacity-50" />
                <p class="text-span">Manage</p>
                <a href="change-password.html" class="dropdown-item">
                  <span>
                    <svg class="pc-icon text-muted me-2">
                      <use xlink:href="#custom-lock-outline"></use>
                    </svg>
                    <span>Change Password</span>
                  </span>
                </a>
                <hr class="border-secondary border-opacity-50" />
                <div class="d-grid mb-3">
                  <button class="btn btn-primary" onclick="logout()">
                    <svg class="pc-icon me-2">
                      <use xlink:href="#custom-logout-1-outline"></use>
                    </svg>
                    Logout
                  </button>
                </div>
              </div>
            </div>
          </div>
        </li>
      </ul>
    </div>
  </div>
</header>

<!-- Add Socket.IO client script -->
<script src="/socket.io/socket.io.js"></script>

<!-- Add notifications handler script -->
<script src="/assets/js/notifications-handler.js"></script>

<!-- Add profile picture and theme handlers -->
<script src="/js/profile-picture-handler.js"></script>
<script src="/js/theme-handler.js"></script>
<!-- [ Header ] end --> 

<style>
  /* Ensure mobile collapse button is shown on small screens */
  @media (max-width: 991.98px) {
    #mobile-collapse {
      display: flex !important; /* Use flex to align icon */
    }
    #sidebar-hide {
      display: none !important;
    }
    /* Ensure other header items adjust if needed */
    .pc-header .header-wrapper .me-auto.pc-mob-drp {
       display: flex;
       align-items: center;
    }
    .pc-header .header-wrapper .me-auto.pc-mob-drp .pc-h-item {
        display: flex; /* Ensure list items are flex for alignment */
        align-items: center;
        margin-right: 10px; /* Add some spacing */
    }
     .pc-header .header-wrapper .me-auto.pc-mob-drp .pc-h-item:last-child {
         margin-right: 0;
     }
  }
</style>

<!-- Debug script for notification issues -->
<script>
  // Function to handle mark all read
  function handleMarkAllRead() {
    console.log('Marking all notifications as read...');
    
    // Show loading state
    const notificationBody = document.querySelector('.dropdown-body.header-notification-scroll');
    if (notificationBody) {
      const originalContent = notificationBody.innerHTML;
      notificationBody.innerHTML = `
        <div class="text-center py-3">
          <div class="spinner-border spinner-border-sm text-primary" role="status">
            <span class="visually-hidden">Marking as read...</span>
          </div>
          <p class="text-muted mb-0 mt-2">Marking all as read...</p>
        </div>
      `;

      // Get auth token
      const token = localStorage.getItem('token') || sessionStorage.getItem('token');
      const sessionId = localStorage.getItem('sessionId') || sessionStorage.getItem('sessionId');
      
      if (!token) {
        console.error('Not authenticated, cannot mark as read');
        notificationBody.innerHTML = originalContent;
        return;
      }

      // Hide notification badge
      const badge = document.getElementById('notification-badge');
      if (badge) {
        badge.style.display = 'none';
      }

      // Make API call
      fetch('/api/notifications/read-all', {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`,
          'X-Session-ID': sessionId || ''
        }
      })
      .then(response => {
        if (!response.ok) throw new Error('Network response was not ok');
        return response.json();
      })
      .then(data => {
        console.log('Successfully marked all notifications as read:', data);
        
        // Update UI to show all notifications as read
        const notifications = document.querySelectorAll('.dropdown-notification .card');
        notifications.forEach(notification => {
          notification.classList.remove('bg-light-primary');
        });

        // Show success message briefly
        notificationBody.innerHTML = `
          <div class="text-center py-3">
            <i class="ti ti-check text-success fs-3"></i>
            <p class="text-success mb-0 mt-2">All notifications marked as read</p>
          </div>
        `;

        // Reload notifications after a short delay
        setTimeout(() => {
          if (typeof loadNotifications === 'function') {
            loadNotifications(true);
          } else {
            notificationBody.innerHTML = originalContent;
          }
        }, 1500);
      })
      .catch(error => {
        console.error('Error marking notifications as read:', error);
        
        // Show error message
        notificationBody.innerHTML = `
          <div class="text-center py-3">
            <i class="ti ti-alert-triangle text-danger fs-3"></i>
            <p class="text-danger mb-0 mt-2">Error marking notifications as read</p>
            <button class="btn btn-link btn-sm mt-2" onclick="handleMarkAllRead()">Try Again</button>
          </div>
        `;
      });
    }
  }

  // Make sure the mark-all-read button always works
  document.addEventListener('DOMContentLoaded', function() {
    const markAllReadBtn = document.getElementById('mark-all-read');
    if (markAllReadBtn) {
      markAllReadBtn.addEventListener('click', function(e) {
        e.preventDefault();
        handleMarkAllRead();
      });
    }
  });

  // Function to refresh data
  function refreshData() {
    console.log('Refreshing data...');
    
    // Show a loading indicator
    const refreshButton = document.getElementById('refresh-data-btn');
    if (refreshButton) {
      const originalContent = refreshButton.innerHTML;
      refreshButton.innerHTML = '<i class="ti ti-loader ti-spin"></i>';
      refreshButton.style.pointerEvents = 'none';
      
      // Restore after animation
      setTimeout(() => {
        refreshButton.innerHTML = originalContent;
        refreshButton.style.pointerEvents = 'auto';
      }, 1000);
    }
    
    // Check which page we're on and refresh the appropriate data
    const currentPath = window.location.pathname;
    
    // Refresh based on current page
    if (currentPath.includes('connections.html')) {
      // Call connection-specific refresh functions
      if (typeof loadConnections === 'function') loadConnections();
      if (typeof loadPendingRequests === 'function') loadPendingRequests();
      if (typeof loadSentInvitations === 'function') loadSentInvitations();
    } 
    else if (currentPath.includes('dashboard.html')) {
      // Refresh dashboard data
      if (typeof loadDashboardData === 'function') loadDashboardData();
    }
    else if (currentPath.includes('profile.html')) {
      // Refresh profile data
      if (typeof fetchProfileData === 'function') fetchProfileData();
    }
    
    // Always refresh notifications
    if (typeof loadNotifications === 'function') loadNotifications(true);
    
    // Show success message
    showToastMessage('Data refreshed successfully', 'success');
  }
  
  // Helper function to show toast messages
  function showToastMessage(message, type = 'info') {
    // Check if Toast component is available
    if (typeof bootstrap !== 'undefined' && typeof bootstrap.Toast !== 'undefined') {
      // Create toast element if it doesn't exist
      let toastContainer = document.querySelector('.toast-container');
      if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
        document.body.appendChild(toastContainer);
      }
      
      // Create toast element
      const toastElement = document.createElement('div');
      toastElement.className = `toast align-items-center text-white bg-${type} border-0`;
      toastElement.setAttribute('role', 'alert');
      toastElement.setAttribute('aria-live', 'assertive');
      toastElement.setAttribute('aria-atomic', 'true');
      
      toastElement.innerHTML = `
        <div class="d-flex">
          <div class="toast-body">
            ${message}
          </div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
      `;
      
      toastContainer.appendChild(toastElement);
      
      // Initialize and show toast
      const toast = new bootstrap.Toast(toastElement, { delay: 2000 });
      toast.show();
      
      // Remove toast element after it's hidden
      toastElement.addEventListener('hidden.bs.toast', function() {
        toastElement.remove();
      });
    } else {
      // Fallback to console log if Toast is not available
      console.log(`Message: ${message} (${type})`);
    }
  }
</script> 