<!DOCTYPE html>
<html lang="en">
  <!-- [Head] start -->
  <head>
    <!-- Theme Settings Remover - Add at the very beginning -->
    <script src="js/hide-theme-settings.js"></script>
    
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Magic Suggest - Blaze</title>
    
    <!-- [Favicon] icon -->
    <link rel="icon" href="../assets/images/favicon.svg" type="image/x-icon">
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/remixicon@2.5.0/fonts/remixicon.css" rel="stylesheet">
    <!-- [Font] Family -->
    <link rel="stylesheet" href="../assets/fonts/inter/inter.css" id="main-font-link" />
    <link rel="stylesheet" href="../assets/css/plugins/datepicker-bs5.min.css">

    <!-- [Tabler Icons] https://tablericons.com -->
    <link rel="stylesheet" href="../assets/fonts/tabler-icons.min.css" />
    <!-- [Feather Icons] https://feathericons.com -->
    <link rel="stylesheet" href="../assets/fonts/feather.css" />
    <!-- [Font Awesome Icons] https://fontawesome.com/icons -->
    <link rel="stylesheet" href="../assets/fonts/fontawesome.css" />
    <!-- [Material Icons] https://fonts.google.com/icons -->
    <link rel="stylesheet" href="../assets/fonts/material.css" />
    <!-- [Template CSS Files] -->
    <link rel="stylesheet" href="../assets/css/style.css" id="main-style-link" />
    <link rel="stylesheet" href="../assets/css/style-preset.css" />
    <!-- [Choices CSS] -->
    <link rel="stylesheet" href="../assets/css/plugins/select.bootstrap5.min.css" />
    <!-- [Datepicker CSS] -->
    <link rel="stylesheet" href="../assets/css/plugins/datepicker-bs5.min.css" />
    

    
    <!-- Magic Suggest Preloader Styles -->
    <style>
        .magic-preloader {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
            transition: opacity 0.5s ease-out;
            border-radius: 0.5rem;
        }
        
        .magic-preloader.hidden {
            opacity: 0;
            pointer-events: none;
            z-index: -1;
        }
        
        .magic-preloader-content {
            text-align: center;
            position: absolute;
            top: 20%;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 500px;
        }
        
        .magic-preloader-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            color: var(--bs-primary);
            animation: magic-pulse 2s infinite;
        }
        
        .magic-preloader-text {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--bs-primary);
        }
        
        .magic-preloader-subtext {
            font-size: 1rem;
            color: var(--bs-secondary);
        }
        
        .magic-preloader-progress {
            width: 200px;
            height: 4px;
            background-color: rgba(0, 0, 0, 0.1);
            border-radius: 2px;
            margin: 1.5rem auto 0;
            overflow: hidden;
        }
        
        .magic-preloader-progress-bar {
            height: 100%;
            background-color: var(--bs-primary);
            width: 0%;
            border-radius: 2px;
            transition: width 0.3s ease;
        }
        
        @keyframes magic-pulse {
            0% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(1.2);
                opacity: 0.7;
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }
        
        .magic-icons {
            display: flex;
            justify-content: center;
            margin-bottom: 1.5rem;
            position: relative;
        }
        
        .magic-icon {
            font-size: 2rem;
            margin: 0 0.5rem;
            color: var(--bs-primary);
            position: relative;
        }
        
        /* Match lighting animation */
        .magic-icon:first-child {
            animation: match-strike 3s infinite;
            transform-origin: bottom center;
            color: #555;
        }
        
        .magic-icon:nth-child(2) {
            animation: match-flame 3s infinite;
            animation-delay: 0.2s;
            color: #ff9900;
            filter: drop-shadow(0 0 5px #ff9900);
        }
        
        .magic-icon:nth-child(3) {
            animation: match-glow 3s infinite;
            animation-delay: 0.4s;
            color: #ff5500;
            filter: drop-shadow(0 0 8px #ff5500);
        }
        
        /* Match stick animation */
        @keyframes match-strike {
            0% {
                transform: translateY(0) rotate(-5deg);
                color: #555;
            }
            10% {
                transform: translateY(0) rotate(5deg);
                color: #555;
            }
            20% {
                transform: translateY(0) rotate(-5deg);
                color: #555;
            }
            30% {
                transform: translateY(0) rotate(0deg);
                color: #555;
            }
            35% {
                transform: translateY(0) rotate(0deg);
                color: #555;
            }
            40% {
                transform: translateY(-5px);
                color: #555;
            }
            100% {
                transform: translateY(0);
                color: #555;
            }
        }
        
        /* Flame animation */
        @keyframes match-flame {
            0% {
                opacity: 0;
                transform: scale(0.8) translateY(5px);
                filter: drop-shadow(0 0 0px #ff9900);
            }
            30% {
                opacity: 0;
                transform: scale(0.8) translateY(5px);
                filter: drop-shadow(0 0 0px #ff9900);
            }
            35% {
                opacity: 0.3;
                transform: scale(1) translateY(0);
                filter: drop-shadow(0 0 3px #ff9900);
            }
            40% {
                opacity: 1;
                transform: scale(1.2) translateY(-5px);
                filter: drop-shadow(0 0 5px #ff9900);
            }
            70% {
                opacity: 1;
                transform: scale(1.1) translateY(-3px);
                filter: drop-shadow(0 0 8px #ff9900);
            }
            100% {
                opacity: 0.7;
                transform: scale(1) translateY(0);
                filter: drop-shadow(0 0 5px #ff9900);
            }
        }
        
        /* Glow/sparks animation */
        @keyframes match-glow {
            0% {
                opacity: 0;
                transform: scale(0.5) translateY(5px);
                filter: drop-shadow(0 0 0px #ff5500);
            }
            35% {
                opacity: 0;
                transform: scale(0.5) translateY(5px);
                filter: drop-shadow(0 0 0px #ff5500);
            }
            40% {
                opacity: 0.5;
                transform: scale(0.8) translateY(0);
                filter: drop-shadow(0 0 3px #ff5500);
            }
            45% {
                opacity: 1;
                transform: scale(1.3) translateY(-8px);
                filter: drop-shadow(0 0 10px #ff5500);
            }
            80% {
                opacity: 0.8;
                transform: scale(1.1) translateY(-5px);
                filter: drop-shadow(0 0 15px #ff5500);
            }
            100% {
                opacity: 0.5;
                transform: scale(1) translateY(0);
                filter: drop-shadow(0 0 8px #ff5500);
            }
        }
        
        /* Remove old animation styles */
        /*
        @keyframes magic-float {
            0% {
                transform: translateY(0) rotate(0deg);
            }
            50% {
                transform: translateY(-15px) rotate(10deg);
            }
            100% {
                transform: translateY(0) rotate(0deg);
            }
        }
        */
        
        .pc-content {
            opacity: 1;
        }
        
        .coming-soon-content {
            opacity: 0;
            transition: opacity 0.5s ease-in;
            position: relative;
            z-index: 1;
        }
        
        .coming-soon-content.visible {
            opacity: 1;
        }
        
        .card {
            position: relative;
            overflow: hidden;
        }
        
        /* Multi-select styles for filter fields */
        .multi-select-container {
          position: relative;
          width: 100%;
          min-height: 38px;
          border: 1px solid #ced4da;
          border-radius: 0.375rem;
          padding: 0.25rem;
          background: #fff;
          cursor: text;
        }

        .multi-select-container:focus-within {
          border-color: #86b7fe;
          box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
        }

        .tags-container {
          display: flex;
          flex-wrap: wrap;
          gap: 0.25rem;
          align-items: center;
          min-height: 24px;
        }

        .industry-tag {
          display: inline-flex;
          align-items: center;
          background: #e9ecef;
          padding: 0.25rem 0.5rem;
          border-radius: 0.25rem;
          font-size: 0.875rem;
          margin: 2px;
        }

        .industry-tag .remove-tag {
          margin-left: 0.5rem;
          cursor: pointer;
          font-size: 1.2rem;
          line-height: 1;
          color: #6c757d;
        }

        .industry-tag .remove-tag:hover {
          color: #dc3545;
        }

        .industry-input {
          border: none;
          outline: none;
          padding: 0.25rem;
          flex: 1;
          min-width: 120px;
          font-size: 0.875rem;
        }

        .industry-dropdown {
          position: absolute;
          top: 100%;
          left: 0;
          right: 0;
          background: white;
          border: 1px solid rgba(0,0,0,0.15);
          border-radius: 0.375rem;
          box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.15);
          max-height: 200px;
          overflow-y: auto;
          z-index: 1000;
          display: none;
        }

        .industry-option {
          padding: 0.5rem 1rem;
          cursor: pointer;
        }

        .industry-option:hover {
          background-color: #f8f9fa;
        }
        
        /* Major Sub-Category Custom Dropdown Styles */
        .major-subcategory-container {
          position: relative;
        }
        
        .major-subcategory-input {
          cursor: pointer;
          transition: all 0.2s ease;
        }
        
        .major-subcategory-input:disabled {
          background-color: #f8f9fa;
          cursor: not-allowed;
        }
        
        .major-subcategory-input.custom-input-active {
          cursor: text;
          border-color: var(--bs-primary);
          box-shadow: 0 0 0 0.25rem rgba(var(--bs-primary-rgb), 0.25);
        }
        
        .major-subcategory-container.custom-mode-active .major-subcategory-input {
          background-color: #f8f9fa;
          border-color: var(--bs-primary);
        }
        
        .major-subcategory-dropdown {
          position: absolute;
          top: 100%;
          left: 0;
          right: 0;
          max-height: 200px;
          overflow-y: auto;
          background: white;
          border: 1px solid rgba(0,0,0,0.15);
          border-radius: 0.375rem;
          box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.15);
          z-index: 1000;
          display: none;
        }
        
        .major-subcategory-item {
          padding: 0.5rem 1rem;
          cursor: pointer;
          transition: background-color 0.15s ease-in-out;
        }
        
        .major-subcategory-item:hover {
          background-color: #f8f9fa;
        }
        
        .major-subcategory-item.active {
          background-color: rgba(var(--bs-primary-rgb), 0.1);
          color: var(--bs-primary);
        }
        
        .major-subcategory-divider {
          height: 1px;
          background-color: rgba(0,0,0,0.1);
          margin: 0.5rem 0;
        }
        
        .major-subcategory-custom-option {
          color: var(--bs-primary);
          font-weight: 500;
        }
        
        .custom-input-message {
          position: absolute;
          top: 100%;
          left: 0;
          right: 0;
          padding: 0.5rem;
          background: white;
          border: 1px solid rgba(0,0,0,0.15);
          border-radius: 0.375rem;
          box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.15);
          z-index: 1000;
          display: none;
          margin-top: 5px;
          font-size: 0.875rem;
          color: var(--bs-secondary);
        }

        @media (max-width: 991.98px) {
          .pc-sidebar {
            z-index: 1041 !important; /* higher than overlay */
          }
      
          .pc-sidebar-overlay {
            position: fixed;
            top: 0;
            left: 280px; /* width of your sidebar */
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1040; /* less than sidebar */
            transition: left 0.3s;
          }
        }
    </style>
  </head>
  <!-- [Head] end -->
  <!-- [Body] Start -->
  <body>
    <!-- [ Pre-loader ] start -->
    <div class="loader-bg">
      <div class="loader-track">
        <div class="loader-fill"></div>
      </div>
    </div>
    <!-- [ Pre-loader ] End -->

    <!-- Include sidebar -->
    <div id="sidebar-container"></div>
    
    <!-- Include header -->
    <div id="header-container"></div>

    <!-- [ Main Content ] start -->
    <div class="pc-container">
      <!-- Filter Overlay for mobile -->
      <div id="filterOverlay" class="filter-overlay"></div>
      
      <div class="pc-content">
        <!-- [ breadcrumb ] start -->
        <div class="page-header" style="z-index: -1">
          <div class="page-block">
            <div class="row align-items-center">
              <div class="col-md-12">
                <ul class="breadcrumb">
                  <li class="breadcrumb-item"><a href="">Home</a></li>
                  <li class="breadcrumb-item" aria-current="page">Magic Suggest</li>
                </ul>
              </div>
            </div>
          </div>
        </div>
        <!-- [ breadcrumb ] end -->

        <!-- [ Main Content ] start -->
        <div class="row">
          <div class="col-md-12">
            <div class="card">
              <!-- Magic Suggest Preloader -->
              <div class="magic-preloader">
                <div class="magic-preloader-content">
                  <div class="magic-icons">
                    <i class="ti ti-wand magic-icon"></i>
                    <i class="ti ti-sparkles magic-icon"></i>
                    <i class="ti ti-stars magic-icon"></i>
                  </div>
                  <div class="magic-preloader-text">Firing Up Matches</div>
                  <div class="magic-preloader-subtext">Gathering personalized recommendations for you</div>
                  <div class="magic-preloader-progress">
                    <div class="magic-preloader-progress-bar"></div>
                  </div>
                </div>
              </div>
              
              <div class="card-body coming-soon-content">
                <div class="row">
                  <!-- Toggle sidebar button - visible on mobile and desktop -->
                  <div class="col-12 mb-3">
                    <button id="filterToggleBtn" class="btn btn-light" type="button" data-bs-toggle="collapse" data-bs-target="#filterSidebar" aria-expanded="true" aria-controls="filterSidebar">
                      <i class="ti ti-menu-2"></i> <span>Filters</span>
                    </button>
                  </div>
                  
                  <!-- Filter sidebar - collapsible -->
                  <div class="col-md-3">
                    <div id="filterSidebar" class="collapse show">
                      <div class="card sticky-top filter-card" style="top: 85px">
                        <div class="card-header d-flex align-items-center justify-content-between">
                          <h5>Filter Options</h5>
                          <button type="button" class="btn-close d-md-none" data-bs-toggle="collapse" data-bs-target="#filterSidebar" aria-label="Close"></button>
                        </div>
                        <div class="card-body filter-body">

                          
                          <!-- Filter options -->
                          <form id="filter-form">
                            <!-- Gender -->
                            <div class="mb-3">
                              <label class="form-label">Gender</label>
                              <select class="form-select" id="gender-filter" name="gender">
                                <option value="">All</option>
                                <option value="Male">Male</option>
                                <option value="Female">Female</option>
                                <option value="Other">Other</option>
                                <option value="Prefer not to say">Prefer not to say</option>
                              </select>
                              </div>
                            <!-- Institution -->
                            <div class="mb-3">
                              <label for="institution" class="form-label">Institution</label>
                              <input type="text" class="form-control" id="institution-filter" name="institution" placeholder="Search for your institution" data-ipedsid="manual-entry">
                              <div id="institutionSuggestions" class="list-group position-absolute w-100" style="display: none; z-index: 1000;"></div>
                              </div>
                            <!-- State -->
                            <div class="mb-3">
                              <label for="state-filter" class="form-label">State</label>
                              <select class="form-select" id="state-filter" name="state">
                                <option value="">All</option>
                                <option value="Alabama">Alabama</option>
                                <option value="Alaska">Alaska</option>
                                <option value="Arizona">Arizona</option>
                                <option value="Arkansas">Arkansas</option>
                                <option value="California">California</option>
                                <option value="Colorado">Colorado</option>
                                <option value="Connecticut">Connecticut</option>
                                <option value="Delaware">Delaware</option>
                                <option value="Florida">Florida</option>
                                <option value="Georgia">Georgia</option>
                                <option value="Hawaii">Hawaii</option>
                                <option value="Idaho">Idaho</option>
                                <option value="Illinois">Illinois</option>
                                <option value="Indiana">Indiana</option>
                                <option value="Iowa">Iowa</option>
                                <option value="Kansas">Kansas</option>
                                <option value="Kentucky">Kentucky</option>
                                <option value="Louisiana">Louisiana</option>
                                <option value="Maine">Maine</option>
                                <option value="Maryland">Maryland</option>
                                <option value="Massachusetts">Massachusetts</option>
                                <option value="Michigan">Michigan</option>
                                <option value="Minnesota">Minnesota</option>
                                <option value="Mississippi">Mississippi</option>
                                <option value="Missouri">Missouri</option>
                                <option value="Montana">Montana</option>
                                <option value="Nebraska">Nebraska</option>
                                <option value="Nevada">Nevada</option>
                                <option value="New Hampshire">New Hampshire</option>
                                <option value="New Jersey">New Jersey</option>
                                <option value="New Mexico">New Mexico</option>
                                <option value="New York">New York</option>
                                <option value="North Carolina">North Carolina</option>
                                <option value="North Dakota">North Dakota</option>
                                <option value="Ohio">Ohio</option>
                                <option value="Oklahoma">Oklahoma</option>
                                <option value="Oregon">Oregon</option>
                                <option value="Pennsylvania">Pennsylvania</option>
                                <option value="Rhode Island">Rhode Island</option>
                                <option value="South Carolina">South Carolina</option>
                                <option value="South Dakota">South Dakota</option>
                                <option value="Tennessee">Tennessee</option>
                                <option value="Texas">Texas</option>
                                <option value="Utah">Utah</option>
                                <option value="Vermont">Vermont</option>
                                <option value="Virginia">Virginia</option>
                                <option value="Washington">Washington</option>
                                <option value="West Virginia">West Virginia</option>
                                <option value="Wisconsin">Wisconsin</option>
                                <option value="Wyoming">Wyoming</option>
                              </select>
                              </div>
                            <!-- Year of Study -->
                            <div class="mb-3">
                              <label for="year-of-study-filter" class="form-label">Year of Study</label>
                              <select class="form-select" id="year-of-study-filter" name="year_of_study">
                                <option value="">All</option>
                                <option value="Freshman">Freshman</option>
                                <option value="Sophomore">Sophomore</option>
                                <option value="Junior">Junior</option>
                                <option value="Senior">Senior</option>
                                <option value="Graduate">Graduate</option>
                                <option value="Post Graduate">Post Graduate</option>
                              </select>
                            </div>

                            <!-- Major Type -->
                            <div class="mb-3">
                              <label for="major-type-select" class="form-label">Major Type</label>
                              <select class="form-select" id="major-type-filter" name="major_type">
                                <option value="">All</option>
                                <option value="Technical">Technical</option>
                                <option value="Non-Technical">Non-Technical</option>
                              </select>
                            </div>

                            <!-- Area of Study -->
                            <div class="mb-3">
                              <label for="major-select" class="form-label">Area of Study</label>
                              <select class="form-select" id="major-filter" name="major_category">
                                <option value="">All</option>
                                <option value="Engineering">Engineering</option>
                                <option value="Science">Science</option>
                                <option value="Business">Business</option>
                                <option value="Arts">Arts</option>
                                <option value="Other">Other</option>
                              </select>
                            </div>

                            <!-- My Industry -->
                            <div class="mb-3">
                              <label for="industry-input" class="form-label">My Industry</label>
                              <div class="multi-select-container" id="industry-multi-select">
                                <div class="tags-container" id="industry-tags-container">
                                  <input type="text" class="industry-input" id="industry-input" placeholder="Type or select industries">
                              </div>
                                <div class="industry-dropdown" id="industry-dropdown" style="display: none;"></div>
                            </div>
                              <input type="hidden" name="my_interests" id="industry-hidden-input" value="[]">
                              <small class="form-text text-muted">Type to search or add custom industries. Press Enter or comma to add.</small>
                            </div>

                            <!-- Technical Skills -->
                            <div class="mb-3">
                              <label for="technical-skills-input" class="form-label">Technical Skills</label>
                              <div class="multi-select-container" id="technical-skills-multi-select">
                                <div class="tags-container" id="technical-skills-tags-container">
                                  <input type="text" class="industry-input" id="technical-skills-input" placeholder="Type or select technical skills">
                                </div>
                                <div class="industry-dropdown" id="technical-skills-dropdown" style="display: none;"></div>
                              </div>
                              <input type="hidden" name="technical_skills" id="technical-skills-hidden-input" value="[]">
                              <small class="form-text text-muted">Type to search or add custom technical skills. Press Enter or comma to add.</small>
                            </div>

                            <!-- Soft Skills -->
                            <div class="mb-3">
                              <label for="soft-skills-input" class="form-label">Soft Skills</label>
                              <div class="multi-select-container" id="soft-skills-multi-select">
                                <div class="tags-container" id="soft-skills-tags-container">
                                  <input type="text" class="industry-input" id="soft-skills-input" placeholder="Type or select soft skills">
                                </div>
                                <div class="industry-dropdown" id="soft-skills-dropdown" style="display: none;"></div>
                              </div>
                              <input type="hidden" name="soft_skills" id="soft-skills-hidden-input" value="[]">
                              <small class="form-text text-muted">Type to search or add custom soft skills. Press Enter or comma to add.</small>
                            </div>

                          </form>
                        </div>
                        <div class="card-footer">
                          <button id="apply-filters-btn" class="btn btn-primary w-100">Apply Filters</button>
                          <button id="reset-filters-btn" class="btn btn-outline-secondary w-100 mt-2">Reset Filters</button>
                        </div>
                      </div>
                    </div>
                  </div>
                  
                  <!-- Profile Swipe Card Section -->
                  <div class="col-md-9">
                    <div class="row justify-content-center mb-4">
                      <!-- Single Profile Card Container -->
                      <div class="col-md-8 col-lg-8">
                        <div id="profile-container" class="profile-card-container">
                          <div class="swipe-controls">
                            <div class="swipe-control swipe-left" onclick="previousProfile()">
                              <i class="ti ti-chevron-left"></i>
                            </div>
                            <div class="swipe-control swipe-right" onclick="nextProfile()">
                              <i class="ti ti-chevron-right"></i>
                            </div>
                          </div>
                          <div id="current-profile" class="profile-card">
                            <!-- Profile content will be loaded here by JS -->
                            <div style="height: 100%; display: flex; align-items: center; justify-content: center; text-align: center; padding: 20px; background-color: white; border-radius: 15px;">
                              <div>
                                <h3>Loading profiles...</h3>
                                <p>Please wait while we find the best matches for you.</p>
                                <div class="spinner-border text-primary mt-3" role="status">
                                  <span class="visually-hidden">Loading...</span>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                    
                    <!-- All Users Grid View -->
                    <div class="mt-4">
                      <h4 class="mb-3">All Recommended Profiles</h4>
                      <div id="all-users-container" class="row">
                        <!-- User cards will be added here dynamically -->
                        <div class="col-12 text-center py-5">
                          <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                          </div>
                          <p class="mt-3">Loading user profiles...</p>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <!-- [ Main Content ] end -->
      </div>
    </div>
    <!-- [ Main Content ] end -->

    <footer class="pc-footer">
      <div class="footer-wrapper container-fluid">
        <div class="row">
          <div class="col my-1">
            <p class="m-0">©2025 Blaze Inc<a href="#" target="_blank"></a></p>
          </div>
        </div>
      </div>
    </footer>

    <!-- Customer Modal -->
    <div class="modal fade" id="customer-modal" data-bs-keyboard="false" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header border-0 pb-0">
                    <h5 class="mb-0">Profile Details</h5>
                    <a href="#" class="avtar avtar-s btn-link-danger btn-pc-default" data-bs-dismiss="modal">
                        <i class="ti ti-x f-20"></i>
                    </a>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-lg-4">
                            <div class="card">
                                <div class="card-body position-relative">
                                    <div class="position-absolute end-0 top-0 p-3">
                                    </div>
                                    <div class="text-center mt-3">
                                        <div class="chat-avtar d-inline-flex mx-auto">
                                            <img class="rounded-circle img-fluid wid-60" src="../assets/images/user/avatar-5.jpg"
                                                alt="User image">
                                        </div>
                                        <h5 class="mb-0">Anil Kumar</h5>
                                        <p class="text-muted text-sm">Graduate</p>
                                        <hr class="my-3 border border-secondary-subtle">
                                        <div class="row g-3">
                                            <div class="col-6">
                                                <h5 class="mb-0">45</h5>
                                                <small class="text-muted">Age</small>
                                            </div>
                                            <div class="col-6">
                                                <h5 class="mb-0">76</h5>
                                                <small class="text-muted">Connnections</small>
                                            </div>
                                        </div>
                                        <hr class="my-3 border border-secondary-subtle">
                                        <div class="d-inline-flex align-items-center justify-content-between w-100 mb-3">
                                            <i class="ti ti-map-pin"></i>
                                            <p class="mb-0">Pennsylvania</p>
                                        </div>
                                        <div class="d-inline-flex align-items-center justify-content-between w-100">
                                            <i class="ti ti-link"></i>
                                            <a href="#" class="link-primary">
                                                <p class="mb-0">https://website.dh.url</p>
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="card">
                                <div class="card-header d-inline-flex align-items-center justify-content-space-between">
                                    <h5 style="margin-left:15px ;">No of Co-Founders : 2</h5>
                                </div>
                            </div>
                            <div class="card">
                                <div class="card-header">
                                    <h5>Skills</h5>
                                </div>
                                <div class="card-body">
                                    <div class="row align-items-center mb-3">
                                        <p class="mb-1 text-muted">Hard Skills</p>
                                        <div class="col-sm-12 mb-2 mb-sm-0">
                                            <p class="mb-0">Python, Java, JavaScript, C++, AWS, Azure, Google
                                                Cloud Platform</p>
                                        </div>
                                    </div>
                                    <div class="row align-items-center mb-3">
                                        <p class="mb-1 text-muted">Soft Skills</p>
                                        <div class="col-sm-12 mb-2 mb-sm-0">
                                            <p class="mb-0">Python, Java, JavaScript, C++, AWS, Azure, Google
                                                Cloud Platform</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-8">
                            <div class="card">
                                <div class="card-header">
                                    <h5>Personal Details</h5>
                                </div>
                                <div class="card-body">
                                    <ul class="list-group list-group-flush">
                                        <li class="list-group-item px-0 pt-0">
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <p class="mb-1 text-muted">Full Name</p>
                                                    <h6 class="mb-0">Anil Kumar</h6>
                                                </div>
                                                <div class="col-md-6">
                                                    <p class="mb-1 text-muted">State</p>
                                                    <h6 class="mb-0">Missourie</h6>
                                                </div>
                                            </div>
                                        </li>
                                        <li class="list-group-item px-0">
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <p class="mb-1 text-muted">City</p>
                                                    <h6 class="mb-0">Chesterfeild</h6>
                                                </div>
                                                <div class="col-md-6">
                                                    <p class="mb-1 text-muted">Zip Code</p>
                                                    <h6 class="mb-0">63019</h6>
                                                </div>
                                            </div>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                            <div class="card">
                                <div class="card-header">
                                    <h5>About me</h5>
                                </div>
                                <div class="card-body">
                                    <p class="mb-0">Hello, I'm Aaron Poole Manufacturing Director based in international company, Void
                                        jiidki me na fep juih ced gihhiwi launke cu mig tujum peodpo.</p>
                                </div>
                            </div>
                            <div class="card">
                                <div class="card-header">
                                    <h5>Education</h5>
                                </div>
                                <div class="card-body">
                                    <ul class="list-group list-group-flush">
                                        <li class="list-group-item px-0 pt-0">
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <p class="mb-1 text-muted">Year of Study</p>
                                                    <p class="mb-0">Graduate</p>
                                                </div>
                                                <div class="col-md-6">
                                                    <p class="mb-1 text-muted">Institute</p>
                                                    <p class="mb-0">Imperial College London</p>
                                                </div>
                                            </div>
                                        </li>
                                        <li class="list-group-item px-0 pb-0">
                                            <div class="row">
                                                <div class="col-md-6">
                                                                                                    <p class="mb-1 text-muted">Area of Study</p>
                                                    <p class="mb-0">Engineering</p>
                                                </div>
                                                <div class="col-md-6">
                                                <p class="mb-1 text-muted">Major</p>
                                                    <p class="mb-0">Software</p>
                                                </div>
                                            </div>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                            <div class="card">
                                <div class="card-header">
                                    <h5>Interest/industry</h5>
                                </div>
                                <div class="card-body">
                                    <ul class="list-group list-group-flush">
                                        <li class="list-group-item px-0 pt-0">
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <p class="mb-1 text-muted">My Intrests</p>
                                                    <p class="mb-0">Marketing, Agriculture Tech, AI, AR/VR, Art,
                                                        Cosmetics, BioTech, Cannabis, Communications, Clean Tech
                                                    </p>
                                                </div>
                                                <div class="col-md-6">
                                                    <p class="mb-1 text-muted">Looking for specific interest</p>
                                                    <p class="mb-0">Cosmetics, BioTech, </p>
                                                </div>
                                            </div>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Include theme settings -->
    <div id="theme-settings-container"></div>

    <!-- Theme Customizer -->
    <div class="pct-c-btn">
        <a href="#" data-bs-toggle="offcanvas" data-bs-target="#offcanvas_pc_layout">
            <svg class="pc-icon">
                <use xlink:href="#custom-setting-2"></use>
            </svg>
        </a>
    </div>
    <div class="offcanvas border-0 pct-offcanvas offcanvas-end" tabindex="-1" id="offcanvas_pc_layout">
        <div class="offcanvas-header">
            <h5 class="offcanvas-title">Settings</h5>
            <button type="button" class="btn btn-icon btn-link-danger" data-bs-dismiss="offcanvas" aria-label="Close">
                <i class="ti ti-x"></i>
            </button>
        </div>
        <div class="pct-body" style="height: calc(100% - 85px)">
            <div class="offcanvas-body py-0">
                <ul class="list-group list-group-flush">
                    <li class="list-group-item">
                        <div class="pc-dark">
                            <h6 class="mb-1">Theme Mode</h6>
                            <p class="text-muted text-sm">Choose light or dark mode or Auto</p>
                            <div class="row theme-layout">
                                <div class="col-4">
                                    <div class="d-grid">
                                        <button class="preset-btn btn active" data-value="true" onclick="layout_change('light');">
                                            <svg class="pc-icon text-warning">
                                                <use xlink:href="#custom-sun-1"></use>
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="d-grid">
                                        <button class="preset-btn btn" data-value="false" onclick="layout_change('dark');">
                                            <svg class="pc-icon">
                                                <use xlink:href="#custom-moon"></use>
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="d-grid">
                                        <button class="preset-btn btn" data-value="default" onclick="layout_change_default();">
                                            <svg class="pc-icon">
                                                <use xlink:href="#custom-setting-2"></use>
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </li>
                    <li class="list-group-item">
                        <h6 class="mb-1">Theme Contrast</h6>
                        <p class="text-muted text-sm">Choose theme contrast</p>
                        <div class="row theme-contrast">
                            <div class="col-6">
                                <div class="d-grid">
                                    <button class="preset-btn btn" data-value="true" onclick="layout_sidebar_change('true');">
                                        <svg class="pc-icon">
                                            <use xlink:href="#custom-mask"></use>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="d-grid">
                                    <button class="preset-btn btn active" data-value="false" onclick="layout_sidebar_change('false');">
                                        <svg class="pc-icon">
                                            <use xlink:href="#custom-mask-1-outline"></use>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </li>
                    <li class="list-group-item">
                        <h6 class="mb-1">Custom Theme</h6>
                        <p class="text-muted text-sm">Choose your Primary color</p>
                        <div class="theme-color preset-color">
                            <a href="#!" data-value="preset-1"><i class="ti ti-check"></i></a>
                            <a href="#!" data-value="preset-2"><i class="ti ti-check"></i></a>
                            <a href="#!" data-value="preset-3"><i class="ti-check"></i></a>
                            <a href="#!" data-value="preset-4"><i class="ti ti-check"></i></a>
                            <a href="#!" class="active" data-value="preset-5"><i class="ti ti-check"></i></a>
                            <a href="#!" data-value="preset-6"><i class="ti ti-check"></i></a>
                            <a href="#!" data-value="preset-7"><i class="ti ti-check"></i></a>
                            <a href="#!" data-value="preset-8"><i class="ti ti-check"></i></a>
                            <a href="#!" data-value="preset-9"><i class="ti ti-check"></i></a>
                            <a href="#!" data-value="preset-10"><i class="ti ti-check"></i></a>
                        </div>
                    </li>
                    <li class="list-group-item">
                        <h6 class="mb-1">Sidebar Caption</h6>
                        <p class="text-muted text-sm">Sidebar Caption Hide/Show</p>
                        <div class="row theme-nav-caption">
                            <div class="col-6">
                                <div class="d-grid">
                                    <button class="preset-btn btn active" data-value="true" onclick="layout_caption_change('true');">
                                        <img src="../assets/images/customizer/img-caption-1.svg" alt="img" class="img-fluid" width="70%" />
                                    </button>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="d-grid">
                                    <button class="preset-btn btn" data-value="false" onclick="layout_caption_change('false');">
                                        <img src="../assets/images/customizer/img-caption-2.svg" alt="img" class="img-fluid" width="70%" />
                                    </button>
                                </div>
                            </div>
                        </div>
                    </li>
                    <li class="list-group-item">
                        <div class="pc-rtl">
                            <h6 class="mb-1">Theme Layout</h6>
                            <p class="text-muted text-sm">LTR/RTL</p>
                            <div class="row theme-direction">
                                <div class="col-6">
                                    <div class="d-grid">
                                        <button class="preset-btn btn active" data-value="false" onclick="layout_rtl_change('false');">
                                            <img src="../assets/images/customizer/img-layout-1.svg" alt="img" class="img-fluid" width="70%" />
                                        </button>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="d-grid">
                                        <button class="preset-btn btn" data-value="true" onclick="layout_rtl_change('true');">
                                            <img src="../assets/images/customizer/img-layout-2.svg" alt="img" class="img-fluid" width="70%" />
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </li>
                    <li class="list-group-item">
                        <div class="pc-container-width">
                            <h6 class="mb-1">Layout Width</h6>
                            <p class="text-muted text-sm">Choose Full or Container Layout</p>
                            <div class="row theme-container">
                                <div class="col-6">
                                    <div class="d-grid">
                                        <button class="preset-btn btn active" data-value="false" onclick="change_box_container('false')">
                                            <img src="../assets/images/customizer/img-container-1.svg" alt="img" class="img-fluid" width="70%" />
                                        </button>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="d-grid">
                                        <button class="preset-btn btn" data-value="true" onclick="change_box_container('true')">
                                            <img src="../assets/images/customizer/img-container-2.svg" alt="img" class="img-fluid" width="70%" />
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </li>
                    <li class="list-group-item">
                        <div class="d-grid">
                            <button class="btn btn-light-danger" id="layoutreset">Reset Layout</button>
                        </div>
                    </li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Filter Modal for Mobile -->
    <div class="modal fade" id="filterModal" tabindex="-1" aria-labelledby="filterModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="filterModalLabel">Filter Options</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <ul class="list-group list-group-flush">
              <li class="list-group-item px-0 py-2">
                <a class="btn border-0 px-0 text-start w-100" data-bs-toggle="collapse" href="#mobileFiltercollapse1">
                  <div class="float-end"><i class="ti ti-chevron-down"></i></div>
                  Institute
                </a>
                <div class="collapse show" id="mobileFiltercollapse1">
                  <div class="py-3">
                    <input class="form-control" type="text" placeholder="Enter something">
                  </div>
                </div>
              </li>
              <li class="list-group-item px-0 py-2">
                <a class="btn border-0 px-0 text-start w-100" data-bs-toggle="collapse" href="#mobileFiltercollapse2">
                  <div class="float-end"><i class="ti ti-chevron-down"></i></div>
                  Gender
                </a>
                <div class="collapse show" id="mobileFiltercollapse2">
                  <div class="py-3">
                    <div class="form-check my-2">
                      <input class="form-check-input" type="checkbox" id="mobileCategoryfilter1" value="option1" />
                      <label class="form-check-label" for="mobileCategoryfilter1">All</label>
                    </div>
                    <div class="form-check my-2">
                      <input class="form-check-input" type="checkbox" id="mobileCategoryfilter2" value="option2" />
                      <label class="form-check-label" for="mobileCategoryfilter2">Male</label>
                    </div>
                    <div class="form-check my-2">
                      <input class="form-check-input" type="checkbox" id="mobileCategoryfilter3" value="option3" />
                      <label class="form-check-label" for="mobileCategoryfilter3">Female</label>
                    </div>
                  </div>
                </div>
              </li>
              <li class="list-group-item px-0 py-2">
                <a class="btn border-0 px-0 text-start w-100" data-bs-toggle="collapse" href="#mobileFiltercollapse3">
                  <div class="float-end"><i class="ti ti-chevron-down"></i></div>
                  Industry
                </a>
                <div class="collapse show" id="mobileFiltercollapse3">
                  <input class="form-control" type="text" placeholder="Enter something">
                </div>
              </li>
              <li class="list-group-item px-0 py-2">
                <a class="btn border-0 px-0 text-start w-100" data-bs-toggle="collapse" href="#mobileFiltercollapse4">
                  <div class="float-end"><i class="ti ti-chevron-down"></i></div>
                  Skills
                </a>
                <div class="collapse show" id="mobileFiltercollapse4">
                  <input class="form-control" type="text" placeholder="Enter something">
                </div>
              </li>
            </ul>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-light" data-bs-dismiss="modal">Close</button>
            <button type="button" class="btn btn-primary">Apply Filters</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Required Js -->
    <script src="../assets/js/plugins/popper.min.js"></script>
    <script src="../assets/js/plugins/simplebar.min.js"></script>
    <script src="../assets/js/plugins/bootstrap.min.js"></script>
    <script src="../assets/js/fonts/custom-font.js"></script>
    <script src="../assets/js/config.js"></script>
    <script src="../assets/js/pcoded.js"></script>
    <script src="../assets/js/plugins/feather.min.js"></script>

    <!-- Auth JS -->
    <script src="../js/auth.js"></script>
    
    <!-- Sidebar dropdown fix -->
    <script src="../js/sidebar-fix.js"></script>

    <!-- Load components -->
    <script src="components/layout.js"></script>
    

    
    <!-- Connection Management -->
    <script src="../assets/js/follow-button.js"></script>

    <!-- Add Profile Swipe Styles -->
    <style>
      .profile-card-container {
        perspective: 1000px;
        width: 100%;
        max-width: 350px;
        height: 450px;
        margin: 0 auto;
        position: relative;
      }

      .profile-card {
        width: 100%;
        height: 100%;
        position: relative;
        transform-style: preserve-3d;
        transition: transform 0.6s, opacity 0.6s;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        cursor: pointer;
        overflow: hidden;
      }

      .profile-card:hover .profile-details {
        opacity: 1;
      }
      
      /* View profile button styles */
      .view-profile-btn {
        position: absolute;
        top: 15px;
        right: 15px;
        background-color: rgba(255, 255, 255, 0.8);
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        z-index: 10;
        opacity: 0.7; /* Make it slightly visible by default */
        transition: opacity 0.3s ease, transform 0.3s ease;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      }
      
      .profile-card:hover .view-profile-btn {
        opacity: 1;
        transform: scale(1.1);
      }
      
      .view-profile-btn i {
        color: var(--bs-primary);
        font-size: 1.2rem;
      }

      /* Add a pulse animation to make the eye button more noticeable */
      @keyframes pulse {
        0% {
          box-shadow: 0 0 0 0 rgba(var(--bs-primary-rgb), 0.7);
        }
        70% {
          box-shadow: 0 0 0 10px rgba(var(--bs-primary-rgb), 0);
        }
        100% {
          box-shadow: 0 0 0 0 rgba(var(--bs-primary-rgb), 0);
        }
      }

      .profile-card:hover .view-profile-btn {
        animation: pulse 1.5s infinite;
      }

      .profile-image {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: 15px;
        position: absolute;
        top: 0;
        left: 0;
      }

      .profile-details {
        position: absolute;
        bottom: 0;
        left: 0;
        width: 100%;
        padding: 20px;
        background: linear-gradient(to top, rgba(0, 0, 0, 0.8), transparent);
        color: white;
        opacity: 0;
        transition: opacity 0.3s ease;
        border-bottom-left-radius: 15px;
        border-bottom-right-radius: 15px;
      }

      .profile-name {
        font-size: 24px;
        font-weight: bold;
        margin-bottom: 5px;
      }

      .profile-title {
        font-size: 16px;
        margin-bottom: 10px;
      }

      .profile-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 5px;
        margin-bottom: 15px;
      }

      .profile-tag {
        background-color: rgba(255, 255, 255, 0.2);
        padding: 3px 10px;
        border-radius: 20px;
        font-size: 12px;
      }

      .profile-location {
        display: flex;
        align-items: center;
        font-size: 14px;
        margin-bottom: 15px;
      }

      .profile-location i {
        margin-right: 5px;
      }

      .profile-actions {
        display: flex;
        justify-content: space-between;
        margin-top: 15px;
      }

      .action-btn {
        width: 48%;
        padding: 8px 0;
        border: none;
        border-radius: 30px;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .reject-btn {
        background-color: #ff4757;
        color: white;
      }

      .accept-btn {
        background-color: #2ed573;
        color: white;
      }

      .action-btn:hover {
        transform: translateY(-3px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
      }

      .swipe-controls {
        display: flex;
        justify-content: space-between;
        width: 100%;
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        z-index: 10;
        pointer-events: none;
      }

      .swipe-control {
        width: 40px;
        height: 40px;
        background-color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
        pointer-events: auto;
      }

      .swipe-left {
        margin-left: -20px;
      }

      .swipe-right {
        margin-right: -20px;
      }

      /* Debug connection button styles */
      .debug-connection-btn {
        position: absolute;
        top: 15px;
        left: 15px;
        background-color: rgba(255, 255, 255, 0.8);
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        z-index: 10;
        opacity: 0.5; /* Make it slightly visible by default */
        transition: opacity 0.3s ease, transform 0.3s ease;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      }

      .profile-card:hover .debug-connection-btn {
        opacity: 0.8;
      }

      .debug-connection-btn:hover {
        opacity: 1 !important;
        transform: scale(1.1);
        background-color: rgba(255, 230, 230, 0.9);
      }

      .debug-connection-btn i {
        color: #dc3545;
        font-size: 1.2rem;
      }
    </style>

    <!-- Additional CSS for filter sidebar -->
    <style>
      /* Filter sidebar transition */
      #filterSidebar {
        transition: all 0.3s ease;
      }
      
      /* Scrollable filter body */
      .filter-body {
        max-height: calc(100vh - 200px);
        overflow-y: auto;
        scrollbar-width: thin;
      }
      
      .filter-body::-webkit-scrollbar {
        width: 5px;
      }
      
      .filter-body::-webkit-scrollbar-thumb {
        background-color: rgba(0, 0, 0, 0.2);
        border-radius: 10px;
      }
      
      .filter-card {
        max-height: 90vh;
        display: flex;
        flex-direction: column;
      }
      
      /* Overlay for mobile filter */
      .filter-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 1020;
        opacity: 0;
        transition: opacity 0.3s ease;
      }
      
      .filter-overlay.active {
        display: block;
        opacity: 1;
      }
      
      /* Improvement for mobile layouts */
      @media (max-width: 767.98px) {
        #filterSidebar {
          position: fixed;
          top: 0;
          left: 0;
          z-index: 1030;
          width: 85%;
          max-width: 300px;
          height: 100vh !important;
          overflow-y: hidden !important;
          box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
          transform: translateX(-100%) !important;
          margin: 0 !important;
          transition: transform 0.3s ease !important;
        }
        
        #filterSidebar.show {
          transform: translateX(0) !important;
        }
        
        #filterSidebar .card {
          height: 100% !important;
          border-radius: 0 !important;
          border: none !important;
        }
        
        .filter-body {
          max-height: calc(100vh - 130px) !important;
        }
        
        .profile-card-container {
          margin-top: 20px !important;
        }
      }
      
      /* Hamburger button styling */
      #filterToggleBtn {
        display: flex;
        align-items: center;
        gap: 8px;
        transition: all 0.2s ease;
      }
      
      #filterToggleBtn:hover {
        background-color: var(--bs-primary);
        color: white;
      }
      
      /* Improved card layout */
      .profile-card-container {
        margin: 0 auto;
      }
      
      /* Prevent content jumps during filter toggle */
      .coming-soon-content .row {
        position: relative;
        min-height: 500px;
      }
    </style>

    <!-- CSS for User Cards -->
    <style>
      /* User card styles */
      .user-card {
        transition: all 0.3s ease;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }
      
      .user-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
      }
      
      .user-card-image {
        height: 200px;
        object-fit: cover;
        object-position: center;
      }
      
      .user-card .badge {
        font-size: 12px;
        padding: 5px 10px;
        margin-right: 5px;
        margin-bottom: 5px;
        border-radius: 50px;
      }
      
      .user-card .card-footer {
        padding: 10px 15px;
        border-top: 1px solid rgba(0, 0, 0, 0.05);
      }
      
      .user-card .btn-outline-danger:hover {
        background-color: #ff4757;
        color: white;
      }
      
      /* Ensure all users container is scrollable on small screens */
      @media (max-width: 767.98px) {
        #all-users-container {
          margin-top: 30px;
        }
      }
      
      /* Improve filter container on mobile */
      @media (max-width: 767.98px) {
        #filterSidebar .filter-card {
          border-radius: 0;
          border: none;
        }
      }
    </style>

    <script>
      // Load required components before initializing profile system
      document.addEventListener('DOMContentLoaded', function() {
        // Initialize the profile system
        initProfileSystem();
        
        // Fix mobile filter issues
        fixMobileFilter();

        // Setup filter toggle
        setupFilterToggle();
      });
        
      // Load sidebar
      fetch('components/sidebar.html')
        .then(response => response.text())
        .then(data => {
          document.getElementById('sidebar-container').innerHTML = data;
          // Initialize feather icons after loading sidebar
          feather.replace();
        });
      
      // Load header
      fetch('components/header.html')
        .then(response => response.text())
        .then(data => {
          document.getElementById('header-container').innerHTML = data;
          // Initialize feather icons after loading header
          feather.replace();
        });
      
      // Load theme settings
      fetch('components/theme-settings.html')
        .then(response => response.text())
        .then(data => {
          document.getElementById('theme-settings-container').innerHTML = data;
          // Initialize feather icons after loading theme settings
          feather.replace();
        })
        .then(() => {
          // After all components are loaded, update user profile
          updateUserProfile();
      });

      // Helper function to get cookies
      function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
        return null;
      }
      
      // Demo profiles for fallback
      const demoProfiles = [
        {
          id: 1,
          name: "Vinay Patel",
          title: "Maritime Technology",
          tags: ["Product Design", "UI/UX", "Marketing"],
          location: "Pennsylvania University • Pennsylvania, USA",
          image: "https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=774&q=80"
        },
        {
          id: 2,
          name: "Sarah Johnson",
          title: "Software Engineer",
          tags: ["Full Stack", "AI/ML", "Cloud"],
          location: "Stanford University • California, USA",
          image: "https://images.unsplash.com/photo-1573496359142-b8d87734a5a2?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=776&q=80"
        },
        {
          id: 3,
          name: "Michael Chen",
          title: "Business Development",
          tags: ["Finance", "Strategy", "Sales"],
          location: "Harvard Business School • Massachusetts, USA",
          image: "https://images.unsplash.com/photo-1560250097-0b93528c311a?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=774&q=80"
        },
        {
          id: 4,
          name: "Emma Rodriguez",
          title: "Product Manager",
          tags: ["Product Strategy", "Growth", "UX Research"],
          location: "MIT • Massachusetts, USA",
          image: "https://images.unsplash.com/photo-1494790108377-be9c29b29330?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=774&q=80"
        },
        {
          id: 5,
          name: "David Kim",
          title: "Blockchain Developer",
          tags: ["Smart Contracts", "DeFi", "Web3"],
          location: "UC Berkeley • California, USA",
          image: "https://images.unsplash.com/photo-1500648767791-00dcc994a43e?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=774&q=80"
        },
        {
          id: 6,
          name: "Olivia Wilson",
          title: "Marketing Specialist",
          tags: ["Digital Marketing", "Content Strategy", "SEO"],
          location: "Columbia University • New York, USA",
          image: "https://images.unsplash.com/photo-1534528741775-53994a69daeb?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=776&q=80"
        }
      ];

      // Function to use demo profiles if API fails
      function useDemoProfiles() {
        
        // Set global profiles to demo profiles
        window.profiles = demoProfiles;
        // Render the demo profiles
        renderAllUsersList();
        loadProfile(currentProfileIndex);
      }

      // Helper function to clean ID values (handle quotes from JSON.stringify)
      function cleanIdValue(id) {
        
        
        if (id === null || id === undefined) {
          console.warn('cleanIdValue received null/undefined ID');
          return '';
        }
        
        // If it's an object with _id property, use that
        if (typeof id === 'object' && id !== null) {
          if (id._id) {
            
            return String(id._id).replace(/^["']|["']$/g, '');
          } else if (id.id) {
            
            return String(id.id).replace(/^["']|["']$/g, '');
          }
        }
        
        if (typeof id === 'string') {
          // Remove any quotes that might be present from JSON.stringify
          const cleaned = id.replace(/^["']|["']$/g, '');
          
          return cleaned;
        }
        
        // Convert to string if not already
        console.log('cleanIdValue converted to string:', id, '→', String(id));
        return String(id);
      }

      // Define the image URL processing function globally so it can be used by other functions
      function processImageUrl(imagePath, userId) {
        // Clean user ID for consistent handling
        const cleanUserId = cleanIdValue(userId);
        
        // Default image if nothing is provided
        if (!imagePath) {
          
          return '/assets/images/user/blank-avatar.png';
        }
        
        // Clean up the path
        let cleanPath = imagePath.trim();
        
        
        // If it's already a full URL
        if (cleanPath.startsWith('http://') || cleanPath.startsWith('https://')) {
          
          return cleanPath;
        }
        
        // If it's the default blank avatar
        if (cleanPath.includes('blank-avatar.png')) {
          
          return '/assets/images/user/blank-avatar.png';
        }
        
        // Extract filename from path
        const getFilename = (path) => {
          let parts = path.split('/').filter(p => p); // Remove empty parts
          if (parts.length === 0) {
            parts = path.split('\\').filter(p => p); // Try with backslash
          }
          return parts[parts.length - 1];
        };
        
        // Get just the filename
        const filename = getFilename(cleanPath);
        
        
        // Handle Windows-style backslashes
        if (cleanPath.includes('\\')) {
          cleanPath = cleanPath.replace(/\\/g, '/');
        }
        
        // FIX DUPLICATE PATH: Remove any instances of "uploads/profile_pics/" 
        // to prevent duplicate paths like "uploads/profile_pics/{userId}/uploads/profile_pics/{filename}"
        if (cleanPath.includes('uploads/profile_pics/') || cleanPath.includes('/uploads/profile_pics/')) {
          // Extract just the filename
          const finalPath = `/uploads/profile_pics/${cleanUserId}/${filename}`;
          
          return finalPath;
        }
        
        // Handle case where path is just "profile_pics/{userId}/{filename}"
        if (cleanPath.startsWith('profile_pics/') && cleanPath.includes(cleanUserId)) {
          const finalPath = `/uploads/${cleanPath}`;
          
          return finalPath;
        }
        
        // Handle case where path is just "profile_pics/{filename}"
        if (cleanPath.startsWith('profile_pics/')) {
          // Extract the filename
          const finalPath = `/uploads/profile_pics/${cleanUserId}/${filename}`;
          
          return finalPath;
        }
        
        // If the path is just the filename
        if (filename === cleanPath || 
            cleanPath.endsWith(filename)) {
          const finalPath = `/uploads/profile_pics/${cleanUserId}/${filename}`;
          
          return finalPath;
        }
        
        // Default case - if none of the above rules applied
        const finalPath = `/uploads/profile_pics/${cleanUserId}/${filename}`;
        
        return finalPath;
      }

      // Function to fetch users from MongoDB and display them
      async function fetchUsersFromDB() {
        try {
          
          
          // Get auth tokens
          const token = localStorage.getItem('token') || sessionStorage.getItem('token') || getCookie('token');
          const sessionId = localStorage.getItem('sessionId') || sessionStorage.getItem('sessionId');
          
          // Get current user data first (we need full profile for matching)
          let currentUser;
          try {
            const meResponse = await fetch('/api/auth/me', {
                headers: {
                  'Authorization': `Bearer ${token}`,
                  'X-Session-ID': sessionId || ''
                }
              });
              
            if (meResponse.ok) {
              currentUser = await meResponse.json();
              console.log("Current user data:", {
                id: currentUser._id,
                name: currentUser.full_name || currentUser.username,
                myInterests: currentUser.my_interests || [],
                lookingFor: currentUser.interests_looking_in_others || []
              });
            } else {
              console.warn("Failed to get current user, will show all profiles");
              showLoginRequiredMessage();
              return;
            }
          } catch (error) {
            console.warn("Error getting current user:", error);
            showLoginRequiredMessage();
            return;
          }
          
          // Validate current user has interests set
          if (!Array.isArray(currentUser.my_interests) || !Array.isArray(currentUser.interests_looking_in_others)) {
            showCompleteProfileMessage();
            return;
          }

          // Show loading state
          const usersContainer = document.getElementById('all-users-container');
          if (usersContainer) {
            usersContainer.innerHTML = `
              <div class="col-12 text-center py-5">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-3">Finding your best matches...</p>
              </div>
            `;
          }
          
          // Fetch all users
          const response = await fetch('/api/users', {
            method: 'GET',
            headers: {
              'Content-Type': 'application/json',
              'Accept': 'application/json',
              'Authorization': token ? `Bearer ${token}` : '',
              'X-Session-ID': sessionId || ''
            }
          });
          
          if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
          }
          
          const users = await response.json();
          
          
          if (!users || users.length === 0) {
            showNoUsersMessage();
            return;
          }
          
          // Fetch all connections to check status
          
          const connectionsToFilter = [];
          
          try {
            // 1. Get accepted connections
            const connectionsResponse = await fetch('/api/connections', {
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`,
                'X-Session-ID': sessionId
              }
            });
            
            if (connectionsResponse.ok) {
              const connections = await connectionsResponse.json();
              
              
              // Add connected user IDs to filter list
              connections.forEach(conn => {
                if (conn.user && conn.user._id) {
                  connectionsToFilter.push(conn.user._id);
                }
              });
            }
            
            // 2. Get pending requests received
            const pendingResponse = await fetch('/api/connections/pending', {
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`,
                'X-Session-ID': sessionId
              }
            });
            
            if (pendingResponse.ok) {
              const pendingRequests = await pendingResponse.json();
              
              
              // Add users who sent pending requests to filter list
              pendingRequests.forEach(req => {
                if (req.sender && req.sender._id) {
                  connectionsToFilter.push(req.sender._id);
                }
              });
            }
            
            // 3. Get pending requests sent
            const sentResponse = await fetch('/api/connections/sent', {
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`,
                'X-Session-ID': sessionId
              }
            });
            
            if (sentResponse.ok) {
              const sentRequests = await sentResponse.json();
              
              
              // Add users who received pending requests to filter list
              sentRequests.forEach(req => {
                if (req.receiver && req.receiver._id) {
                  connectionsToFilter.push(req.receiver._id);
                }
              });
            }
            
            
            
            
          } catch (error) {
            console.error("Error fetching connection data:", error);
            // Continue with all users if connection data can't be fetched
          }
          
          // Filter and match users
          let matchedUsers = users
            // Exclude current user
            .filter(user => user._id !== currentUser._id)
            // Exclude users with existing connections or pending requests
            .filter(user => {
              const userId = user._id;
              const isFiltered = connectionsToFilter.includes(userId);
              
              // Log details about filtered users for debugging
              if (isFiltered) {
                console.log(`Filtering out user ${user.full_name || user.username} (${userId}) - already has connection/request`);
              }
              
              return !isFiltered;
            })
            .map(user => {
              // Calculate match score and matching interests
              const matchData = calculateMatchScore(currentUser, user);
              return {
                ...user,
                matchScore: matchData.score,
                matchingMyInterests: matchData.matchingMyInterests,
                matchingTheirInterests: matchData.matchingTheirInterests
              };
            })
            .filter(user => {
              const hasAnyMatch = user.matchScore > 0;
              if (!hasAnyMatch) {
                console.log(`Filtering out user ${user.full_name || user.username} (${user._id}) - no matching interests`);
              }
              return hasAnyMatch;
            }) // Only keep users with some match
            .sort((a, b) => b.matchScore - a.matchScore); // Sort by match score descending

          
          
          if (matchedUsers.length === 0) {
            showNoMatchesMessage();
            return;
          }

          // Map matched users to profile format
          const processedProfiles = matchedUsers.map(user => ({
            id: user._id,
            name: user.full_name || user.username || 'Anonymous User',
            title: user.major_category?.value || 'No Area of Study Listed',
            tags: Array.isArray(user.technical_skills) && user.technical_skills.length > 0 
                  ? user.technical_skills.slice(0, 3) 
                  : Array.isArray(user.my_interests) && user.my_interests.length > 0
                  ? user.my_interests.slice(0, 3)
                  : ['No skills listed'],
            location: user.city?.value && user.state?.value 
                     ? `${user.city.value}, ${user.state.value}`
                     : user.institution?.value || 'Location not specified',
            image: processImageUrl(user.profile_picture || '', user._id),
            gender: user.gender, // Keep the complete gender object
            institution: user.institution, // Keep the complete institution object
            institute: user.institute, // Include alternate field name for compatibility
            city: user.city, // Include these location fields
            state: user.state, // for more detailed filtering
            major_category: user.major_category, // Keep major related fields
            major_sub_category: user.major_sub_category,
            major_type: user.major_type || null, // Include major type (may be undefined)
            year_of_study: user.year_of_study,
            // CRITICAL FIX: Include the original my_interests array
            my_interests: user.my_interests, // This is needed for interest filtering
            matchScore: user.matchScore,
            matchingMyInterests: user.matchingMyInterests,
            matchingTheirInterests: user.matchingTheirInterests,
            technical_skills: user.technical_skills || [],
            soft_skills: user.soft_skills || [],  // Add this line to include soft skills
          }));
          
          // Set the global profiles array
          window.profiles = processedProfiles;
          
          
          // Initialize display
          if (profiles && profiles.length > 0) {
            window.currentProfileIndex = 0;
            loadProfile(currentProfileIndex);
            renderAllUsersList();
          } else {
            showNoMatchesMessage();
          }
        } catch (error) {
          console.error("Error fetching users:", error);
          useDemoProfiles();
        }
      }

      // Calculate match score between current user and potential match
      function calculateMatchScore(currentUser, otherUser) {
        // Ensure both users have the required arrays
        const myInterests = Array.isArray(currentUser.my_interests) ? currentUser.my_interests : [];
        const myLookingFor = Array.isArray(currentUser.interests_looking_in_others) ? currentUser.interests_looking_in_others : [];
        const theirInterests = Array.isArray(otherUser.my_interests) ? otherUser.my_interests : [];
        const theirLookingFor = Array.isArray(otherUser.interests_looking_in_others) ? otherUser.interests_looking_in_others : [];

        // Find matching interests in both directions
        const matchingMyInterests = myInterests.filter(interest => 
          theirLookingFor.some(their => their.toLowerCase() === interest.toLowerCase())
        );

        const matchingTheirInterests = theirInterests.filter(interest =>
          myLookingFor.some(my => my.toLowerCase() === interest.toLowerCase())
        );

        // Calculate score based on matches
        // Get the total possible matches (minimum of array lengths to ensure score <= 100%)
        const maxPossibleMyMatches = Math.min(myInterests.length, theirLookingFor.length);
        const maxPossibleTheirMatches = Math.min(theirInterests.length, myLookingFor.length);
        
        // Calculate percentage for each direction
        const myMatchPercentage = maxPossibleMyMatches > 0 ? 
          (matchingMyInterests.length / maxPossibleMyMatches) : 0;
        const theirMatchPercentage = maxPossibleTheirMatches > 0 ? 
          (matchingTheirInterests.length / maxPossibleTheirMatches) : 0;
        
        // Final score is average of both percentages
        const score = (myMatchPercentage + theirMatchPercentage) / 2;

        return {
          score,
          matchingMyInterests,
          matchingTheirInterests
        };
            }
            
      // Function to show message when profile needs to be completed
      function showCompleteProfileMessage() {
        const profileCard = document.getElementById('current-profile');
        const usersContainer = document.getElementById('all-users-container');
        
        if (profileCard) {
          profileCard.innerHTML = `
            <div style="height: 100%; display: flex; align-items: center; justify-content: center; text-align: center; padding: 20px; background-color: white; border-radius: 15px;">
              <div>
                <h3>Complete Your Profile</h3>
                <p>Please set your interests and what you're looking for to see matches.</p>
                <a href="/profile.html" class="btn btn-primary mt-3">Update Profile</a>
              </div>
            </div>
          `;
        }
        
        if (usersContainer) {
          usersContainer.innerHTML = `
            <div class="col-12 text-center py-5">
              <div class="alert alert-warning" role="alert">
                <h4 class="alert-heading">Profile Incomplete</h4>
                <p>To see matching profiles, please complete your interests in your profile.</p>
                <hr>
                <a href="/profile.html" class="btn btn-warning">Complete Profile</a>
              </div>
            </div>
          `;
        }
      }

      // Function to show no matches message
      function showNoMatchesMessage() {
        const profileCard = document.getElementById('current-profile');
        const usersContainer = document.getElementById('all-users-container');
        
        if (profileCard) {
          profileCard.innerHTML = `
            <div style="height: 100%; display: flex; align-items: center; justify-content: center; text-align: center; padding: 20px; background-color: white; border-radius: 15px;">
              <div>
                <h3>No Matches Found</h3>
                <p>We couldn't find any users matching your interests right now. Try updating your interests or check back later!</p>
                <a href="/profile.html" class="btn btn-primary mt-3">Update Interests</a>
              </div>
            </div>
          `;
        }
        
        if (usersContainer) {
          usersContainer.innerHTML = `
            <div class="col-12 text-center py-5">
              <div class="alert alert-info" role="alert">
                <h4 class="alert-heading">No Matches Found</h4>
                <p>We couldn't find any users that match your interests at the moment.</p>
                <hr>
                <p class="mb-0">Try broadening your interests or check back later for new matches!</p>
              </div>
            </div>
          `;
        }
      }

      // Helper function to get current user ID
      async function getCurrentUserId() {
        // Try to get from storage first
        let userId = localStorage.getItem('userId') || sessionStorage.getItem('userId');
            
        // If not in storage, try to get from API
        if (!userId) {
          try {
            const token = localStorage.getItem('token') || sessionStorage.getItem('token') || getCookie('token');
            const sessionId = localStorage.getItem('sessionId') || sessionStorage.getItem('sessionId');
            
            if (!token) {
              console.warn("No auth token found");
              return null;
            }

            const response = await fetch('/api/auth/me', {
              headers: {
                'Authorization': `Bearer ${token}`,
                'X-Session-ID': sessionId || ''
              }
            });

            if (response.ok) {
              const userData = await response.json();
              userId = userData._id;
              
              // Save for future use
              if (userId) {
                localStorage.setItem('userId', userId);
                
              }
          } else {
              console.error("Failed to fetch current user data");
              return null;
          }
        } catch (error) {
            console.error("Error getting current user:", error);
            return null;
          }
        }

        return userId;
      }

      // Function to show message when no other users are found
      function showNoOtherUsersMessage() {
        const profileCard = document.getElementById('current-profile');
        const usersContainer = document.getElementById('all-users-container');
        
        if (profileCard) {
          profileCard.innerHTML = `
            <div style="height: 100%; display: flex; align-items: center; justify-content: center; text-align: center; padding: 20px; background-color: white; border-radius: 15px;">
              <div>
                <h3>No Other Users Found</h3>
                <p>You're currently the only user in the system. Check back later when more users have joined!</p>
              </div>
            </div>
          `;
        }
        
        if (usersContainer) {
          usersContainer.innerHTML = `
            <div class="col-12 text-center py-5">
              <div class="alert alert-info" role="alert">
                <h4 class="alert-heading">No Other Users Available</h4>
                <p>You're currently the only user in the system. Invite others to join and expand your network!</p>
              </div>
            </div>
          `;
        }
      }

      // Function to show login required message
      function showLoginRequiredMessage() {
        const profileCard = document.getElementById('current-profile');
        const usersContainer = document.getElementById('all-users-container');
        
        if (profileCard) {
          profileCard.innerHTML = `
            <div style="height: 100%; display: flex; align-items: center; justify-content: center; text-align: center; padding: 20px; background-color: white; border-radius: 15px;">
              <div>
                <h3>Login Required</h3>
                <p>Please log in to view and connect with other users.</p>
                <a href="/login.html" class="btn btn-primary mt-3">Log In</a>
              </div>
            </div>
          `;
        }
        
        if (usersContainer) {
          usersContainer.innerHTML = `
            <div class="col-12 text-center py-5">
              <div class="alert alert-warning" role="alert">
                <h4 class="alert-heading">Login Required</h4>
                <p>You need to be logged in to view other users' profiles.</p>
                <hr>
                <a href="/login.html" class="btn btn-warning">Log In Now</a>
              </div>
            </div>
          `;
        }
      }

      // Function to show message when no users are found
      function showNoUsersMessage() {
        const profileCard = document.getElementById('current-profile');
        if (profileCard) {
          profileCard.innerHTML = `
            <div style="height: 100%; display: flex; align-items: center; justify-content: center; text-align: center; padding: 20px; background-color: white; border-radius: 15px;">
              <div>
                <h3>No users found</h3>
                <p>We couldn't find any users in the database.</p>
                <button class="btn btn-primary mt-3" onclick="useDemoProfiles()">Use Demo Data</button>
              </div>
            </div>
          `;
        }
      }

      // Function to render all users in a list view
      function renderAllUsersList() {
        const usersContainer = document.getElementById('all-users-container');
        if (!usersContainer) {
          console.error("Users container not found");
          return;
        }
        
        usersContainer.innerHTML = '';
        
        // Make sure we're using the global profiles array
        if (!window.profiles || !Array.isArray(window.profiles)) {
          console.error("Profiles array is not available");
          usersContainer.innerHTML = `
            <div class="col-12 text-center py-5">
              <div class="alert alert-warning" role="alert">
                <h4 class="alert-heading">No Profiles Available</h4>
                <p>We couldn't load any profiles at this time. Please try again later.</p>
              </div>
            </div>
          `;
          return;
        }
        
        window.profiles.forEach((profile, index) => {
          // CRITICAL FIX: Ensure profile.id is properly passed to openProfileModal 
          // by stringifying it to maintain its value as a string in the HTML
          const profileId = JSON.stringify(profile.id);
          
          console.log(`Rendering user card ${index}: ID=${profile.id} (${typeof profile.id}), Stringified=${profileId}`);
          
          const userCard = document.createElement('div');
          userCard.className = 'col-md-6 col-lg-4 mb-4';
          userCard.innerHTML = `
            <div class="card user-card h-100">
              <div class="position-relative">
                <img src="${profile.image}" alt="${profile.name}" class="card-img-top user-card-image"
                     onerror="this.onerror=null; this.src='/assets/images/user/blank-avatar.png';">
                <div class="position-absolute top-0 end-0 m-2">
                  <button class="btn btn-light rounded-circle p-2" 
                          data-profile-id="${profile.id}" 
                          onclick="openProfileModal(event, ${profileId})">
                    <i class="ti ti-eye"></i>
                  </button>
                </div>
                ${getGenderBadgeHTML(profile)}
              </div>
              <div class="card-body">
                <h5 class="card-title">${profile.name}</h5>
                <p class="card-text text-muted">${profile.title}</p>
                <div class="d-flex flex-wrap gap-1 mb-3">
                  ${profile.tags.map(tag => `<span class="badge bg-light text-dark">${tag}</span>`).join('')}
                </div>
                <p class="card-text"><i class="ti ti-map-pin"></i> ${profile.location}</p>
              </div>
              <div class="card-footer bg-transparent d-flex justify-content-between">
                <button class="btn btn-outline-danger" onclick="rejectProfile(event, ${index})">Skip</button>
                <button class="btn btn-primary" onclick="acceptProfile(event, ${index})">Ignite</button>
              </div>
            </div>
          `;
          
          usersContainer.appendChild(userCard);
        });
      }
      
      // Function to render filtered profiles in the grid view
      function renderFilteredUsersList() {
        const usersContainer = document.getElementById('all-users-container');
        if (!usersContainer) {
          console.error("Users container not found");
          return;
        }
        
        // Use filtered profiles if available, otherwise use all profiles
        const profilesToRender = window.filteredProfiles || window.profiles;
        
        if (!profilesToRender || profilesToRender.length === 0) {
          usersContainer.innerHTML = `
            <div class="col-12 text-center py-5">
              <div class="alert alert-info" role="alert">
                <h4 class="alert-heading">No Matching Profiles</h4>
                <p>There are no profiles that match your filter criteria.</p>
                <hr>
                <button class="btn btn-primary" onclick="document.getElementById('reset-filters-btn').click()">Reset Filters</button>
              </div>
            </div>
          `;
          return;
        }
        
        usersContainer.innerHTML = '';
        
        profilesToRender.forEach((profile, index) => {
          // CRITICAL FIX: Ensure profile.id is properly passed to openProfileModal 
          // by stringifying it to maintain its value as a string in the HTML
          const profileId = JSON.stringify(profile.id);
          
          const userCard = document.createElement('div');
          userCard.className = 'col-md-6 col-lg-4 mb-4';
          userCard.innerHTML = `
            <div class="card user-card h-100">
              <div class="position-relative">
                <img src="${profile.image}" alt="${profile.name}" class="card-img-top user-card-image"
                     onerror="this.onerror=null; this.src='/assets/images/user/blank-avatar.png';">
                <div class="position-absolute top-0 end-0 m-2">
                  <button class="btn btn-light rounded-circle p-2" 
                          data-profile-id="${profile.id}" 
                          onclick="openProfileModal(event, ${profileId})">
                    <i class="ti ti-eye"></i>
                  </button>
                </div>
                ${getGenderBadgeHTML(profile)}
              </div>
              <div class="card-body">
                <h5 class="card-title">${profile.name}</h5>
                <p class="card-text text-muted">${profile.title}</p>
                <div class="d-flex flex-wrap gap-1 mb-3">
                  ${profile.tags.map(tag => `<span class="badge bg-light text-dark">${tag}</span>`).join('')}
                </div>
                <p class="card-text"><i class="ti ti-map-pin"></i> ${profile.location}</p>
              </div>
              <div class="card-footer bg-transparent d-flex justify-content-between">
                <button class="btn btn-outline-danger" onclick="rejectProfile(event, ${index})">Skip</button>
                <button class="btn btn-primary" onclick="acceptProfile(event, ${index})">Ignite</button>
              </div>
            </div>
          `;
          
          usersContainer.appendChild(userCard);
        });
      }
      
      // Helper function to get badge class based on gender
      function getGenderBadgeClass(gender) {
        // If gender is an object with a value property
        if (typeof gender === 'object' && gender.value) {
          gender = gender.value;
        }
        
        switch(gender) {
          case 'Male':
            return 'bg-primary';
          case 'Female':
            return 'bg-danger';
          case 'Other':
            return 'bg-success';
          case 'Prefer not to say':
            return 'bg-info';
          default:
            return 'bg-secondary';
        }
      }
      
      // Helper function to get the gender display value
      function getGenderDisplayValue(gender) {
        // If gender is an object with a value property (database format)
        if (typeof gender === 'object' && gender !== null && gender.value) {
          return gender.value;
        }
        
        // If gender is a string
        if (typeof gender === 'string') {
          return gender;
        }
        
        console.log('Unknown gender format:', gender);
        return 'Unknown';
      }
      
      // Helper function to create gender badge HTML
      function getGenderBadgeHTML(profile) {
        if (!profile.gender) return '';
        
        const genderValue = getGenderDisplayValue(profile.gender);
        const badgeClass = getGenderBadgeClass(profile.gender);
        
        return `<div class="position-absolute top-0 start-0 m-2">
          <span class="badge ${badgeClass}">${genderValue}</span>
        </div>`;
      }

      // Initialize the profile system
      function initProfileSystem() {
        
        
        // Initialize current profile index
        window.currentProfileIndex = 0;
        
        // Initialize modal
        const customerModal = document.getElementById('customer-modal');
        if (customerModal) {
          
          
          // Try to initialize with jQuery if available
          if (typeof $ !== 'undefined') {
            $(customerModal).on('show.bs.modal', function () {
              console.log('Modal is showing (jQuery event)');
            });
          }
          
          // Also add a direct click listener for the view button
          document.addEventListener('click', function(e) {
            const viewBtn = e.target.closest('.view-profile-btn');
            if (viewBtn) {
              
              e.preventDefault();
              e.stopPropagation();
              
              // CRITICAL FIX: Extract the profile ID from the data attribute
              const profileId = viewBtn.getAttribute('data-profile-id');
              if (!profileId) {
                console.error('No profile ID found on button element');
                return;
              }
              
              
              
              // Call openProfileModal with the profile ID
              openProfileModal(e, profileId);
              
              // Prevent default modal opening
              return false;
            }
          });
        } else {
          console.warn('Customer modal element not found!');
        }
        
        // Start the preloader animation
        startPreloader();
        
        // Fetch real user data
        fetchUsersFromDB();
      }

      // Start the preloader animation
      function startPreloader() {
        
        
        const magicPreloader = document.querySelector('.magic-preloader');
        const progressBar = document.querySelector('.magic-preloader-progress-bar');
        const comingSoonContent = document.querySelector('.coming-soon-content');
        
        if (!magicPreloader || !progressBar || !comingSoonContent) {
          console.error("Required preloader elements not found!");
          // Load profile anyway if preloader is missing
          loadProfile(currentProfileIndex);
          return;
        }
        
        // Hide the coming soon content initially
        comingSoonContent.style.opacity = '0';
        
        // Update progress bar
        let progress = 0;
        const interval = setInterval(() => {
          progress += 2;
          progressBar.style.width = `${progress}%`;
          
          if (progress >= 100) {
            clearInterval(interval);
            
            
            // Hide preloader after a short delay
            setTimeout(() => {
              magicPreloader.classList.add('hidden');
              
              // Show coming soon content with a fade-in effect
              setTimeout(() => {
                comingSoonContent.classList.add('visible');
                comingSoonContent.style.opacity = '1';
                
                
                // Load the first profile
                loadProfile(currentProfileIndex);
              }, 300);
            }, 500);
          }
        }, 40); // Update faster - 40ms per step to reduce total time
      }

      // Function to load a profile into the card
      function loadProfile(index) {
        
        
        const profileCard = document.getElementById('current-profile');
        if (!profileCard) {
          console.error("Profile card element not found!");
          return;
        }
        
        // Use window.profiles to ensure we're accessing the global variable
        // Use filtered profiles if available, otherwise use all profiles
        const profilesArray = window.filteredProfiles || window.profiles;
        
        if (!profilesArray || !Array.isArray(profilesArray) || profilesArray.length === 0) {
          
          profileCard.innerHTML = `
            <div style="height: 100%; display: flex; align-items: center; justify-content: center; text-align: center; padding: 20px; background-color: white; border-radius: 15px;">
              <div>
                <h3>All profiles viewed</h3>
                <p>You'll be notified when new matches are available.</p>
                <button class="btn btn-primary mt-3" onclick="resetProfiles()">View Again</button>
              </div>
            </div>
          `;
          
          // Also update the grid view to show no more profiles
          const usersContainer = document.getElementById('all-users-container');
          if (usersContainer) {
            usersContainer.innerHTML = `
              <div class="col-12 text-center py-5">
                <div class="alert alert-info" role="alert">
                  <h4 class="alert-heading">All Profiles Viewed</h4>
                  <p>You've viewed all available profiles for now.</p>
                  <hr>
                  <p class="mb-0">Check back later for new matches!</p>
                </div>
              </div>
            `;
          }
          return;
        }

        // If the index is out of bounds, adjust it
        if (index >= profilesArray.length) {
          index = profilesArray.length - 1;
          window.currentProfileIndex = index;
          
          if (index < 0) {
            
            loadProfile(index); // This will trigger the "no profiles" view
          return;
          }
        }
        
        const profile = profilesArray[index];
        
        // Create tags HTML including match score
        const matchScoreHtml = `
          <div class="profile-match-score mb-2">
            <i class="ti ti-heart${profile.matchScore >= 0.7 ? '-filled' : ''} text-danger"></i>
            <span class="ms-1">${Math.round(profile.matchScore * 100)}% Match</span>
          </div>
        `;

        const tagsHTML = profile.tags.map(tag => `<span class="profile-tag">${tag}</span>`).join('');
        
        // Add matching interests section
        const matchingInterestsHtml = `
          <div class="matching-interests mb-3">
            <div class="matching-interest-group">
              <small class="text-muted">Matching Your Interests:</small>
              <div class="d-flex flex-wrap gap-1 mt-1">
                ${profile.matchingMyInterests.map(interest => 
                  `<span class="profile-tag bg-success text-white">${interest}</span>`
                ).join('')}
              </div>
            </div>
            <div class="matching-interest-group mt-2">
              <small class="text-muted">Matching Their Interests:</small>
              <div class="d-flex flex-wrap gap-1 mt-1">
                ${profile.matchingTheirInterests.map(interest => 
                  `<span class="profile-tag bg-primary text-white">${interest}</span>`
                ).join('')}
              </div>
            </div>
          </div>
        `;
        
        // Update the swipe controls in the profile card HTML
        const swipeControlsHtml = `
          <div class="swipe-controls">
            <div class="swipe-control swipe-left" onclick="previousProfile()">
              <i class="ti ti-chevron-left"></i>
            </div>
            <div class="swipe-control swipe-right" onclick="nextProfile()">
              <i class="ti ti-chevron-right"></i>
            </div>
          </div>
        `;
        
        // Debug button removed
        
        profileCard.innerHTML = `
          ${swipeControlsHtml}
          <img src="${profile.image}" alt="${profile.name}" class="profile-image" 
               onerror="this.onerror=null; this.src='/assets/images/user/blank-avatar.png';">
          <div class="view-profile-btn" data-profile-id="${profile.id}" onclick="openProfileModal(event, ${JSON.stringify(profile.id)})">
            <i class="ti ti-eye"></i>
          </div>
          <div class="profile-details">
            ${matchScoreHtml}
            <div class="profile-name">${profile.name}</div>
            <div class="profile-title">${profile.title}</div>
            <div class="profile-tags">
              ${tagsHTML}
            </div>
            ${matchingInterestsHtml}
            <div class="profile-location">
              <i class="ti ti-map-pin"></i> ${profile.location}
            </div>
            <div class="profile-actions">
              <button class="action-btn reject-btn" onclick="rejectProfile(event, ${index})">Skip</button>
              <button class="action-btn accept-btn" onclick="acceptProfile(event, ${index})">Ignite</button>
            </div>
          </div>
        `;
        
        // Reset any previous transformations
        profileCard.style.transform = '';
        profileCard.style.opacity = '1';
      }

      // Function to swipe left (reject)
      function swipeLeft() {
        
        const card = document.getElementById('current-profile');
        
        // If no card exists or no profiles left, handle gracefully
        if (!card || !window.profiles || !window.profiles.length) {
          console.warn('Cannot swipe: no card or profiles available');
          showNoMatchesMessage();
          return;
        }
        
        // Apply the animation
        card.style.transform = 'translateX(-100%) rotateY(-10deg)';
        card.style.opacity = '0';
        
        setTimeout(() => {
          // Remove the swiped profile from the array
          const oldIndex = currentProfileIndex;
          const updatedProfiles = [...window.profiles];
          updatedProfiles.splice(oldIndex, 1);
          window.profiles = updatedProfiles;
          
          // Check if we need to adjust the current index
          if (currentProfileIndex >= window.profiles.length) {
            currentProfileIndex = window.profiles.length - 1;
            if (currentProfileIndex < 0) {
              currentProfileIndex = 0;
            }
          }
          
          
          
          // Check if we've reached the end
          if (window.profiles.length === 0) {
            
            // Force opacity back to 1 before showing end message
            card.style.opacity = '1';
            card.style.transform = '';
            showNoMoreProfilesMessage();
          } else {
            // Load the next profile
          loadProfile(currentProfileIndex);
            
            // Reset the card animation
            card.style.transform = '';
            card.style.opacity = '1';
          }
        }, 600);
      }

      // Function to swipe right (accept)
      function swipeRight() {
        
        const card = document.getElementById('current-profile');
        
        // If no card exists or no profiles left, handle gracefully
        if (!card || !window.profiles || !window.profiles.length) {
          console.warn('Cannot swipe: no card or profiles available');
          // Show the "no more profiles" view immediately
          loadProfile(0); // This will detect empty profiles and show the "all viewed" message
          return;
        }
        
        // Apply the animation
        card.style.transform = 'translateX(100%) rotateY(10deg)';
        card.style.opacity = '0';
        
        setTimeout(() => {
          // Check if profiles array is still valid after the animation
          if (!window.profiles || !window.profiles.length) {
            
            // Show end message
            loadProfile(0);
            return;
          }
          
          // Check if we've reached the end
          if (currentProfileIndex >= window.profiles.length - 1) {
            
            currentProfileIndex = window.profiles.length - 1;
          }
          
          // Load the next profile (or show end message)
          loadProfile(currentProfileIndex);
          
          // Reset the card animation
          card.style.transform = '';
            card.style.opacity = '1';
        }, 600);
      }

      // Function to navigate to previous profile
      function previousProfile() {
        if (currentProfileIndex > 0) {
          
          const card = document.getElementById('current-profile');
          card.style.transform = 'translateX(100%) rotateY(10deg)';
          card.style.opacity = '0';
          
          setTimeout(() => {
            // Decrement the index
            currentProfileIndex--;
            
            
            // Load the previous profile
            loadProfile(currentProfileIndex);
            
            // Reset transform after loading
            setTimeout(() => {
            card.style.transform = '';
              card.style.opacity = '1';
            }, 50);
          }, 600);
        } else {
          
          // Optional: Add visual feedback that we're at the start
          const card = document.getElementById('current-profile');
          card.style.transform = 'translateX(20px)';
          setTimeout(() => {
            card.style.transform = '';
          }, 200);
        }
      }

      // Function to navigate to next profile
      function nextProfile() {
        if (currentProfileIndex < window.profiles.length - 1) {
          
          const card = document.getElementById('current-profile');
          card.style.transform = 'translateX(-100%) rotateY(-10deg)';
          card.style.opacity = '0';
          
          setTimeout(() => {
            // Increment the index
            currentProfileIndex++;
            
            
            // Load the next profile
          loadProfile(currentProfileIndex);
            
            // Reset transform after loading
            setTimeout(() => {
              card.style.transform = '';
              card.style.opacity = '1';
            }, 50);
        }, 600);
        } else {
          
          // Optional: Add visual feedback that we're at the end
          const card = document.getElementById('current-profile');
          card.style.transform = 'translateX(-20px)';
          setTimeout(() => {
            card.style.transform = '';
          }, 200);
        }
      }

      // Function to show toast notification
      function showToast(message, type = 'info') {
        // Create a Bootstrap toast
        const toastContainer = document.createElement('div');
        toastContainer.className = 'position-fixed bottom-0 end-0 p-3';
        toastContainer.style.zIndex = '1080';
        
        const bgClass = type === 'success' ? 'bg-success' : 
                       type === 'error' ? 'bg-danger' : 
                       'bg-info';
        
        toastContainer.innerHTML = `
          <div class="toast align-items-center text-white ${bgClass} border-0" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
              <div class="toast-body">
                ${message}
              </div>
              <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
          </div>
        `;
        
        document.body.appendChild(toastContainer);
        
        const toastElement = toastContainer.querySelector('.toast');
        const toast = new bootstrap.Toast(toastElement, {
          autohide: true,
          delay: 3000
        });
        
        toast.show();
        
        // Remove the toast element after it's hidden
        toastElement.addEventListener('hidden.bs.toast', function() {
          document.body.removeChild(toastContainer);
        });
      }

      // Shortcut functions for the buttons
      function rejectProfile(event, index) {
        if (event) {
          event.preventDefault();
          event.stopPropagation();
          
          // Disable the button to prevent double-clicks
          const button = event.currentTarget;
          button.disabled = true;
          button.innerHTML = '<i class="ti ti-loader ti-spin"></i> Skipping...';
          
          // Show toast
          showToast('Profile skipped', 'info');
          
          // Find the card element
          const userCard = button.closest('.user-card');
          const gridCardContainer = userCard ? userCard.closest('.col-md-6.col-lg-4') : null;
          
          // Apply removal animation to card
          if (userCard) {
            userCard.style.transition = 'all 0.5s ease';
            userCard.style.opacity = '0';
            userCard.style.transform = 'translateY(20px)';
            
            // Remove card from grid after animation completes
            if (gridCardContainer) {
          setTimeout(() => {
                gridCardContainer.remove();
                // Update "No profiles" message if all cards are removed
                checkRemainingProfiles();
              }, 500);
            }
          }
          
          // If we're in the card view and this is the current profile, swipe left
          if (window.currentProfileIndex !== undefined && window.profiles) {
            if (window.currentProfileIndex === index) {
              // Animate swipe left and go to next profile
              swipeLeft();
            } else {
              // Remove the profile from the profiles array to prevent showing it again
              window.profiles = window.profiles.filter((_, i) => i !== index);
              
              // If current index is after the removed one, adjust it
              if (window.currentProfileIndex > index) {
                window.currentProfileIndex--;
              }
              
              // Update the current card if needed
              if (window.currentProfileIndex >= window.profiles.length) {
                window.currentProfileIndex = window.profiles.length - 1;
                if (window.currentProfileIndex >= 0) {
                  loadProfile(window.currentProfileIndex);
                } else {
                  // No profiles left
                  showNoMatchesMessage();
                }
              }
            }
          }
          
          // Re-enable button after a short delay if it's still in the DOM
          setTimeout(() => {
            if (document.body.contains(button) && !button.closest('.profile-card')) {
              button.disabled = false;
              button.innerHTML = 'Skip';
            }
          }, 1000);
        } else {
          // If no event, just do the swipe animation
        swipeLeft();
        }
      }

      function acceptProfile(event, index) {
        if (event) {
          event.preventDefault();
          event.stopPropagation();
          
          // Disable the button to prevent double-clicks
          const button = event.currentTarget;
          button.disabled = true;
          button.innerHTML = '<i class="ti ti-loader ti-spin"></i> Connecting...';
          
          // Get user ID from current profile
          
          
          // Validate index and profiles array
          if (typeof index !== 'number' || index < 0 || !window.profiles || !Array.isArray(window.profiles) || index >= window.profiles.length) {
            console.error(`Invalid index (${index}) or profiles array not available`, window.profiles);
            
            // Show error toast
            if (typeof showToast === 'function') {
              showToast('Error: Could not find user profile', 'error');
            }
            
            // Re-enable button
          setTimeout(() => {
              button.disabled = false;
              button.innerHTML = 'Ignite';
            }, 1000);
            
            return;
          }
          
          // Check if profile has valid ID
          const profileData = window.profiles[index];
          
          
          const userId = profileData.id || profileData._id;
          console.log(`User ID from profile: ${userId} (${typeof userId})`);
          
          if (!userId) {
            console.error(`No valid ID found in profile at index ${index}:`, profileData);
            
            // Show error toast
            if (typeof showToast === 'function') {
              showToast('Error: Invalid user profile', 'error');
            }
            
            // Re-enable button
            setTimeout(() => {
              button.disabled = false;
              button.innerHTML = 'Ignite';
          }, 1000);
            
            return;
          }
          
          // Clean the user ID for consistency
          const cleanUserId = typeof cleanIdValue === 'function' ? cleanIdValue(userId) : userId;
          console.log(`Cleaned user ID: ${cleanUserId} (${typeof cleanUserId})`);
          
          // Find the card element
          const userCard = button.closest('.user-card');
          const gridCardContainer = userCard ? userCard.closest('.col-md-6.col-lg-4') : null;
          const isMainCard = button.closest('.profile-card') !== null;
          
          // Track if we're on the last profile
          const isLastProfile = profiles.length === 1;
          
          
          // Send actual connection request using the function from follow-button.js
          if (typeof sendConnectionRequest === 'function' && cleanUserId) {
            
            
            // Generate a unique purpose string to bypass any unique constraints
            const uniquePurpose = `magic-${Date.now()}-${Math.floor(Math.random() * 1000)}`;
            
            
            sendConnectionRequest(cleanUserId, button, uniquePurpose)
              .then(result => {
                
                
                // IMPROVED: Check multiple success conditions
                // Consider both success=true from 400 responses AND status=pending/accepted as successful outcomes
                const isSuccess = result.success === true || // From our enhanced error handling
                                 result.status === 'pending' || 
                                 result.status === 'accepted';
                
                if (isSuccess) {
                  // Log more details about the result for debugging
                  
                  
                  
                  // Show proper success or info message
                  if (result.message) {
                    showToast(result.message, result.status === 'accepted' ? 'success' : 'info');
                  } else {
                    showToast('Connection successful!', 'success');
                  }
                  
                  // If it's a grid card, animate and remove it
                  if (userCard && !isMainCard) {
                    userCard.style.transition = 'all 0.5s ease';
                    userCard.style.opacity = '0';
                    userCard.style.transform = 'translateY(20px)';
                    
                    // Remove card from grid after animation completes
                    if (gridCardContainer) {
                      setTimeout(() => {
                        gridCardContainer.remove();
                        // Update "No profiles" message if all cards are removed
                        checkRemainingProfiles();
                      }, 500);
                    }
                  }
                  
                  // For the swipe card, handle differently
                  if (isMainCard) {
                    // If this is the last profile, we need special handling
                    if (isLastProfile) {
                      
                      
                      // Remove the profile from our array immediately
                      window.profiles = [];
                      
                      // Animate the card away (we'll replace it with a message)
                      setTimeout(() => {
                        swipeRight();
                      }, 100);
                    } else {
                      // Important: Remove the profile from the array before swiping
                      // This prevents race conditions where profiles are processed too quickly
                      window.profiles = window.profiles.filter((_, i) => i !== index);
                      
                      // Set current index to the beginning of the remaining profiles
                      // This ensures we always have a valid index
                      window.currentProfileIndex = 0;
                      
                      // Now do the swipe animation
        swipeRight();
                    }
                  }
                } else {
                  // Request failed for a reason other than connection-related states
                  console.warn(`Connection request failed: ${result.message || 'Unknown error'}`);
                  showToast(result.message || 'Connection failed', 'error');
                  
                  // Re-enable the button
                  button.disabled = false;
                  button.innerHTML = 'Ignite';
                }
              })
              .catch(error => {
                console.error('Error sending connection request:', error);
                
                // IMPROVED: Try to parse the error object to get better information
                let errorMessage = 'Unknown error occurred';
                let shouldProcessAsSuccess = false;
                
                // Check if we should process this as a successful connection despite the error
                // This happens in cases like duplicate connections or race conditions
                if (typeof error === 'object' && error !== null) {
                  // Case 1: Error has a message property (most common)
                  if (error.message) {
                    errorMessage = error.message;
                    
                    // Check for connection-already-exists type messages
                    const alreadyExistsPatterns = [
                      'already exists', 
                      'already sent', 
                      'already connected', 
                      'already pending',
                      'Duplicate connection',
                      'Connection request already',
                      'Server error processing connection'
                    ];
                    
                    // Check if any of the patterns match
                    const isAlreadyExists = alreadyExistsPatterns.some(pattern => 
                      error.message.includes(pattern)
                    );
                    
                    if (isAlreadyExists) {
                      
                      shouldProcessAsSuccess = true;
                      
                      // Show a friendly message based on the error type
                      if (error.message.includes('Duplicate') || error.message.includes('Server error')) {
                        showToast('Connection request is being processed. Card will be removed.', 'info');
                      } else {
                        showToast(error.message.includes('already') ? error.message : 'Connection already exists', 'info');
                      }
                    } else {
                      // Regular error message
                      showToast(`Error: ${error.message}`, 'error');
                    }
                  } 
                  // Case 2: Error has a status property (API response object)
                  else if (error.status) {
                    if (error.status === 'pending' || error.status === 'accepted' || error.success === true) {
                      shouldProcessAsSuccess = true;
                      showToast(error.message || `Connection ${error.status}`, 'info');
                    } else {
                      showToast(`Error: ${error.message || `Status: ${error.status}`}`, 'error');
                    }
                  }
                  // Case 3: Error has an error property (server error object)
                  else if (error.error) {
                    // Check for duplicate connection messages in error field
                    if (error.error.includes('Duplicate connection') || 
                        error.error.includes('already exists') ||
                        error.error.includes('Connection request already')) {
                      
                      shouldProcessAsSuccess = true;
                      showToast('Connection appears to already exist. Card will be removed.', 'info');
                    } else {
                      showToast(`Server error: ${error.error}`, 'error');
                    }
                  }
                  // Case 4: Unknown error object structure
                  else {
                    showToast('Connection failed with unknown error', 'error');
                  }
                } 
                // Case 5: Error is not an object
                else {
                  showToast('Connection failed', 'error');
                }
                
                if (shouldProcessAsSuccess) {
                  // Treat as successful connection and remove the card
                  if (isMainCard) {
                    swipeRight();
                  } else if (userCard && gridCardContainer) {
                    // Remove from grid
                    userCard.style.opacity = '0';
                    userCard.style.transform = 'translateY(20px)';
                    setTimeout(() => {
                      gridCardContainer.remove();
                      checkRemainingProfiles();
                    }, 500);
                  }
                } else {
                  // Re-enable button for actual errors
                  button.disabled = false;
                  button.innerHTML = 'Ignite';
                }
              });
          } else {
            console.error(`sendConnectionRequest function not available (${typeof sendConnectionRequest}) or userId missing (${cleanUserId})`);
            // Show error toast
            if (typeof showToast === 'function') {
              showToast('Error: Could not send connection request', 'error');
            }
            // Re-enable button
            setTimeout(() => {
              button.disabled = false;
              button.innerHTML = 'Ignite';
            }, 1000);
          }
        } else {
          // If no event, just do the swipe animation
          swipeRight();
        }
      }

      // Function to check if there are any profiles left and show message if needed
      function checkRemainingProfiles() {
        const userCards = document.querySelectorAll('.user-card');
        if (userCards.length === 0) {
          const usersContainer = document.getElementById('all-users-container');
          if (usersContainer) {
            usersContainer.innerHTML = `
              <div class="col-12 text-center py-5">
                <div class="alert alert-info" role="alert">
                  <h4 class="alert-heading">No More Profiles</h4>
                  <p>You've connected with all available profiles that match your interests.</p>
                  <hr>
                  <p class="mb-0">Check back later for new users or update your preferences!</p>
                </div>
              </div>
            `;
          }
        }
      }

      // Reset to start over
      function resetProfiles() {
        
        currentProfileIndex = 0;
        loadProfile(currentProfileIndex);
      }

      // Function to open the profile modal
      function openProfileModal(event, profileId) {
        // Prevent default behavior and stop propagation
        if (event) {
          event.preventDefault();
          event.stopPropagation();
        }
        
        // CRITICAL FIX: Clean up the profileId
        profileId = cleanIdValue(profileId);
        
        // CRITICAL FIX: Ensure profileId is properly passed
        if (!profileId) {
          console.error('No profile ID provided to openProfileModal:', profileId);
          return;
        }
        
        
        
        // Store current profile ID globally for error handling
        window.currentProfileId = profileId;
        
        // First show the modal with loading state
        const modalElement = document.getElementById('customer-modal');
        if (!modalElement) {
          console.error('Modal element not found');
          return;
        }
        
        // Show loading state in the modal
        setModalLoadingState(profileId);
        
        // Show the modal using multiple methods for compatibility
        try {
          // Try the jQuery method first
          if (typeof $ !== 'undefined' && $('#customer-modal').length) {
            $('#customer-modal').modal('show');
            
          } 
          // Fallback to Bootstrap 5 native method
          else {
            const bsModal = new bootstrap.Modal(modalElement);
            bsModal.show();
            
          }
        } catch (error) {
          console.error('Error opening modal:', error);
        }
        
        // Fetch and display the user's detailed profile
        // IMPORTANT: Wrap in setTimeout to ensure modal is shown first
        setTimeout(() => {
          fetchUserProfile(profileId);
        }, 100);
      }
      
      // Function to set the modal to loading state
      function setModalLoadingState(profileId) {
        const modalBody = document.querySelector('#customer-modal .modal-body');
        if (!modalBody) return;
        
        modalBody.innerHTML = `
          <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading profile data...</span>
            </div>
            <p class="mt-3">Loading profile data for ID: ${profileId || 'unknown'}</p>
          </div>
        `;
        
        // Store the profile ID in the modal for reference
        modalBody.setAttribute('data-profile-id', profileId || '');
      }

      // Function to fetch and display detailed user profile data
      async function fetchUserProfile(userId) {
        
        
        // CRITICAL FIX: Ensure userId is a valid string
        if (!userId) {
          console.error('Invalid user ID passed to fetchUserProfile:', userId);
          showErrorInModal('Invalid user ID provided', 'notFound');
          return;
        }
        
        try {
          // Check for network connectivity
          if (!navigator.onLine) {
            throw { type: 'network', message: 'You appear to be offline' };
          }
          
          // First check if we have the full user data in our profiles array
          const fullUserData = await getFullUserData(userId);
          if (!fullUserData) {
            throw { type: 'notFound', message: 'Could not find user data' };
          }
          
          
          
          // CRITICAL DEBUG: Log the actual data received to verify it's the correct user
          
          
          
          // Validate important fields
          const validationResult = validateUserData(fullUserData);
          if (!validationResult.isValid) {
            console.warn('User data is incomplete:', validationResult.missingFields.join(', '));
          }
          
          // Update the modal with the user data we have
          updateModalWithUserData(fullUserData);
          
        } catch (error) {
          console.error('Error fetching user profile:', error);
          
          // Determine error type
          let errorType = 'general';
          let errorMessage = 'Failed to load profile data. Please try again.';
          
          if (error.type) {
            errorType = error.type;
            errorMessage = error.message;
          } else if (error.message && error.message.includes('authentication')) {
            errorType = 'auth';
            errorMessage = 'Authentication error: ' + error.message;
          } else if (error.message && (error.message.includes('network') || error.message.includes('fetch'))) {
            errorType = 'network';
            errorMessage = 'Network error: ' + error.message;
          }
          
          showErrorInModal(errorMessage, errorType);
        }
      }

      // Function to get the full user data, either from cache or API
      async function getFullUserData(userId) {
        // CRITICAL FIX: Clean and normalize the userId
        const userIdStr = cleanIdValue(userId);
        
        
        // Check if we already have this user's full data in the window.profiles array
        // (The profile card only has summary data)
        let cachedProfile = null;
        
        // CRITICAL FIX: Ensure we properly match IDs that might be stored in different formats
        if (window.profiles && Array.isArray(window.profiles)) {
          cachedProfile = window.profiles.find(p => 
            cleanIdValue(p.id) === userIdStr || 
            (p._id && cleanIdValue(p._id) === userIdStr)
          );
          
          console.log('Cached profile search result:', 
            cachedProfile ? `Found - ${cachedProfile.name || 'unnamed'}` : 'Not found');
        }
        
        if (!cachedProfile) {
          console.warn('User not found in cached profiles:', userIdStr);
          // CRITICAL FIX: Try to find the profile again by iterating through all profiles
          console.log('Available profile IDs:', window.profiles ? 
            window.profiles.map(p => `${p.id} (${typeof p.id})`).join(', ') : 'No profiles available');
          
          // Additional fallback to avoid null returns
          cachedProfile = { id: userIdStr };
        }
        
        // Get auth token and session id - defined outside try/catch blocks so available everywhere
        const token = localStorage.getItem('token') || sessionStorage.getItem('token') || getCookie('token');
        const sessionId = localStorage.getItem('sessionId') || sessionStorage.getItem('sessionId');
        
        // Strategy 1: Try direct API call to get user by ID
        try {
          
          const response = await fetch(`/api/users/${userIdStr}`, {
            method: 'GET',
            headers: {
              'Content-Type': 'application/json',
              'Accept': 'application/json',
              'Authorization': token ? `Bearer ${token}` : '',
              'X-Session-ID': sessionId || ''
            }
          });
          
          if (!response.ok) {
            console.warn(`API returned status ${response.status} for user ID: ${userIdStr}`);
            throw new Error(`HTTP error! Status: ${response.status}`);
          }
          
          const userData = await response.json();
          
          return userData;
        } catch (error) {
          console.warn('Error fetching user data from API:', error.message);
          
          // Strategy 2: Try to find the user in the full users list
          try {
            
            const response = await fetch('/api/users', {
              headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json',
                'Authorization': token ? `Bearer ${token}` : '',
                'X-Session-ID': sessionId || ''
              }
            });
            
            if (response.ok) {
              const users = await response.json();
              
              
              // CRITICAL FIX: Use string comparison to avoid type mismatches
              const fullUser = users.find(user => String(user._id) === userIdStr);
              if (fullUser) {
                
                return fullUser;
              } else {
                console.warn(`User ID ${userIdStr} not found in full users list`);
                console.log('First few user IDs in the list:', 
                  users.slice(0, 5).map(u => `${u._id} (${typeof u._id})`).join(', '));
              }
            } else {
              console.warn(`API returned status ${response.status} for all users endpoint`);
            }
          } catch (innerError) {
            console.error('Error fetching all users:', innerError.message);
          }
          
          // Strategy 3: Try to get user data from profile endpoint
          try {
            
            const profileResponse = await fetch('/api/profile/data', {
              headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json',
                'Authorization': token ? `Bearer ${token}` : '',
                'X-Session-ID': sessionId || ''
              }
            });
            
            if (profileResponse.ok) {
              const profileData = await profileResponse.json();
              
              
              // Check if this is the user we're looking for
              if (String(profileData._id) === userIdStr) {
                
                return profileData;
              } else {
                console.warn('Profile data does not match requested user ID');
              }
            } else {
              console.warn(`API returned status ${profileResponse.status} for profile endpoint`);
            }
          } catch (profileError) {
            console.error('Error fetching profile data:', profileError.message);
          }
          
          // If all else fails, return the cached summary data
          
          return cachedProfile;
        }
      }

      // Function to validate user data
      function validateUserData(userData) {
        // List of expected fields that should be present
        const expectedFields = [
          'full_name',
          'email',
          'username',
          'technical_skills',
          'soft_skills',
          'my_interests',
          'interests_looking_in_others',
          'state',
          'city',
          'zip',
          'institution',
          'major_category',
          'major_sub_category',
          'year_of_study'
        ];
        
        // Check for missing fields
        const missingFields = [];
        for (const field of expectedFields) {
          if (!userData[field] && userData[field] !== 0) {
            // Special handling for nested fields
            if (field === 'state' || field === 'city' || field === 'zip' || 
                field === 'institution' || field === 'major_category' || 
                field === 'major_sub_category' || field === 'year_of_study') {
              // For these fields, we expect an object with a 'value' property
              if (!userData[field] || (!userData[field].value && userData[field].value !== 0)) {
                missingFields.push(field);
              }
            } else {
              missingFields.push(field);
            }
          } else if (Array.isArray(userData[field]) && userData[field].length === 0) {
            // For arrays, check if they're empty
            missingFields.push(`${field} (empty array)`);
          }
        }
        
        return {
          isValid: missingFields.length === 0,
          missingFields
        };
      }
      
      // Function to update the modal with user data
      function updateModalWithUserData(userData) {
        // Reference to modal body
        const modalBody = document.querySelector('#customer-modal .modal-body');
        if (!modalBody) {
          console.error('Modal body element not found');
          return;
        }
        
        
        
        // Process profile image using the established processImageUrl function
        let profileImageUrl = '../assets/images/user/blank-avatar.png';
        if (userData._id) {
          const cleanUserId = cleanIdValue(userData._id);
          profileImageUrl = processImageUrl(userData.profile_picture, cleanUserId);
          
        } else {
          console.warn('User ID not found in userData, using default avatar');
        }
        
        // Extract location information - handle object structure and direct values
        const getValueOrNA = (obj) => {
          if (!obj) return 'N/A';
          return obj.value || (typeof obj === 'string' ? obj : 'N/A');
        };
        
        const state = getValueOrNA(userData.state);
        const city = getValueOrNA(userData.city);
        const zipCode = getValueOrNA(userData.zip);
        const institution = getValueOrNA(userData.institution);
        const majorCategory = getValueOrNA(userData.major_category);
        const majorSubCategory = getValueOrNA(userData.major_sub_category);
        const yearOfStudy = getValueOrNA(userData.year_of_study);
        const majorType = userData.major_type || userData.majorType || 'N/A';
        
        const location = (city !== 'N/A' && state !== 'N/A') ? `${city}, ${state}` : 
                        (institution !== 'N/A' ? institution : 'Location not specified');
        
        // Format date of birth and calculate age
        let formattedDOB = 'N/A';
        if (userData.date_of_birth) {
          try {
            const birthDate = new Date(userData.date_of_birth);
            formattedDOB = birthDate.toLocaleDateString();
          } catch (e) {
            console.error('Error formatting date of birth:', e);
          }
        }
        
        // Get the full name - check multiple possible properties
        const fullName = userData.full_name || userData.fullName || userData.name || 'N/A';
        
        // Get gender and pronouns
        const gender = getValueOrNA(userData.gender);
        const pronouns = getValueOrNA(userData.pronoun);
        
        // Process bio/about me
        const bio = userData.bio || userData.aboutMe || 'No bio available';
        
        // Process skills
        const technicalSkills = Array.isArray(userData.technical_skills) ? 
            userData.technical_skills.join(', ') : 'N/A';
        const softSkills = Array.isArray(userData.soft_skills) ? 
            userData.soft_skills.join(', ') : 'N/A';
        
        // Process interests - handle different property names
        const myInterests = Array.isArray(userData.my_interests) ? 
            userData.my_interests.join(', ') : 'N/A';
        
        // Process looking for interests - try different possible property names
        let lookingForInterests = 'N/A';
        if (Array.isArray(userData.interests_looking_in_others)) {
          lookingForInterests = userData.interests_looking_in_others.join(', ');
        } else if (Array.isArray(userData.lookingForInterests)) {
          lookingForInterests = userData.lookingForInterests.join(', ');
        }
        
        // Get co-founders count from any of the possible fields
        const coFoundersCount = userData.co_founders_count || 
                               userData.co_founders_looking_for || 
                               userData.coFoundersCount || '0';
        
        // Build a comprehensive address string
        let addressStr = userData.address || '';
        if (city !== 'N/A') addressStr += (addressStr ? ', ' : '') + city;
        if (state !== 'N/A') addressStr += (addressStr ? ', ' : '') + state;
        if (zipCode !== 'N/A') addressStr += (addressStr ? ' ' : '') + zipCode;
        if (!addressStr) addressStr = 'Address not provided';
        
        // Get username
        const username = userData.username || '';
        
        // Update the modal content with a layout similar to profile.html's profile-1 tab
        modalBody.innerHTML = `
          <div class="row">
            <div class="col-lg-4">
              <div class="card">
                <div class="card-body position-relative">
                  <div class="text-center mt-3">
                    <div class="chat-avtar d-inline-flex mx-auto">
                      <img class="rounded-circle img-fluid wid-60" src="${profileImageUrl}"
                          alt="${fullName}" 
                          onerror="this.onerror=null; this.src='../assets/images/user/blank-avatar.png';">
                    </div>
                    <h5 class="mb-0">${fullName}</h5>
                    <p class="text-muted text-sm">${yearOfStudy}</p>
                    <hr class="my-3 border border-secondary-subtle">
                    <div class="d-inline-flex align-items-center justify-content-between w-100 mb-3">
                      <i class="ti ti-map-pin me-2"></i>
                      <p class="mb-0">${location}</p>
                    </div>
                    ${userData.website ? `
                    <div class="d-inline-flex align-items-center justify-content-between w-100">
                      <i class="ti ti-link me-2"></i>
                      <a href="${userData.website}" class="link-primary" target="_blank">
                        <p class="mb-0">${userData.website}</p>
                      </a>
                    </div>
                    ` : ''}
                  </div>
                </div>
              </div>
              <div class="card">
                <div class="card-header d-inline-flex align-items-center justify-content-space-between">
                  <h5 style="margin-left:15px;">No of Co-Founders: ${coFoundersCount}</h5>
                </div>
              </div>
              <div class="card">
                <div class="card-header">
                  <h5>Skills</h5>
                </div>
                <div class="card-body">
                  <div class="row align-items-center mb-3">
                    <p class="mb-1 text-muted">Hard Skills</p>
                    <div class="col-sm-12 mb-2 mb-sm-0">
                      <p class="mb-0">${technicalSkills}</p>
                    </div>
                  </div>
                  <div class="row align-items-center mb-3">
                    <p class="mb-1 text-muted">Soft Skills</p>
                    <div class="col-sm-12 mb-2 mb-sm-0">
                      <p class="mb-0">${softSkills}</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-lg-8">
              <div class="card">
                <div class="card-header">
                  <h5>About me</h5>
                </div>
                <div class="card-body">
                  <p class="mb-0">${bio}</p>
                </div>
              </div>
              <div class="card">
                <div class="card-header">
                  <h5>Personal Details</h5>
                </div>
                <div class="card-body">
                  <ul class="list-group list-group-flush">
                    <li class="list-group-item px-0 pt-0">
                      <div class="row">
                        <div class="col-md-6">
                          <p class="mb-1 text-muted">Full Name</p>
                          <p class="mb-0">${fullName}</p>
                        </div>
                        <div class="col-md-6">
                          <p class="mb-1 text-muted">Username</p>
                          <p class="mb-0">${username}</p>
                        </div>
                      </div>
                    </li>
                    <li class="list-group-item px-0">
                      <div class="row">
                        <div class="col-md-6">
                          <p class="mb-1 text-muted">Date of Birth</p>
                          <p class="mb-0">${formattedDOB}</p>
                        </div>
                        <div class="col-md-6">
                          <p class="mb-1 text-muted">Gender</p>
                          <p class="mb-0">${gender}</p>
                        </div>
                      </div>
                    </li>
                    <li class="list-group-item px-0">
                      <div class="row">
                        <div class="col-md-6">
                          <p class="mb-1 text-muted">State</p>
                          <p class="mb-0">${state}</p>
                        </div>
                        <div class="col-md-6">
                          <p class="mb-1 text-muted">City</p>
                          <p class="mb-0">${city}</p>
                        </div>
                      </div>
                    </li>
                    <li class="list-group-item px-0">
                      <div class="row">
                        <div class="col-md-6">
                          <p class="mb-1 text-muted">Zip Code</p>
                          <p class="mb-0">${zipCode}</p>
                        </div>
                        <div class="col-md-6">
                          <p class="mb-1 text-muted">Address</p>
                          <p class="mb-0">${addressStr}</p>
                        </div>
                      </div>
                    </li>
                    <li class="list-group-item px-0">
                      <div class="row">
                        <div class="col-md-6">
                          <p class="mb-1 text-muted">Pronouns</p>
                          <p class="mb-0">${pronouns}</p>
                        </div>
                      </div>
                    </li>
                  </ul>
                </div>
              </div>
              <div class="card">
                <div class="card-header">
                  <h5>Education</h5>
                </div>
                <div class="card-body">
                  <ul class="list-group list-group-flush">
                    <li class="list-group-item px-0 pt-0">
                      <div class="row">
                        <div class="col-md-6">
                          <p class="mb-1 text-muted">Year of Study</p>
                          <p class="mb-0">${yearOfStudy}</p>
                        </div>
                        <div class="col-md-6">
                          <p class="mb-1 text-muted">Institute</p>
                          <p class="mb-0">${institution}</p>
                        </div>
                      </div>
                    </li>
                    <li class="list-group-item px-0 pb-0">
                      <div class="row">
                        <div class="col-md-6">
                          <p class="mb-1 text-muted">Area of Study</p>
                          <p class="mb-0">${majorCategory}</p>
                        </div>
                        <div class="col-md-6">
                          <p class="mb-1 text-muted">Major Type</p>
                          <p class="mb-0">${majorType}</p>
                        </div>
                      </div>
                    </li>
                    <li class="list-group-item px-0 pb-0">
                      <div class="row">
                        <div class="col-md-6">
                          <p class="mb-1 text-muted">Major</p>
                          <p class="mb-0">${majorSubCategory}</p>
                        </div>
                      </div>
                    </li>
                  </ul>
                </div>
              </div>
              <div class="card">
                <div class="card-header">
                  <h5>Interest/industry</h5>
                </div>
                <div class="card-body">
                  <ul class="list-group list-group-flush">
                    <li class="list-group-item px-0 pt-0">
                      <div class="row">
                        <div class="col-md-6">
                          <p class="mb-1 text-muted">My Interests</p>
                          <p class="mb-0">${myInterests}</p>
                        </div>
                        <div class="col-md-6">
                          <p class="mb-1 text-muted">Looking for specific interest</p>
                          <p class="mb-0">${lookingForInterests}</p>
                        </div>
                      </div>
                    </li>
                  </ul>
                </div>
              </div>
            </div>
          </div>
        `;
      }
      
      // Function to show an error message in the modal
      function showErrorInModal(errorMessage, errorType = 'general') {
        const modalBody = document.querySelector('#customer-modal .modal-body');
        if (!modalBody) return;
        
        // Determine a more user-friendly error message based on the error type
        let userMessage = errorMessage;
        let actionButtons = '';
        
        switch (errorType) {
          case 'auth':
            userMessage = 'Your session has expired. Please log in again to view profile details.';
            actionButtons = `
              <a href="/login.html" class="btn btn-primary mt-3">Log In</a>
              <button class="btn btn-secondary mt-3 ms-2" data-bs-dismiss="modal">Close</button>
            `;
            break;
            
          case 'network':
            userMessage = 'Network connection issue. Please check your internet connection and try again.';
            actionButtons = `
              <button class="btn btn-primary mt-3" onclick="location.reload()">Reload Page</button>
              <button class="btn btn-secondary mt-3 ms-2" data-bs-dismiss="modal">Close</button>
            `;
            break;
            
          case 'notFound':
            userMessage = 'Profile information not found. This user may have deleted their account or changed their privacy settings.';
            actionButtons = `
              <button class="btn btn-secondary mt-3" data-bs-dismiss="modal">Close</button>
            `;
            break;
            
          default: // general error
            actionButtons = `
              <button class="btn btn-primary mt-3" onclick="fetchUserProfile(currentProfileId)">Try Again</button>
              <button class="btn btn-secondary mt-3 ms-2" data-bs-dismiss="modal">Close</button>
            `;
        }
        
        modalBody.innerHTML = `
          <div class="text-center py-5">
            <div class="mb-4">
              <i class="ti ti-alert-triangle text-danger" style="font-size: 3rem;"></i>
            </div>
            <div class="alert alert-danger" role="alert">
              <h5 class="alert-heading">Error Loading Profile</h5>
              <p>${userMessage}</p>
            </div>
            <div class="mt-4">
              ${actionButtons}
            </div>
          </div>
        `;
        
        // Store the current profile ID for retry
        modalBody.setAttribute('data-profile-id', window.currentProfileId || '');
      }

      // Handle filter sidebar toggling based on screen size
      function setupFilterToggle() {
        const filterSidebar = document.getElementById('filterSidebar');
        const filterToggleBtn = document.getElementById('filterToggleBtn');
        const filterOverlay = document.getElementById('filterOverlay');
        
        if (!filterSidebar || !filterToggleBtn) {
          console.error("Filter elements not found");
          return;
        }
        
        // Function to check screen size and toggle filter accordingly
        function checkScreenSize() {
          const isMobile = window.innerWidth < 768;
          
          if (isMobile) { // mobile view
            // On mobile, collapse by default
            if (filterSidebar.classList.contains('show')) {
              // Use Bootstrap's collapse API if available
              if (typeof bootstrap !== 'undefined') {
                const bsCollapse = bootstrap.Collapse.getInstance(filterSidebar);
                if (bsCollapse) bsCollapse.hide();
              } else {
                filterSidebar.classList.remove('show');
              }
              
              if (filterOverlay) filterOverlay.classList.remove('active');
            }
            
            // Update toggle button text
            filterToggleBtn.innerHTML = '<i class="ti ti-menu-2"></i> <span>Show Filters</span>';
            filterToggleBtn.setAttribute('aria-expanded', 'false');
          } else {
            // On desktop, show by default
            if (!filterSidebar.classList.contains('show')) {
              // Use Bootstrap's collapse API if available
              if (typeof bootstrap !== 'undefined') {
                const bsCollapse = new bootstrap.Collapse(filterSidebar, {
                  toggle: false
                });
                bsCollapse.show();
              } else {
                filterSidebar.classList.add('show');
              }
            }
            
            // Hide overlay in desktop mode
            if (filterOverlay) filterOverlay.classList.remove('active');
            
            // Update toggle button text
            filterToggleBtn.innerHTML = '<i class="ti ti-filter"></i> <span>Filters</span>';
            filterToggleBtn.setAttribute('aria-expanded', 'true');
          }
        }
        
        // Initial check
        setTimeout(checkScreenSize, 100); // Slight delay to ensure DOM is ready
        
        // Add event listener for resize
        window.addEventListener('resize', checkScreenSize);
        
        // Toggle button click handler
        filterToggleBtn.addEventListener('click', function() {
          const isExpanded = filterToggleBtn.getAttribute('aria-expanded') === 'true';
          const isMobile = window.innerWidth < 768;
          
          // Update the button text based on collapse state
          if (isExpanded) {
            filterToggleBtn.innerHTML = '<i class="ti ti-menu-2"></i> <span>Show Filters</span>';
            if (filterOverlay) filterOverlay.classList.remove('active');
          } else {
            filterToggleBtn.innerHTML = '<i class="ti ti-x"></i> <span>Hide Filters</span>';
            if (filterOverlay && isMobile) filterOverlay.classList.add('active');
          }
          
          
        });
        
        // Close filter when clicking on overlay
        if (filterOverlay) {
          filterOverlay.addEventListener('click', function() {
            if (filterSidebar.classList.contains('show')) {
              // Use Bootstrap's collapse API if available
              if (typeof bootstrap !== 'undefined') {
                const bsCollapse = bootstrap.Collapse.getInstance(filterSidebar);
                if (bsCollapse) bsCollapse.hide();
              } else if (typeof $ !== 'undefined') {
                $(filterSidebar).collapse('hide');
              } else {
                filterSidebar.classList.remove('show');
              }
              
              // Update button state
              filterToggleBtn.innerHTML = '<i class="ti ti-menu-2"></i> <span>Show Filters</span>';
              filterToggleBtn.setAttribute('aria-expanded', 'false');
              
              // Hide overlay
              filterOverlay.classList.remove('active');
            }
          });
        }
      }

      // Debug function removed

      // Force fix for mobile filters
      function fixMobileFilter() {
        const filterSidebar = document.getElementById('filterSidebar');
        
        if (!filterSidebar) return;
        
        // Add specific styles to fix any display issues
        const style = document.createElement('style');
        style.textContent = `
          @media (max-width: 767.98px) {
            #filterSidebar {
              background-color: white !important;
              display: block !important;
              visibility: visible !important;
              height: 100vh !important;
              position: fixed !important;
              z-index: 1050 !important;
              opacity: 1 !important;
            }
            
            #filterSidebar:not(.show) {
              transform: translateX(-100%) !important;
            }
            
            #filterSidebar.show {
              transform: translateX(0) !important;
            }
          }
        `;
        document.head.appendChild(style);
      }

      // Show message when all profiles have been processed
      function showNoMoreProfilesMessage() {
        const profileCard = document.getElementById('current-profile');
        if (profileCard) {
          profileCard.innerHTML = `
            <div style="height: 100%; display: flex; align-items: center; justify-content: center; text-align: center; padding: 20px; background-color: white; border-radius: 15px;">
              <div>
                <h3>No More Profiles</h3>
                <p>You've viewed all available profiles that match your interests.</p>
                <button class="btn btn-primary mt-3" onclick="reloadProfiles()">Find More Matches</button>
              </div>
            </div>
          `;
        }
        
        const usersContainer = document.getElementById('all-users-container');
        if (usersContainer) {
          usersContainer.innerHTML = `
            <div class="col-12 text-center py-5">
              <div class="alert alert-info" role="alert">
                <h4 class="alert-heading">No More Profiles</h4>
                <p>You've viewed all profiles that match your interests.</p>
                <hr>
                <button class="btn btn-primary" onclick="reloadProfiles()">Find More Matches</button>
              </div>
            </div>
          `;
        }
      }

      // Reload profiles by fetching from the database again
      function reloadProfiles() {
        // Clear the profiles array
        window.profiles = [];
        window.currentProfileIndex = 0;
        
        // Show loading state
        const profileCard = document.getElementById('current-profile');
        if (profileCard) {
          profileCard.innerHTML = `
            <div style="height: 100%; display: flex; align-items: center; justify-content: center; text-align: center; padding: 20px; background-color: white; border-radius: 15px;">
              <div>
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-3">Finding new matches...</p>
              </div>
            </div>
          `;
        }
        
        // Fetch users again
        fetchUsersFromDB();
      }
      
      // Debug function removed
    </script>
    
    <!-- Theme Loader JS -->
    <script src="../js/theme-loader.js"></script>
    <script>
              // Initialize theme when DOM content is loaded
      document.addEventListener('DOMContentLoaded', function() {
        if (typeof initializeTheme === 'function') {
          initializeTheme();
        }
        
        // Initialize institution dropdown
        initInstitutionDropdown();
      });
      
      // Function to initialize institution dropdown with API data
      function initInstitutionDropdown() {
        const institutionInput = document.getElementById('institution-filter-input');
        const institutionHidden = document.getElementById('institution-filter');
        const institutionDropdownBtn = document.getElementById('institution-dropdown-btn');
        const institutionDropdownMenu = document.getElementById('institution-dropdown-menu');
        
        if (!institutionInput || !institutionHidden || !institutionDropdownMenu) {
          console.error('Institution elements not found');
          return;
        }
        
        // Global variable to store all institutions
        let allInstitutions = [];
        
        // Show loading state
        institutionDropdownMenu.innerHTML = '<li><span class="dropdown-item-text">Loading institutions...</span></li>';
        institutionInput.disabled = true;
        institutionDropdownBtn.disabled = true;
        
        // Sample institutions data for fallback - expanded list
        const fallbackInstitutions = [
          { _id: "inst1", name: "Harvard University" },
          { _id: "inst2", name: "Massachusetts Institute of Technology" },
          { _id: "inst3", name: "Stanford University" },
          { _id: "inst4", name: "University of California, Berkeley" },
          { _id: "inst5", name: "California Institute of Technology" },
          { _id: "inst6", name: "Princeton University" },
          { _id: "inst7", name: "Yale University" },
          { _id: "inst8", name: "Columbia University" },
          { _id: "inst9", name: "University of Chicago" },
          { _id: "inst10", name: "University of Michigan" },
          { _id: "inst11", name: "Cornell University" },
          { _id: "inst12", name: "University of Pennsylvania" },
          { _id: "inst13", name: "Johns Hopkins University" },
          { _id: "inst14", name: "Duke University" },
          { _id: "inst15", name: "Northwestern University" },
          { _id: "inst16", name: "Carnegie Mellon University" },
          { _id: "inst17", name: "New York University" },
          { _id: "inst18", name: "University of California, Los Angeles" },
          { _id: "inst19", name: "University of Texas at Austin" },
          { _id: "inst20", name: "University of Washington" },
          { _id: "inst21", name: "University of Illinois Urbana-Champaign" },
          { _id: "inst22", name: "Georgia Institute of Technology" },
          { _id: "inst23", name: "University of Wisconsin-Madison" },
          { _id: "inst24", name: "University of California, San Diego" },
          { _id: "inst25", name: "University of North Carolina at Chapel Hill" },
          { _id: "inst26", name: "Boston University" },
          { _id: "inst27", name: "Purdue University" },
          { _id: "inst28", name: "University of Florida" },
          { _id: "inst29", name: "Ohio State University" },
          { _id: "inst30", name: "Pennsylvania State University" }
        ];
        
        // Try to fetch from API first
        fetch('/api/institutions')
          .then(response => {
            if (!response.ok) {
              throw new Error(`HTTP error! Status: ${response.status}`);
            }
            return response.json();
          })
          .then(institutions => {
            
            allInstitutions = institutions;
            setupInstitutionDropdown();
          })
          .catch(error => {
            console.error('Error loading institutions from API:', error);
            
            allInstitutions = fallbackInstitutions;
            setupInstitutionDropdown();
          });
        
        function setupInstitutionDropdown() {
          // Enable the input and button
          institutionInput.disabled = false;
          institutionDropdownBtn.disabled = false;
          
          // Initial dropdown content
          filterInstitutions('');
          
          // Handle input changes to filter institutions
          institutionInput.addEventListener('input', function() {
            const query = this.value.trim().toLowerCase();
            filterInstitutions(query);
          });
          
          // Handle dropdown button click
          institutionDropdownBtn.addEventListener('click', function() {
            filterInstitutions(institutionInput.value.trim().toLowerCase());
          });
          
          // Handle institution selection
          institutionDropdownMenu.addEventListener('click', function(e) {
            const item = e.target.closest('.dropdown-item');
            if (item && item.dataset.id) {
              // Set the hidden input value
              institutionHidden.value = item.dataset.id;
              // Set the visible input text
              institutionInput.value = item.textContent.trim();
              // Hide the dropdown using Bootstrap's API
              if (typeof bootstrap !== 'undefined') {
                const dropdown = bootstrap.Dropdown.getInstance(institutionDropdownBtn);
                if (dropdown) {
                  dropdown.hide();
                }
              }
            }
          });
        }
        
        // Function to filter institutions and update dropdown
        function filterInstitutions(query) {
          let filteredInstitutions = [];
          
          if (query === '') {
            // Show all institutions if query is empty (limited to 20 for performance)
            filteredInstitutions = allInstitutions.slice(0, 20);
          } else {
            // Filter institutions by name containing the query
            filteredInstitutions = allInstitutions.filter(institution => 
              institution.name && institution.name.toLowerCase().includes(query)
            ).slice(0, 20); // Limit to 20 results for performance
          }
          
          // Sort by relevance (exact match first, then startsWith, then includes)
          filteredInstitutions.sort((a, b) => {
            const nameA = a.name.toLowerCase();
            const nameB = b.name.toLowerCase();
            
            // Exact match
            if (nameA === query) return -1;
            if (nameB === query) return 1;
            
            // Starts with query
            if (nameA.startsWith(query) && !nameB.startsWith(query)) return -1;
            if (nameB.startsWith(query) && !nameA.startsWith(query)) return 1;
            
            // Alphabetical order if both match equally
            return nameA.localeCompare(nameB);
          });
          
          // Update dropdown
          institutionDropdownMenu.innerHTML = '';
          
          if (filteredInstitutions.length === 0) {
            institutionDropdownMenu.innerHTML = '<li><span class="dropdown-item-text text-center">No matches found</span></li>';
          } else {
            filteredInstitutions.forEach(institution => {
              if (institution.name) {
                const item = document.createElement('li');
                const link = document.createElement('a');
                link.className = 'dropdown-item';
                link.href = '#';
                link.textContent = institution.name;
                link.dataset.id = institution._id;
                item.appendChild(link);
                institutionDropdownMenu.appendChild(item);
              }
            });
          }
        }
      }
    </script>
    
    <!-- Notifications Handler JS -->
    <script src="../assets/js/notifications-handler.js"></script>
    <script>
      // Initialize notifications when DOM is fully loaded
      document.addEventListener('DOMContentLoaded', function() {
        // Check if the initNotifications function is available
        if (typeof initNotifications === 'function') {
          // Call the initNotifications function from notifications-handler.js
          initNotifications();
        } else {
          console.warn('initNotifications function not found - notifications may not load properly');
        }
        
        // Force load notifications on page load after a small delay
        setTimeout(function() {
          if (typeof loadNotifications === 'function') {
            loadNotifications(true);
          }
        }, 1000);
      });
    </script>

    <!-- Filter Fields JS -->
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        // Small delay to ensure all elements are properly rendered
        setTimeout(function() {
          try {
            // Initialize major (area of study) dependent fields
            initMajorDependentFields();
            
            // Initialize state/city dependent fields
            initLocationFields();
            
            // Initialize multi-select fields
            initMultiSelectFields();
            
            // Initialize industry filter
            initIndustryFilter();
            
            // Initialize filter form
            initFilterForm();
          } catch (error) {
            console.error("Error initializing filter components:", error);
          }
        }, 100);
      });
      


      // Initialize major dependent fields (major type and major sub-category)
      function initMajorDependentFields() {
        const majorSelect = document.getElementById('major-filter');
        const majorTypeSelect = document.getElementById('major-type-filter');
        const majorSubInput = document.getElementById('major-sub-filter');
        const majorSubHidden = document.getElementById('major-sub-filter-hidden');
        const majorSubDropdown = majorSubInput ? majorSubInput.closest('.major-subcategory-container').querySelector('.major-subcategory-dropdown') : null;
        const customInputMessage = majorSubInput ? majorSubInput.closest('.major-subcategory-container').querySelector('.custom-input-message') : null;
        
        if (!majorSelect || !majorTypeSelect || !majorSubInput || !majorSubHidden || !majorSubDropdown) {
          console.error("Could not find major field elements:", {
            majorSelect: !!majorSelect,
            majorTypeSelect: !!majorTypeSelect,
            majorSubInput: !!majorSubInput,
            majorSubHidden: !!majorSubHidden,
            majorSubDropdown: !!majorSubDropdown
          });
          return;
        }
        
        
        
        // Technical majors for each area of study - simplified format for the custom dropdown
        const technicalMajors = {
          'Engineering': [
            {value: 'SOFTWARE', label: 'Software'},
            {value: 'MECH', label: 'Mech'},
            {value: 'CIVIL', label: 'Civil'},
            {value: 'ELECTRICAL', label: 'Electrical'},
            {value: 'CHEMICAL', label: 'Chemical'},
            {value: 'AERO', label: 'Aero'},
            {value: 'BIO_MED', label: 'Bio Med'},
            {value: 'COMPUTER', label: 'Computer'},
            {value: 'ENVIRONMENTAL', label: 'Environmental'},
            {value: 'ARCHITECTURAL', label: 'Architectural'}
          ],
          'Science': [
            {value: 'COMPUTER_SCIENCE', label: 'Computer Science'},
            {value: 'DATA_SCIENCE', label: 'Data Science'},
            {value: 'INFORMATION_TECHNOLOGY', label: 'Information Technology'},
            {value: 'PHYSICS', label: 'Physics'},
            {value: 'CHEMISTRY', label: 'Chemistry'},
            {value: 'MATHEMATICS', label: 'Mathematics'},
            {value: 'STATISTICS', label: 'Statistics'},
            {value: 'BIOINFORMATICS', label: 'Bioinformatics'}
          ],
          'Business': [
            {value: 'BUSINESS_ANALYTICS', label: 'Business Analytics'},
            {value: 'INFORMATION_SYSTEMS', label: 'Information Systems'},
            {value: 'SUPPLY_CHAIN', label: 'Supply Chain'},
            {value: 'FINANCE', label: 'Finance'},
            {value: 'FINTECH', label: 'FinTech'},
            {value: 'ECOMMERCE', label: 'E-commerce'},
            {value: 'DIGITAL_MARKETING', label: 'Digital Marketing'}
          ],
          'Arts': [
            {value: 'DIGITAL_MEDIA', label: 'Digital Media'},
            {value: 'WEB_DESIGN', label: 'Web Design'},
            {value: 'ANIMATION', label: 'Animation'},
            {value: 'GAME_DESIGN', label: 'Game Design'},
            {value: 'UI_UX_DESIGN', label: 'UI/UX Design'}
          ],
          'Other': [
            {value: 'CYBERSECURITY', label: 'Cybersecurity'},
            {value: 'NETWORK_ADMIN', label: 'Network Administration'},
            {value: 'TECHNICAL_EDUCATION', label: 'Technical Education'},
            {value: 'OTHER_TECHNICAL', label: 'Other Technical'}
          ]
        };
        
        // Non-technical majors for each area of study - simplified format for the custom dropdown
        const nonTechnicalMajors = {
          'Engineering': [
            {value: 'ENGINEERING_MANAGEMENT', label: 'Engineering Management'},
            {value: 'PRODUCT_MANAGEMENT', label: 'Product Management'},
            {value: 'PROJECT_MANAGEMENT', label: 'Project Management'},
            {value: 'QUALITY_ASSURANCE', label: 'Quality Assurance'},
            {value: 'OTHER_ENGINEERING', label: 'Other Engineering'}
          ],
          'Science': [
            {value: 'SCIENCE_COMMUNICATION', label: 'Science Communication'},
            {value: 'SCIENCE_EDUCATION', label: 'Science Education'},
            {value: 'ENVIRONMENTAL_POLICY', label: 'Environmental Policy'},
            {value: 'SCIENCE_MANAGEMENT', label: 'Science Management'},
            {value: 'OTHER_SCIENCE', label: 'Other Science'}
          ],
          'Business': [
            {value: 'MARKETING', label: 'Marketing'},
            {value: 'MANAGEMENT', label: 'Management'},
            {value: 'ENTREPRENEURSHIP', label: 'Entrepreneurship'},
            {value: 'HUMAN_RESOURCES', label: 'Human Resources'},
            {value: 'ACCOUNTING', label: 'Accounting'},
            {value: 'OTHER_BUSINESS', label: 'Other Business'}
          ],
          'Arts': [
            {value: 'FINE_ARTS', label: 'Fine Arts'},
            {value: 'LIBERAL_ARTS', label: 'Liberal Arts'},
            {value: 'ART_HISTORY', label: 'Art History'},
            {value: 'MUSIC', label: 'Music'},
            {value: 'THEATER', label: 'Theater'},
            {value: 'OTHER_ARTS', label: 'Other Arts'}
          ],
          'Other': [
            {value: 'EDUCATION', label: 'Education'},
            {value: 'PSYCHOLOGY', label: 'Psychology'},
            {value: 'SOCIOLOGY', label: 'Sociology'},
            {value: 'POLITICAL_SCIENCE', label: 'Political Science'},
            {value: 'COMMUNICATIONS', label: 'Communications'},
            {value: 'OTHER_NON_TECHNICAL', label: 'Other Non-Technical'}
          ]
        };
        
        // Initialize the major sub-category dropdown functionality
        function initCustomDropdown() {
          // Toggle dropdown when clicking the input
          majorSubInput.addEventListener('click', function() {
            // If input is disabled, don't do anything
            if (this.hasAttribute('disabled')) {
              return;
            }
            
            // Close any custom input state first
            if (this.hasAttribute('data-custom-input-active')) {
              exitCustomInputMode();
            }
            
            // Toggle dropdown visibility
            const isVisible = majorSubDropdown.style.display === 'block';
            majorSubDropdown.style.display = isVisible ? 'none' : 'block';
            
            // Reset active items when showing dropdown
            if (!isVisible) {
              resetActiveItems();
            }
          });
          
          // Close dropdown when clicking outside
          document.addEventListener('click', function(e) {
            if (!majorSubInput.contains(e.target) && !majorSubDropdown.contains(e.target)) {
              majorSubDropdown.style.display = 'none';
              
              // Also exit custom input mode if active
              if (majorSubInput.hasAttribute('data-custom-input-active')) {
                exitCustomInputMode();
              }
            }
          });
          
          // Handle "Type custom value" option
          const customOption = majorSubDropdown.querySelector('.major-subcategory-custom-option');
          if (customOption) {
            customOption.addEventListener('click', function() {
              enterCustomInputMode();
            });
          }
          
          // Handle keyboard navigation
          majorSubInput.addEventListener('keydown', function(e) {
            // Custom input mode
            if (this.hasAttribute('data-custom-input-active')) {
              if (e.key === 'Enter') {
                e.preventDefault();
                const customValue = this.value.trim();
                if (customValue) {
                  // Save the custom value
                  setMajorSubValue(customValue, customValue);
                  exitCustomInputMode();
                }
              } else if (e.key === 'Escape') {
                e.preventDefault();
                exitCustomInputMode();
              }
              return;
            }
            
            // Regular dropdown navigation
            if (e.key === 'ArrowDown') {
              e.preventDefault();
              
              // Show dropdown if not visible
              if (majorSubDropdown.style.display !== 'block') {
                majorSubDropdown.style.display = 'block';
                highlightFirstItem();
                return;
              }
              
              moveActiveItem(1);
            } else if (e.key === 'ArrowUp') {
              e.preventDefault();
              
              // Show dropdown if not visible
              if (majorSubDropdown.style.display !== 'block') {
                majorSubDropdown.style.display = 'block';
                highlightLastItem();
                return;
              }
              
              moveActiveItem(-1);
            } else if (e.key === 'Enter') {
              if (majorSubDropdown.style.display === 'block') {
                e.preventDefault();
                
                // Select active item or first item if none is active
                const activeItem = majorSubDropdown.querySelector('.major-subcategory-item.active');
                if (activeItem) {
                  // If it's the custom option, enter custom mode
                  if (activeItem.classList.contains('major-subcategory-custom-option')) {
                    enterCustomInputMode();
                  } else {
                    // Select the item
                    const value = activeItem.getAttribute('data-value');
                    const label = activeItem.textContent;
                    setMajorSubValue(value, label);
                    majorSubDropdown.style.display = 'none';
                  }
                } else {
                  // No active item, select first non-custom option
                  const firstItem = majorSubDropdown.querySelector('.major-subcategory-item:not(.major-subcategory-custom-option)');
                  if (firstItem) {
                    const value = firstItem.getAttribute('data-value');
                    const label = firstItem.textContent;
                    setMajorSubValue(value, label);
                    majorSubDropdown.style.display = 'none';
                  }
                }
              } else {
                // If dropdown is not visible, show it
                majorSubDropdown.style.display = 'block';
                resetActiveItems();
              }
            } else if (e.key === 'Escape') {
              e.preventDefault();
              majorSubDropdown.style.display = 'none';
            }
          });
        }
        
        // Reset active items in dropdown
        function resetActiveItems() {
          const items = majorSubDropdown.querySelectorAll('.major-subcategory-item');
          items.forEach(item => item.classList.remove('active'));
        }
        
        // Highlight the first item in the dropdown
        function highlightFirstItem() {
          resetActiveItems();
          const firstItem = majorSubDropdown.querySelector('.major-subcategory-item:not(.major-subcategory-custom-option)');
          if (firstItem) {
            firstItem.classList.add('active');
            firstItem.scrollIntoView({ block: 'nearest' });
          }
        }
        
        // Highlight the last item in the dropdown
        function highlightLastItem() {
          resetActiveItems();
          const items = majorSubDropdown.querySelectorAll('.major-subcategory-item:not(.major-subcategory-custom-option)');
          if (items.length > 0) {
            const lastItem = items[items.length - 1];
            lastItem.classList.add('active');
            lastItem.scrollIntoView({ block: 'nearest' });
          }
        }
        
        // Move the active item selection
        function moveActiveItem(direction) {
          const items = Array.from(majorSubDropdown.querySelectorAll('.major-subcategory-item'));
          const activeItem = majorSubDropdown.querySelector('.major-subcategory-item.active');
          
          if (!activeItem) {
            // If no item is active, highlight first or last based on direction
            if (direction > 0) {
              highlightFirstItem();
            } else {
              highlightLastItem();
            }
            return;
          }
          
          // Find current index
          const currentIndex = items.indexOf(activeItem);
          
          // Calculate new index
          let newIndex = currentIndex + direction;
          
          // Handle wrapping
          if (newIndex < 0) {
            newIndex = items.length - 1;
          } else if (newIndex >= items.length) {
            newIndex = 0;
          }
          
          // Update active item
          resetActiveItems();
          items[newIndex].classList.add('active');
          items[newIndex].scrollIntoView({ block: 'nearest' });
        }
        
        // Enter custom input mode
        function enterCustomInputMode() {
          // Make the input editable
          majorSubInput.removeAttribute('readonly');
          majorSubInput.setAttribute('data-custom-input-active', 'true');
          majorSubInput.value = '';
          majorSubInput.focus();
          
          // Hide dropdown and show custom input message
          majorSubDropdown.style.display = 'none';
          if (customInputMessage) {
            customInputMessage.style.display = 'block';
          }
          
          // Add a special class to indicate edit mode
          majorSubInput.classList.add('custom-input-active');
          
          // Add the container class to show we're in custom mode
          majorSubInput.closest('.major-subcategory-container').classList.add('custom-mode-active');
        }
        
        // Exit custom input mode
        function exitCustomInputMode() {
          // Make the input readonly again
          majorSubInput.setAttribute('readonly', '');
          majorSubInput.removeAttribute('data-custom-input-active');
          
          // Hide the custom input message
          if (customInputMessage) {
            customInputMessage.style.display = 'none';
          }
          
          // Remove the special class
          majorSubInput.classList.remove('custom-input-active');
          
          // Remove the container class
          majorSubInput.closest('.major-subcategory-container').classList.remove('custom-mode-active');
          
          // If the input is now empty, restore the placeholder
          if (!majorSubInput.value.trim()) {
            majorSubInput.setAttribute('placeholder', 'Select or type major sub-category');
          }
        }
        
        // Set a value for the major sub category field
        function setMajorSubValue(value, label) {
          majorSubInput.value = label;
          majorSubHidden.value = value;
          console.log(`Setting major sub-category: ${value} (${label})`);
        }
        
        // Handle option selection
        function setupOptionSelection() {
          // Use event delegation for handling option clicks
          majorSubDropdown.addEventListener('click', function(e) {
            const option = e.target.closest('.major-subcategory-item:not(.major-subcategory-custom-option)');
            if (option) {
              const value = option.getAttribute('data-value');
              const label = option.textContent;
              
              // Set the value and close dropdown
              setMajorSubValue(value, label);
              majorSubDropdown.style.display = 'none';
            }
          });
        }
        
        // Debug output current state 
        console.log("Initial major dropdown state:", {
          major: majorSelect.value,
          majorType: majorTypeSelect.value,
          majorSub: majorSubInput.value
        });

        // Update major sub-category options when major OR major type changes
        function updateMajorOptions() {
          const selectedMajor = majorSelect.value;
          const selectedType = majorTypeSelect.value;
          
          
          
          // Clear existing options (except the first two - custom option and divider)
          const customOption = majorSubDropdown.querySelector('.major-subcategory-custom-option');
          const divider = majorSubDropdown.querySelector('.major-subcategory-divider');
          
          majorSubDropdown.innerHTML = '';
          if (customOption && divider) {
            majorSubDropdown.appendChild(customOption);
            majorSubDropdown.appendChild(divider);
          }
          
          // Clear the input field
          majorSubInput.value = '';
          majorSubHidden.value = '';
          
          // Enable or disable the input based on whether area of study is selected
          if (!selectedMajor) {
            majorSubInput.setAttribute('disabled', 'disabled');
            majorSubInput.setAttribute('placeholder', 'First select Area of Study');
          } else {
            majorSubInput.removeAttribute('disabled');
            majorSubInput.setAttribute('placeholder', 'Select or type major sub-category');
          }
          
          // Only continue if both values are selected
          if (!selectedMajor || !selectedType) {
            return;
          }
          
          // Determine which list of majors to use
          const majorsToShow = selectedType === 'Technical' 
            ? technicalMajors[selectedMajor] 
            : nonTechnicalMajors[selectedMajor];
          
          // If we have majors for this combination, add them
          if (majorsToShow && Array.isArray(majorsToShow)) {
            majorsToShow.forEach(majorOption => {
              const item = document.createElement('div');
              item.className = 'major-subcategory-item';
              item.textContent = majorOption.label;
              item.setAttribute('data-value', majorOption.value);
              majorSubDropdown.appendChild(item);
            });
            console.log(`Added ${majorsToShow.length} ${selectedType.toLowerCase()} majors for ${selectedMajor}`);
            
            // Automatically show the dropdown when options change and there are valid options
            if (majorsToShow.length > 0 && document.activeElement === majorSelect || document.activeElement === majorTypeSelect) {
              // Small delay to allow the select focus to complete
              setTimeout(() => {
                majorSubInput.focus();
                majorSubDropdown.style.display = 'block';
              }, 100);
            }
          } else {
            console.log(`No majors found for ${selectedMajor} (${selectedType})`);
          }
        }
        
        // Initialize the custom dropdown
        initCustomDropdown();
        setupOptionSelection();
        
        // Add event listeners to both selects
        majorSelect.addEventListener('change', updateMajorOptions);
        majorTypeSelect.addEventListener('change', updateMajorOptions);
        
        // If both fields already have values (e.g., on page reload), update options
        if (majorSelect.value && majorTypeSelect.value) {
          updateMajorOptions();
        }
        
        
      }
      
      // Initialize location fields (state and city)
      function initLocationFields() {
        // Get state elements
        const stateInput = document.getElementById('state-filter-input');
        const stateHidden = document.getElementById('state-filter');
        const stateIdHidden = document.getElementById('state-id');
        const stateDropdownBtn = document.getElementById('state-dropdown-btn');
        const stateDropdownMenu = document.getElementById('state-dropdown-menu');
        
        // Get city elements
        const cityInput = document.getElementById('city-filter-input');
        const cityHidden = document.getElementById('city-filter');
        const cityDropdownBtn = document.getElementById('city-dropdown-btn');
        const cityDropdownMenu = document.getElementById('city-dropdown-menu');
        
        if (!stateInput || !stateHidden || !stateDropdownMenu || !cityInput || !cityHidden || !cityDropdownMenu) {
          console.error('Location field elements not found');
          return;
        }
        
        // Show loading state for states
        stateDropdownMenu.innerHTML = '<li><span class="dropdown-item-text">Loading states...</span></li>';
        stateInput.disabled = true;
        stateDropdownBtn.disabled = true;
        
        // Disable city input initially
        cityInput.disabled = true;
        cityDropdownBtn.disabled = true;
        
        // Global variables to store states and cities
        let allStates = [];
        let allCities = [];
        let selectedStateId = '';
        let selectedStateCode = '';
        
        // Fallback US states data
        const fallbackStates = [
          { _id: "state1", code: "AL", name: "Alabama" },
          { _id: "state2", code: "AK", name: "Alaska" },
          { _id: "state3", code: "AZ", name: "Arizona" },
          { _id: "state4", code: "AR", name: "Arkansas" },
          { _id: "state5", code: "CA", name: "California" },
          { _id: "state6", code: "CO", name: "Colorado" },
          { _id: "state7", code: "CT", name: "Connecticut" },
          { _id: "state8", code: "DE", name: "Delaware" },
          { _id: "state9", code: "FL", name: "Florida" },
          { _id: "state10", code: "GA", name: "Georgia" },
          { _id: "state11", code: "HI", name: "Hawaii" },
          { _id: "state12", code: "ID", name: "Idaho" },
          { _id: "state13", code: "IL", name: "Illinois" },
          { _id: "state14", code: "IN", name: "Indiana" },
          { _id: "state15", code: "IA", name: "Iowa" },
          { _id: "state16", code: "KS", name: "Kansas" },
          { _id: "state17", code: "KY", name: "Kentucky" },
          { _id: "state18", code: "LA", name: "Louisiana" },
          { _id: "state19", code: "ME", name: "Maine" },
          { _id: "state20", code: "MD", name: "Maryland" },
          { _id: "state21", code: "MA", name: "Massachusetts" },
          { _id: "state22", code: "MI", name: "Michigan" },
          { _id: "state23", code: "MN", name: "Minnesota" },
          { _id: "state24", code: "MS", name: "Mississippi" },
          { _id: "state25", code: "MO", name: "Missouri" },
          { _id: "state26", code: "MT", name: "Montana" },
          { _id: "state27", code: "NE", name: "Nebraska" },
          { _id: "state28", code: "NV", name: "Nevada" },
          { _id: "state29", code: "NH", name: "New Hampshire" },
          { _id: "state30", code: "NJ", name: "New Jersey" },
          { _id: "state31", code: "NM", name: "New Mexico" },
          { _id: "state32", code: "NY", name: "New York" },
          { _id: "state33", code: "NC", name: "North Carolina" },
          { _id: "state34", code: "ND", name: "North Dakota" },
          { _id: "state35", code: "OH", name: "Ohio" },
          { _id: "state36", code: "OK", name: "Oklahoma" },
          { _id: "state37", code: "OR", name: "Oregon" },
          { _id: "state38", code: "PA", name: "Pennsylvania" },
          { _id: "state39", code: "RI", name: "Rhode Island" },
          { _id: "state40", code: "SC", name: "South Carolina" },
          { _id: "state41", code: "SD", name: "South Dakota" },
          { _id: "state42", code: "TN", name: "Tennessee" },
          { _id: "state43", code: "TX", name: "Texas" },
          { _id: "state44", code: "UT", name: "Utah" },
          { _id: "state45", code: "VT", name: "Vermont" },
          { _id: "state46", code: "VA", name: "Virginia" },
          { _id: "state47", code: "WA", name: "Washington" },
          { _id: "state48", code: "WV", name: "West Virginia" },
          { _id: "state49", code: "WI", name: "Wisconsin" },
          { _id: "state50", code: "WY", name: "Wyoming" }
        ];
        
        // Fallback cities data by state
        const fallbackCities = {
          "CA": [
            { name: "Los Angeles" },
            { name: "San Francisco" },
            { name: "San Diego" },
            { name: "Sacramento" },
            { name: "Oakland" },
            { name: "San Jose" },
            { name: "Fresno" },
            { name: "Long Beach" },
            { name: "Bakersfield" },
            { name: "Anaheim" },
            { name: "Riverside" },
            { name: "Santa Ana" },
            { name: "Stockton" },
            { name: "Irvine" },
            { name: "Fremont" },
            { name: "San Bernardino" },
            { name: "Modesto" },
            { name: "Fontana" },
            { name: "Oxnard" },
            { name: "Moreno Valley" },
            { name: "Huntington Beach" },
            { name: "Glendale" },
            { name: "Santa Clarita" },
            { name: "Garden Grove" },
            { name: "Oceanside" },
            { name: "Santa Rosa" },
            { name: "Rancho Cucamonga" },
            { name: "Ontario" },
            { name: "Lancaster" },
            { name: "Palmdale" }
          ],
          "NY": [
            { name: "New York City" },
            { name: "Buffalo" },
            { name: "Rochester" },
            { name: "Syracuse" },
            { name: "Albany" },
            { name: "Yonkers" },
            { name: "Utica" },
            { name: "Binghamton" },
            { name: "Schenectady" },
            { name: "Troy" },
            { name: "Niagara Falls" },
            { name: "Mount Vernon" },
            { name: "New Rochelle" },
            { name: "White Plains" },
            { name: "Ithaca" },
            { name: "Poughkeepsie" },
            { name: "Jamestown" },
            { name: "Elmira" },
            { name: "Watertown" },
            { name: "Kingston" },
            { name: "Plattsburgh" },
            { name: "Saratoga Springs" },
            { name: "Newburgh" },
            { name: "Middletown" },
            { name: "Auburn" }
          ],
          "TX": [
            { name: "Houston" },
            { name: "Austin" },
            { name: "Dallas" },
            { name: "San Antonio" },
            { name: "Fort Worth" },
            { name: "El Paso" },
            { name: "Arlington" },
            { name: "Corpus Christi" },
            { name: "Plano" },
            { name: "Lubbock" },
            { name: "Irving" },
            { name: "Laredo" },
            { name: "Garland" },
            { name: "Frisco" },
            { name: "McKinney" },
            { name: "Amarillo" },
            { name: "Grand Prairie" },
            { name: "Brownsville" },
            { name: "Killeen" },
            { name: "Pasadena" },
            { name: "Mesquite" },
            { name: "McAllen" },
            { name: "Denton" },
            { name: "Waco" },
            { name: "Carrollton" }
          ],
          "FL": [
            { name: "Miami" },
            { name: "Orlando" },
            { name: "Tampa" },
            { name: "Jacksonville" },
            { name: "Tallahassee" },
            { name: "Fort Lauderdale" },
            { name: "St. Petersburg" },
            { name: "Hialeah" },
            { name: "Port St. Lucie" },
            { name: "Cape Coral" },
            { name: "Pembroke Pines" },
            { name: "Hollywood" },
            { name: "Miramar" },
            { name: "Gainesville" },
            { name: "Coral Springs" },
            { name: "Clearwater" },
            { name: "Palm Bay" },
            { name: "West Palm Beach" },
            { name: "Lakeland" },
            { name: "Pompano Beach" },
            { name: "Miami Gardens" },
            { name: "Davie" },
            { name: "Boca Raton" },
            { name: "Sunrise" },
            { name: "Deltona" }
          ],
          "IL": [
            { name: "Chicago" },
            { name: "Springfield" },
            { name: "Peoria" },
            { name: "Naperville" },
            { name: "Rockford" },
            { name: "Joliet" },
            { name: "Aurora" },
            { name: "Elgin" },
            { name: "Waukegan" },
            { name: "Cicero" },
            { name: "Champaign" },
            { name: "Bloomington" },
            { name: "Decatur" },
            { name: "Evanston" },
            { name: "Schaumburg" },
            { name: "Skokie" },
            { name: "Arlington Heights" },
            { name: "Bolingbrook" },
            { name: "Palatine" },
            { name: "Wheaton" }
          ],
          "PA": [
            { name: "Philadelphia" },
            { name: "Pittsburgh" },
            { name: "Allentown" },
            { name: "Erie" },
            { name: "Reading" },
            { name: "Scranton" },
            { name: "Bethlehem" },
            { name: "Lancaster" },
            { name: "Harrisburg" },
            { name: "Wilkes-Barre" },
            { name: "York" },
            { name: "State College" },
            { name: "Altoona" },
            { name: "Chester" },
            { name: "Williamsport" }
          ],
          "OH": [
            { name: "Columbus" },
            { name: "Cleveland" },
            { name: "Cincinnati" },
            { name: "Toledo" },
            { name: "Akron" },
            { name: "Dayton" },
            { name: "Parma" },
            { name: "Canton" },
            { name: "Youngstown" },
            { name: "Lorain" },
            { name: "Hamilton" },
            { name: "Springfield" },
            { name: "Kettering" },
            { name: "Elyria" },
            { name: "Lakewood" }
          ],
          "MI": [
            { name: "Detroit" },
            { name: "Grand Rapids" },
            { name: "Warren" },
            { name: "Sterling Heights" },
            { name: "Ann Arbor" },
            { name: "Lansing" },
            { name: "Flint" },
            { name: "Dearborn" },
            { name: "Livonia" },
            { name: "Westland" },
            { name: "Troy" },
            { name: "Farmington Hills" },
            { name: "Kalamazoo" },
            { name: "Wyoming" },
            { name: "Southfield" }
          ],
          "GA": [
            { name: "Atlanta" },
            { name: "Augusta" },
            { name: "Columbus" },
            { name: "Savannah" },
            { name: "Athens" },
            { name: "Sandy Springs" },
            { name: "Roswell" },
            { name: "Macon" },
            { name: "Johns Creek" },
            { name: "Albany" },
            { name: "Warner Robins" },
            { name: "Alpharetta" },
            { name: "Marietta" },
            { name: "Valdosta" },
            { name: "Smyrna" }
          ],
          "NC": [
            { name: "Charlotte" },
            { name: "Raleigh" },
            { name: "Greensboro" },
            { name: "Durham" },
            { name: "Winston-Salem" },
            { name: "Fayetteville" },
            { name: "Cary" },
            { name: "Wilmington" },
            { name: "High Point" },
            { name: "Concord" },
            { name: "Greenville" },
            { name: "Asheville" },
            { name: "Gastonia" },
            { name: "Jacksonville" },
            { name: "Chapel Hill" }
          ],
          "NJ": [
            { name: "Newark" },
            { name: "Jersey City" },
            { name: "Paterson" },
            { name: "Elizabeth" },
            { name: "Trenton" },
            { name: "Clifton" },
            { name: "Camden" },
            { name: "Passaic" },
            { name: "Union City" },
            { name: "East Orange" },
            { name: "Hoboken" },
            { name: "West New York" },
            { name: "Bayonne" },
            { name: "Vineland" },
            { name: "New Brunswick" }
          ],
          "VA": [
            { name: "Virginia Beach" },
            { name: "Norfolk" },
            { name: "Chesapeake" },
            { name: "Richmond" },
            { name: "Newport News" },
            { name: "Alexandria" },
            { name: "Hampton" },
            { name: "Roanoke" },
            { name: "Portsmouth" },
            { name: "Suffolk" },
            { name: "Lynchburg" },
            { name: "Harrisonburg" },
            { name: "Leesburg" },
            { name: "Charlottesville" },
            { name: "Danville" }
          ],
          "WA": [
            { name: "Seattle" },
            { name: "Spokane" },
            { name: "Tacoma" },
            { name: "Vancouver" },
            { name: "Bellevue" },
            { name: "Kent" },
            { name: "Everett" },
            { name: "Renton" },
            { name: "Yakima" },
            { name: "Federal Way" },
            { name: "Spokane Valley" },
            { name: "Bellingham" },
            { name: "Kennewick" },
            { name: "Auburn" },
            { name: "Pasco" }
          ],
          "MA": [
            { name: "Boston" },
            { name: "Worcester" },
            { name: "Springfield" },
            { name: "Lowell" },
            { name: "Cambridge" },
            { name: "New Bedford" },
            { name: "Brockton" },
            { name: "Quincy" },
            { name: "Lynn" },
            { name: "Fall River" },
            { name: "Newton" },
            { name: "Lawrence" },
            { name: "Somerville" },
            { name: "Framingham" },
            { name: "Haverhill" }
          ],
          "AZ": [
            { name: "Phoenix" },
            { name: "Tucson" },
            { name: "Mesa" },
            { name: "Chandler" },
            { name: "Scottsdale" },
            { name: "Glendale" },
            { name: "Gilbert" },
            { name: "Tempe" },
            { name: "Peoria" },
            { name: "Surprise" },
            { name: "Yuma" },
            { name: "Avondale" },
            { name: "Goodyear" },
            { name: "Flagstaff" },
            { name: "Buckeye" }
          ],
          "IN": [
            { name: "Indianapolis" },
            { name: "Fort Wayne" },
            { name: "Evansville" },
            { name: "South Bend" },
            { name: "Carmel" },
            { name: "Bloomington" },
            { name: "Fishers" },
            { name: "Hammond" },
            { name: "Gary" },
            { name: "Muncie" },
            { name: "Lafayette" },
            { name: "Terre Haute" },
            { name: "Kokomo" },
            { name: "Anderson" },
            { name: "Noblesville" }
          ],
          "TN": [
            { name: "Nashville" },
            { name: "Memphis" },
            { name: "Knoxville" },
            { name: "Chattanooga" },
            { name: "Clarksville" },
            { name: "Murfreesboro" },
            { name: "Franklin" },
            { name: "Jackson" },
            { name: "Johnson City" },
            { name: "Hendersonville" },
            { name: "Kingsport" },
            { name: "Collierville" },
            { name: "Smyrna" },
            { name: "Brentwood" },
            { name: "Cleveland" }
          ],
          "MO": [
            { name: "Kansas City" },
            { name: "St. Louis" },
            { name: "Springfield" },
            { name: "Columbia" },
            { name: "Independence" },
            { name: "Lee's Summit" },
            { name: "O'Fallon" },
            { name: "St. Joseph" },
            { name: "St. Charles" },
            { name: "Blue Springs" },
            { name: "Joplin" },
            { name: "Florissant" },
            { name: "Chesterfield" },
            { name: "Jefferson City" },
            { name: "Cape Girardeau" }
          ],
          "MD": [
            { name: "Baltimore" },
            { name: "Frederick" },
            { name: "Rockville" },
            { name: "Gaithersburg" },
            { name: "Bowie" },
            { name: "Hagerstown" },
            { name: "Annapolis" },
            { name: "College Park" },
            { name: "Salisbury" },
            { name: "Laurel" },
            { name: "Greenbelt" },
            { name: "Cumberland" },
            { name: "Westminster" },
            { name: "Hyattsville" },
            { name: "Takoma Park" }
          ],
          "WI": [
            { name: "Milwaukee" },
            { name: "Madison" },
            { name: "Green Bay" },
            { name: "Kenosha" },
            { name: "Racine" },
            { name: "Appleton" },
            { name: "Waukesha" },
            { name: "Eau Claire" },
            { name: "Oshkosh" },
            { name: "Janesville" },
            { name: "West Allis" },
            { name: "La Crosse" },
            { name: "Sheboygan" },
            { name: "Wauwatosa" },
            { name: "Fond du Lac" }
          ],
          "CO": [
            { name: "Denver" },
            { name: "Colorado Springs" },
            { name: "Aurora" },
            { name: "Fort Collins" },
            { name: "Lakewood" },
            { name: "Thornton" },
            { name: "Arvada" },
            { name: "Westminster" },
            { name: "Pueblo" },
            { name: "Centennial" },
            { name: "Boulder" },
            { name: "Greeley" },
            { name: "Longmont" },
            { name: "Loveland" },
            { name: "Grand Junction" }
          ]
        };
        
        // For each state code, ensure we have city data
        Object.keys(fallbackStates).forEach(i => {
          const state = fallbackStates[i];
          if (state.code && !fallbackCities[state.code]) {
            // For states without specific city data, add 10 common city patterns
            fallbackCities[state.code] = [
              { name: `${state.name} City` },
              { name: `Capital City` },
              { name: `${state.name} Springs` },
              { name: `North ${state.name}` },
              { name: `South ${state.name}` },
              { name: `${state.name} Beach` },
              { name: `${state.name} Heights` },
              { name: `${state.name} Valley` },
              { name: `${state.name} Park` },
              { name: `Lake ${state.name}` },
              { name: `${state.name} Junction` },
              { name: `${state.name} Hills` },
              { name: `West ${state.name}` },
              { name: `East ${state.name}` },
              { name: `${state.name}ville` },
              { name: `${state.name} Falls` },
              { name: `${state.name} Creek` },
              { name: `${state.name} Center` },
              { name: `${state.name} Point` },
              { name: `${state.name} View` }
            ];
          }
        });
        
        // Try to fetch states from API first
        fetch('/api/location/states')
          .then(response => {
            if (!response.ok) {
              throw new Error(`HTTP error! Status: ${response.status}`);
            }
            return response.json();
          })
          .then(states => {
            
            allStates = states;
            setupStateDropdown();
          })
          .catch(error => {
            console.error('Error loading states from API:', error);
            
            allStates = fallbackStates;
            setupStateDropdown();
          });
        
        // Setup the state dropdown functionality
        function setupStateDropdown() {
          // Enable state input and button
          stateInput.disabled = false;
          stateDropdownBtn.disabled = false;
          
          // Initial state dropdown content
          filterStates('');
          
          // Handle state input changes to filter states
          stateInput.addEventListener('input', function() {
            const query = this.value.trim().toLowerCase();
            filterStates(query);
          });
          
          // Handle state dropdown button click
          stateDropdownBtn.addEventListener('click', function() {
            filterStates(stateInput.value.trim().toLowerCase());
          });
          
          // Handle state selection
          stateDropdownMenu.addEventListener('click', function(e) {
            const item = e.target.closest('.dropdown-item');
            if (item && item.dataset.id) {
              // Save the state ID and code
              selectedStateId = item.dataset.id;
              selectedStateCode = item.dataset.code || '';
              
              // Set the hidden inputs
              stateHidden.value = item.dataset.code || item.textContent.trim();
              stateIdHidden.value = selectedStateId;
              
              // Set the visible input text
              stateInput.value = item.textContent.trim();
              
              // Hide the dropdown using Bootstrap's API if available
              if (typeof bootstrap !== 'undefined') {
                const dropdown = bootstrap.Dropdown.getInstance(stateDropdownBtn);
                if (dropdown) {
                  dropdown.hide();
                }
              }
              
              // Load cities for this state
              loadCities(selectedStateId, selectedStateCode);
            }
          });
        }
        
        // Function to filter states and update dropdown
        function filterStates(query) {
          let filteredStates = [];
          
          if (query === '') {
            // Show all states if query is empty
            filteredStates = allStates;
          } else {
            // Filter states by name containing the query
            filteredStates = allStates.filter(state => 
              state.name && state.name.toLowerCase().includes(query)
            );
          }
          
          // Sort by relevance
          filteredStates.sort((a, b) => {
            const nameA = a.name.toLowerCase();
            const nameB = b.name.toLowerCase();
            
            // Exact match
            if (nameA === query) return -1;
            if (nameB === query) return 1;
            
            // Starts with query
            if (nameA.startsWith(query) && !nameB.startsWith(query)) return -1;
            if (nameB.startsWith(query) && !nameA.startsWith(query)) return 1;
            
            // Alphabetical order
            return nameA.localeCompare(nameB);
          });
          
          // Update state dropdown
          stateDropdownMenu.innerHTML = '';
          
          if (filteredStates.length === 0) {
            stateDropdownMenu.innerHTML = '<li><span class="dropdown-item-text text-center">No matches found</span></li>';
          } else {
            filteredStates.forEach(state => {
              if (state.name) {
                const item = document.createElement('li');
                const link = document.createElement('a');
                link.className = 'dropdown-item';
                link.href = '#';
                link.textContent = state.name;
                link.dataset.id = state._id;
                if (state.code) link.dataset.code = state.code;
                item.appendChild(link);
                stateDropdownMenu.appendChild(item);
              }
            });
          }
        }
        
        // Function to load cities for a state
        function loadCities(stateId, stateCode) {
          // Reset and show loading state
          cityDropdownMenu.innerHTML = '<li><span class="dropdown-item-text">Loading cities...</span></li>';
          cityInput.value = '';
          cityHidden.value = '';
          cityInput.disabled = true;
          cityDropdownBtn.disabled = true;
          
          if (!stateId) {
            cityDropdownMenu.innerHTML = '<li><span class="dropdown-item-text">Select a state first</span></li>';
            return;
          }
          
          // Try to fetch cities from API
          fetch(`/api/location/cities?state_id=${stateId}`)
            .then(response => {
              if (!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status}`);
              }
              return response.json();
            })
            .then(cities => {
              
              
              // If API returns empty array or very few cities, supplement with fallback data
              if (!cities || cities.length < 5) {
                
                const fallbackForState = fallbackCities[stateCode] || [];
                
                // Combine API cities with fallback cities, removing duplicates
                const cityNames = new Set(cities.map(city => city.name));
                const combinedCities = [...cities];
                
                fallbackForState.forEach(city => {
                  if (!cityNames.has(city.name)) {
                    combinedCities.push(city);
                    cityNames.add(city.name);
                  }
                });
                
                allCities = combinedCities;
                
              } else {
                allCities = cities;
              }
              
              setupCityDropdown();
            })
            .catch(error => {
              console.error(`Error loading cities from API for state ${stateId}:`, error);
              
              
              // Use fallback cities if available for this state
              allCities = fallbackCities[stateCode] || [];
              
              setupCityDropdown();
            });
        }
        
        // Setup city dropdown functionality
        function setupCityDropdown() {
          // Enable city input and button
          cityInput.disabled = false;
          cityDropdownBtn.disabled = false;
          
          // Initial city dropdown content
          filterCities('');
          
          // Handle city input changes
          cityInput.addEventListener('input', function() {
            const query = this.value.trim().toLowerCase();
            filterCities(query);
          });
          
          // Handle city dropdown button click
          cityDropdownBtn.addEventListener('click', function() {
            filterCities(cityInput.value.trim().toLowerCase());
          });
          
          // Handle city selection
          cityDropdownMenu.addEventListener('click', function(e) {
            const item = e.target.closest('.dropdown-item');
            if (item && item.textContent) {
              // Set the hidden input
              cityHidden.value = item.textContent.trim();
              
              // Set the visible input
              cityInput.value = item.textContent.trim();
              
              // Hide dropdown if Bootstrap is available
              if (typeof bootstrap !== 'undefined') {
                const dropdown = bootstrap.Dropdown.getInstance(cityDropdownBtn);
                if (dropdown) {
                  dropdown.hide();
                }
              }
            }
          });
        }
        
        // Function to filter cities and update dropdown
        function filterCities(query) {
          let filteredCities = [];
          
          if (query === '') {
            // Show more cities when empty query (50 max for better coverage)
            filteredCities = allCities.slice(0, 50);
          } else {
            // Filter cities by name containing the query
            filteredCities = allCities.filter(city => 
              city.name && city.name.toLowerCase().includes(query)
            ).slice(0, 30);
          }
          
          // Sort by relevance
          filteredCities.sort((a, b) => {
            const nameA = a.name.toLowerCase();
            const nameB = b.name.toLowerCase();
            
            // Exact match
            if (nameA === query) return -1;
            if (nameB === query) return 1;
            
            // Starts with query
            if (nameA.startsWith(query) && !nameB.startsWith(query)) return -1;
            if (nameB.startsWith(query) && !nameA.startsWith(query)) return 1;
            
            // Alphabetical order
            return nameA.localeCompare(nameB);
          });
          
          // Update city dropdown
          cityDropdownMenu.innerHTML = '';
          
          if (filteredCities.length === 0) {
            cityDropdownMenu.innerHTML = '<li><span class="dropdown-item-text text-center">No matches found</span></li>';
          } else {
            // First add a header with count
            const headerItem = document.createElement('li');
            headerItem.innerHTML = `<span class="dropdown-item-text text-muted small">Showing ${filteredCities.length} of ${allCities.length} cities</span>`;
            if (query) {
              headerItem.innerHTML = `<span class="dropdown-item-text text-muted small">Showing ${filteredCities.length} matches for "${query}"</span>`;
            }
            cityDropdownMenu.appendChild(headerItem);
            
            // Add a divider
            const dividerItem = document.createElement('li');
            dividerItem.innerHTML = '<hr class="dropdown-divider">';
            cityDropdownMenu.appendChild(dividerItem);
            
            // Add all city options
            filteredCities.forEach(city => {
              if (city.name) {
                const item = document.createElement('li');
                const link = document.createElement('a');
                link.className = 'dropdown-item';
                link.href = '#';
                link.textContent = city.name;
                
                // Highlight matches if there's a query
                if (query && city.name.toLowerCase().includes(query.toLowerCase())) {
                  const startIndex = city.name.toLowerCase().indexOf(query.toLowerCase());
                  const endIndex = startIndex + query.length;
                  const beforeMatch = city.name.substring(0, startIndex);
                  const match = city.name.substring(startIndex, endIndex);
                  const afterMatch = city.name.substring(endIndex);
                  link.innerHTML = `${beforeMatch}<strong class="text-primary">${match}</strong>${afterMatch}`;
                }
                
                item.appendChild(link);
                cityDropdownMenu.appendChild(item);
              }
            });
          }
        }
      }
      
      // Initialize industry filter
      function initIndustryFilter() {
        // Industry options - matches the options in profile.html
        // These are just suggestions - users can add any custom value they want
        const industryOptions = [
          "Marketing", "Agriculture Tech", "AI", "AR/VR", "Art", "Cosmetics", "BioTech",
          "Cannabis", "Communications", "Clean Tech", "Fashion", "Cloud", "Web3",
          "CyberSecurity", "Developer tools", "Digital health and wellness",
          "Future of health and work", "Commerce", "Edtech", "Electronics",
          "Entertainment", "Fintech", "Food and Beverage", "E-Sports", "Gov tech",
          "Recruiting", "Hospitality", "DEI", "Insure tech", "IOT", "Legal",
          "Logistics", "Manufacturing", "Marketplace", "Chemicals", "Media",
          "Consumer", "Enterprise", "Other tech", "Parenting",
          "Professional or Technical service", "Prop tech", "Quantum computing",
          "Food services", "Robotics", "Sales tech", "Sex", "Social impact",
          "Space", "Transportation", "Travel"
          // Note: We no longer hardcode custom values like "java" here
          // Instead, we allow users to enter any custom value they want
        ];
        
        const selectedIndustries = new Set();
        const input = document.getElementById('industry-input');
        const dropdown = document.getElementById('industry-dropdown');
        const tagsContainer = document.getElementById('industry-tags-container');
        const hiddenInput = document.getElementById('industry-hidden-input');
        
        if (!input || !dropdown || !tagsContainer || !hiddenInput) {
          console.error("Industry filter elements not found");
          return;
        }

        function updateHiddenInput() {
          hiddenInput.value = JSON.stringify(Array.from(selectedIndustries));
        }

        function renderDropdown() {
          dropdown.innerHTML = '';
          const inputValue = input.value.toLowerCase();
          const filtered = industryOptions.filter(opt => 
            opt.toLowerCase().includes(inputValue) && !selectedIndustries.has(opt)
          );

          if (filtered.length > 0 && inputValue) {
            dropdown.style.display = 'block';
            filtered.forEach(option => {
              const div = document.createElement('div');
              div.className = 'industry-option';
              div.textContent = option;
              div.onclick = () => {
                addTag(option);
                input.value = '';
                renderDropdown();
                input.focus();
              };
              dropdown.appendChild(div);
            });
          } else {
            dropdown.style.display = 'none';
          }
        }

        function addTag(value) {
          // Clean up the value by trimming whitespace
          const cleanValue = value.trim();
          
          // Don't add empty tags or duplicates
          if (!cleanValue || selectedIndustries.has(cleanValue)) return;
          
          // Add to selected industries and update the hidden input
          selectedIndustries.add(cleanValue);
          updateHiddenInput();
          
          // Create the visual tag element
          const tag = document.createElement('div');
          tag.className = 'industry-tag';
          tag.textContent = cleanValue;

          // Add the remove button
          const removeBtn = document.createElement('span');
          removeBtn.textContent = '×';
          removeBtn.className = 'remove-tag';
          removeBtn.onclick = (e) => {
            e.stopPropagation();
            selectedIndustries.delete(cleanValue);
            updateHiddenInput();
            tagsContainer.removeChild(tag);
            renderDropdown();
          };

          // Append the tag to the container
          tag.appendChild(removeBtn);
          tagsContainer.insertBefore(tag, input);
          
          // Log the added industry for debugging
          console.log(`Added industry filter: "${cleanValue}"`);
        }

        // Add event listeners
        input.addEventListener('input', () => {
          renderDropdown();
        });

        input.addEventListener('keydown', (e) => {
          // Add tag on Enter or comma key
          if (e.key === 'Enter' || e.key === ',') {
            e.preventDefault();
            const customValue = input.value.trim();
            if (customValue) {
              // Clean custom value before adding
              // This is important for consistent formatting and avoiding duplicates
              const cleanedValue = customValue
                .replace(/^[,\s]+|[,\s]+$/g, '')  // Remove leading/trailing commas and spaces
                .replace(/\s{2,}/g, ' ');         // Convert multiple spaces to single space
              
              if (cleanedValue) {
                console.log('Adding custom industry value:', cleanedValue);
                addTag(cleanedValue);
                input.value = '';
                renderDropdown();
              }
            }
          } 
          // Remove the last tag on Backspace when input is empty
          else if (e.key === 'Backspace' && input.value === '') {
            const tags = tagsContainer.getElementsByClassName('industry-tag');
            if (tags.length > 0) {
              const lastTag = tags[tags.length - 1];
              const value = lastTag.textContent.slice(0, -1); // Remove × character
              selectedIndustries.delete(value);
              updateHiddenInput();
              tagsContainer.removeChild(lastTag);
            }
          }
          // If Tab pressed and dropdown has options, select the first one
          else if (e.key === 'Tab' && dropdown.style.display === 'block') {
            const firstOption = dropdown.querySelector('.industry-option');
            if (firstOption) {
              e.preventDefault(); // Prevent moving to next form field
              addTag(firstOption.textContent);
              input.value = '';
              renderDropdown();
            }
          }
        });

        document.addEventListener('click', (e) => {
          if (!document.getElementById('industry-multi-select').contains(e.target)) {
            dropdown.style.display = 'none';
          }
        });

        // Initialize dropdown
        renderDropdown();
      }
      
      // Initialize multi-select fields (industry, technical skills, soft skills)
      function initMultiSelectFields() {
        // Industry options
        const industryOptions = [
          'Agriculture Tech', 'AI', 'AR/VR', 'Art', 'Automotive', 
          'BioTech', 'Cannabis', 'Clean Tech', 'Communications', 'Construction', 
          'Cosmetics', 'Crypto', 'Dating', 'E-Commerce', 'Education',
          'Energy', 'Entertainment', 'Fashion', 'Fintech', 'Food & Beverage',
          'Gaming', 'Healthcare', 'HR Tech', 'Insurance', 'IoT',
          'Legal', 'Manufacturing', 'Marketing', 'Music', 'Pets',
          'Real Estate', 'Retail', 'Robotics', 'Security', 'Sports',
          'Transportation', 'Travel'
        ];
        
        // Technical skills options
        const technicalSkillsOptions = [
          'JavaScript', 'Python', 'Java', 'C++', 'React', 
          'Angular', 'Vue.js', 'Node.js', 'Express', 'Django',
          'Flask', 'Spring Boot', 'Ruby on Rails', 'PHP', 'Laravel',
          'AWS', 'Azure', 'Google Cloud', 'Docker', 'Kubernetes',
          'Git', 'CI/CD', 'SQL', 'MongoDB', 'Redis',
          'Machine Learning', 'Data Analysis', 'TensorFlow', 'PyTorch', 'Computer Vision',
          'NLP', 'Blockchain', 'Mobile Development', 'iOS', 'Android',
          'Flutter', 'React Native', 'UI/UX Design', 'Figma', 'Adobe XD'
        ];
        
        // Soft skills options
        const softSkillsOptions = [
          'Communication', 'Leadership', 'Teamwork', 'Problem Solving', 'Critical Thinking',
          'Time Management', 'Adaptability', 'Creativity', 'Emotional Intelligence', 'Negotiation',
          'Conflict Resolution', 'Decision Making', 'Stress Management', 'Attention to Detail', 'Flexibility',
          'Cultural Awareness', 'Empathy', 'Active Listening', 'Persuasion', 'Networking',
          'Public Speaking', 'Mentoring', 'Self-Motivation', 'Work Ethic', 'Patience'
        ];
        
        // Initialize industry multi-select
        initMultiSelect(
          'industry-filter-input',
          'industry-filter-dropdown',
          'industry-filter-tags-container',
          'industry-filter-hidden-input',
          industryOptions
        );
        
        // Initialize technical skills multi-select
        initMultiSelect(
          'technical-skills-filter-input',
          'technical-skills-filter-dropdown',
          'technical-skills-filter-tags-container',
          'technical-skills-filter-hidden-input',
          technicalSkillsOptions
        );
        
        // Initialize soft skills multi-select
        initMultiSelect(
          'soft-skills-filter-input',
          'soft-skills-filter-dropdown',
          'soft-skills-filter-tags-container',
          'soft-skills-filter-hidden-input',
          softSkillsOptions
        );
      }
      
      // Helper function to initialize a multi-select field
      function initMultiSelect(inputId, dropdownId, tagsContainerId, hiddenInputId, options) {
        const input = document.getElementById(inputId);
        const dropdown = document.getElementById(dropdownId);
        const tagsContainer = document.getElementById(tagsContainerId);
        const hiddenInput = document.getElementById(hiddenInputId);
        
        if (!input || !dropdown || !tagsContainer || !hiddenInput) return;
        
        // Function to show dropdown with filtered options
        function showDropdown() {
          // Clear previous options
          dropdown.innerHTML = '';
          
          // Filter options based on input
          const filtered = options.filter(opt => 
            opt.toLowerCase().includes(input.value.toLowerCase()) &&
            !Array.from(tagsContainer.getElementsByClassName('industry-tag'))
              .some(tag => tag.getAttribute('data-value').toLowerCase() === opt.toLowerCase())
          );
          
          // Add filtered options to dropdown
          filtered.forEach(option => {
            const div = document.createElement('div');
            div.className = 'industry-option';
            div.textContent = option;
            div.addEventListener('click', () => {
              addTag(option);
              input.value = '';
              dropdown.style.display = 'none';
            });
            dropdown.appendChild(div);
          });
          
          // Show dropdown if we have options
          if (filtered.length > 0) {
            dropdown.style.display = 'block';
          } else {
            dropdown.style.display = 'none';
          }
        }
        
        // Function to add a tag
        function addTag(value) {
          // Check if tag already exists
          if (Array.from(tagsContainer.getElementsByClassName('industry-tag'))
            .some(tag => tag.getAttribute('data-value').toLowerCase() === value.toLowerCase())) {
            return;
          }
          
          const tag = document.createElement('div');
          tag.className = 'industry-tag';
          tag.setAttribute('data-value', value);
          tag.innerHTML = `
            ${value}
            <span class="remove-tag">&times;</span>
          `;
          
          // Add click handler to remove tag
          tag.querySelector('.remove-tag').addEventListener('click', () => {
            tag.remove();
            updateHiddenInput();
          });
          
          // Insert tag before the input
          tagsContainer.insertBefore(tag, input);
          updateHiddenInput();
        }
        
        // Function to update the hidden input with all selected values
        function updateHiddenInput() {
          const tags = Array.from(tagsContainer.getElementsByClassName('industry-tag'));
          const values = tags.map(tag => tag.getAttribute('data-value'));
          hiddenInput.value = values.join(',');
        }
        
        // Add event listeners
        input.addEventListener('focus', showDropdown);
        input.addEventListener('input', showDropdown);
        
        // Handle click outside to close dropdown
        document.addEventListener('click', (e) => {
          if (!document.getElementById(inputId).contains(e.target) &&
              !document.getElementById(dropdownId).contains(e.target)) {
            dropdown.style.display = 'none';
          }
        });
        
        // Handle enter key to add custom tag
        input.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' && input.value.trim()) {
            e.preventDefault();
            addTag(input.value.trim());
            input.value = '';
            dropdown.style.display = 'none';
          }
        });
      }
      
      // Initialize technical skills filter
      function initTechnicalSkillsFilter() {
        // Technical skills options - matches the options in profile.html
        // These are just suggestions - users can add any custom value they want
        const technicalSkillsOptions = [
          'JavaScript', 'Python', 'Java', 'C++', 'React', 
          'Angular', 'Vue.js', 'Node.js', 'Express', 'Django',
          'Flask', 'Spring Boot', 'Ruby on Rails', 'PHP', 'Laravel',
          'AWS', 'Azure', 'Google Cloud', 'Docker', 'Kubernetes',
          'Git', 'CI/CD', 'SQL', 'MongoDB', 'Redis',
          'Machine Learning', 'Data Analysis', 'TensorFlow', 'PyTorch', 'Computer Vision',
          'NLP', 'Blockchain', 'Mobile Development', 'iOS', 'Android',
          'Flutter', 'React Native', 'UI/UX Design', 'Figma', 'Adobe XD'
        ];
        
        const selectedSkills = new Set();
        const input = document.getElementById('technical-skills-input');
        const dropdown = document.getElementById('technical-skills-dropdown');
        const tagsContainer = document.getElementById('technical-skills-tags-container');
        const hiddenInput = document.getElementById('technical-skills-hidden-input');
        
        if (!input || !dropdown || !tagsContainer || !hiddenInput) {
          console.error("Technical skills filter elements not found");
          return;
        }

        function updateHiddenInput() {
          hiddenInput.value = JSON.stringify(Array.from(selectedSkills));
        }

        function renderDropdown() {
          dropdown.innerHTML = '';
          const inputValue = input.value.toLowerCase();
          const filtered = technicalSkillsOptions.filter(opt => 
            opt.toLowerCase().includes(inputValue) && !selectedSkills.has(opt)
          );

          if (filtered.length > 0 && inputValue) {
            dropdown.style.display = 'block';
            filtered.forEach(option => {
              const div = document.createElement('div');
              div.className = 'industry-option';
              div.textContent = option;
              div.onclick = () => {
                addTag(option);
                input.value = '';
                renderDropdown();
                input.focus();
              };
              dropdown.appendChild(div);
            });
          } else {
            dropdown.style.display = 'none';
          }
        }

        function addTag(value) {
          // Clean up the value by trimming whitespace
          const cleanValue = value.trim();
          
          // Don't add empty tags or duplicates
          if (!cleanValue || selectedSkills.has(cleanValue)) return;
          
          // Add to selected skills and update the hidden input
          selectedSkills.add(cleanValue);
          updateHiddenInput();
          
          // Create the visual tag element
          const tag = document.createElement('div');
          tag.className = 'industry-tag';
          tag.textContent = cleanValue;

          // Add the remove button
          const removeBtn = document.createElement('span');
          removeBtn.textContent = '×';
          removeBtn.className = 'remove-tag';
          removeBtn.onclick = (e) => {
            e.stopPropagation();
            selectedSkills.delete(cleanValue);
            updateHiddenInput();
            tagsContainer.removeChild(tag);
            renderDropdown();
          };

          // Append the tag to the container
          tag.appendChild(removeBtn);
          tagsContainer.insertBefore(tag, input);
          
          // Log the added skill for debugging
          console.log(`Added technical skill filter: "${cleanValue}"`);
        }

        // Add event listeners
        input.addEventListener('input', () => {
          renderDropdown();
        });

        input.addEventListener('keydown', (e) => {
          // Add tag on Enter or comma key
          if (e.key === 'Enter' || e.key === ',') {
            e.preventDefault();
            const customValue = input.value.trim();
            if (customValue) {
              // Clean custom value before adding
              const cleanedValue = customValue
                .replace(/^[,\s]+|[,\s]+$/g, '')  // Remove leading/trailing commas and spaces
                .replace(/\s{2,}/g, ' ');         // Convert multiple spaces to single space
              
              if (cleanedValue) {
                console.log('Adding custom technical skill value:', cleanedValue);
                addTag(cleanedValue);
                input.value = '';
                renderDropdown();
              }
            }
          } 
          // Remove the last tag on Backspace when input is empty
          else if (e.key === 'Backspace' && input.value === '') {
            const tags = tagsContainer.getElementsByClassName('industry-tag');
            if (tags.length > 0) {
              const lastTag = tags[tags.length - 1];
              const value = lastTag.textContent.slice(0, -1); // Remove × character
              selectedSkills.delete(value);
              updateHiddenInput();
              tagsContainer.removeChild(lastTag);
            }
          }
          // If Tab pressed and dropdown has options, select the first one
          else if (e.key === 'Tab' && dropdown.style.display === 'block') {
            const firstOption = dropdown.querySelector('.industry-option');
            if (firstOption) {
              e.preventDefault(); // Prevent moving to next form field
              addTag(firstOption.textContent);
              input.value = '';
              renderDropdown();
            }
          }
        });

        document.addEventListener('click', (e) => {
          if (!document.getElementById('technical-skills-multi-select').contains(e.target)) {
            dropdown.style.display = 'none';
          }
        });

        // Initialize dropdown
        renderDropdown();
      }
      
      // Initialize soft skills filter
      function initSoftSkillsFilter() {
        // Soft skills options - matches the options in profile.html
        // These are just suggestions - users can add any custom value they want
        const softSkillsOptions = [
          "Communication", "Written Communication", "Verbal Communication", "Active Listening", 
          "Public Speaking", "Analytical Skills", "Critical Thinking", "Decision-Making", 
          "Team Leadership", "Management", "Mentoring", "Collaboration", "Interpersonal Skills", 
          "Negotiation", "Flexibility", "Learning Agility", "Change Management", "Time Management", 
          "Planning", "Prioritization", "Client Relations", "Relationship Building", 
          "Conflict Resolution", "Persuasion", "Data Gathering", "Data Analysis", 
          "Data Interpretation", "Innovation", "Creativity", "Empathy", "Building Rapport", 
          "Foreign Language Skills", "Email Correspondence", "Presentation Skills", 
          "Emotional Intelligence", "Stress Management", "Accountability", "Patience", 
          "Cultural Awareness", "Initiative", "Dependability", "Work Ethic", 
          "Attention to Detail", "Open-Mindedness", "Self-Motivation", "Coaching", 
          "Delegation", "Multitasking", "Feedback Reception", "Diplomacy", "Professionalism"
        ];
        
        const selectedSkills = new Set();
        const input = document.getElementById('soft-skills-input');
        const dropdown = document.getElementById('soft-skills-dropdown');
        const tagsContainer = document.getElementById('soft-skills-tags-container');
        const hiddenInput = document.getElementById('soft-skills-hidden-input');
        
        if (!input || !dropdown || !tagsContainer || !hiddenInput) {
          console.error("Soft skills filter elements not found");
          return;
        }

        function updateHiddenInput() {
          hiddenInput.value = JSON.stringify(Array.from(selectedSkills));
        }

        function renderDropdown() {
          dropdown.innerHTML = '';
          const inputValue = input.value.toLowerCase();
          const filtered = softSkillsOptions.filter(opt => 
            opt.toLowerCase().includes(inputValue) && !selectedSkills.has(opt)
          );

          if (filtered.length > 0 && inputValue) {
            dropdown.style.display = 'block';
            filtered.forEach(option => {
              const div = document.createElement('div');
              div.className = 'industry-option';
              div.textContent = option;
              div.onclick = () => {
                addTag(option);
                input.value = '';
                renderDropdown();
                input.focus();
              };
              dropdown.appendChild(div);
            });
          } else {
            dropdown.style.display = 'none';
          }
        }

        function addTag(value) {
          // Clean up the value by trimming whitespace
          const cleanValue = value.trim();
          
          // Don't add empty tags or duplicates
          if (!cleanValue || selectedSkills.has(cleanValue)) return;
          
          // Add to selected skills and update the hidden input
          selectedSkills.add(cleanValue);
          updateHiddenInput();
          
          // Create the visual tag element
          const tag = document.createElement('div');
          tag.className = 'industry-tag';
          tag.textContent = cleanValue;

          // Add the remove button
          const removeBtn = document.createElement('span');
          removeBtn.textContent = '×';
          removeBtn.className = 'remove-tag';
          removeBtn.onclick = (e) => {
            e.stopPropagation();
            selectedSkills.delete(cleanValue);
            updateHiddenInput();
            tagsContainer.removeChild(tag);
            renderDropdown();
          };

          // Append the tag to the container
          tag.appendChild(removeBtn);
          tagsContainer.insertBefore(tag, input);
          
          // Log the added skill for debugging
          console.log(`Added soft skill filter: "${cleanValue}"`);
        }

        // Add event listeners
        input.addEventListener('input', () => {
          renderDropdown();
        });

        input.addEventListener('keydown', (e) => {
          // Add tag on Enter or comma key
          if (e.key === 'Enter' || e.key === ',') {
            e.preventDefault();
            const customValue = input.value.trim();
            if (customValue) {
              // Clean custom value before adding
              const cleanedValue = customValue
                .replace(/^[,\s]+|[,\s]+$/g, '')  // Remove leading/trailing commas and spaces
                .replace(/\s{2,}/g, ' ');         // Convert multiple spaces to single space
              
              if (cleanedValue) {
                console.log('Adding custom soft skill value:', cleanedValue);
                addTag(cleanedValue);
                input.value = '';
                renderDropdown();
              }
            }
          } 
          // Remove the last tag on Backspace when input is empty
          else if (e.key === 'Backspace' && input.value === '') {
            const tags = tagsContainer.getElementsByClassName('industry-tag');
            if (tags.length > 0) {
              const lastTag = tags[tags.length - 1];
              const value = lastTag.textContent.slice(0, -1); // Remove × character
              selectedSkills.delete(value);
              updateHiddenInput();
              tagsContainer.removeChild(lastTag);
            }
          }
          // If Tab pressed and dropdown has options, select the first one
          else if (e.key === 'Tab' && dropdown.style.display === 'block') {
            const firstOption = dropdown.querySelector('.industry-option');
            if (firstOption) {
              e.preventDefault(); // Prevent moving to next form field
              addTag(firstOption.textContent);
              input.value = '';
              renderDropdown();
            }
          }
        });

        document.addEventListener('click', (e) => {
          if (!document.getElementById('soft-skills-multi-select').contains(e.target)) {
            dropdown.style.display = 'none';
          }
        });

        // Initialize dropdown
        renderDropdown();
      }
      
      // Initialize filter form
      function initFilterForm() {
        const filterForm = document.getElementById('filter-form');
        const applyBtn = document.getElementById('apply-filters-btn');
        const resetBtn = document.getElementById('reset-filters-btn');
        const institutionInput = document.getElementById('institution-filter');
        const institutionSuggestions = document.getElementById('institutionSuggestions');
        
        if (!filterForm || !applyBtn || !resetBtn) {
          console.error("Could not find filter form elements");
          return;
        }
        
        // Initialize industry multi-select
        try {
          initIndustryFilter();
        } catch (error) {
          console.error("Error initializing industry filter:", error);
        }
        
        // Initialize technical skills multi-select
        try {
          initTechnicalSkillsFilter();
        } catch (error) {
          console.error("Error initializing technical skills filter:", error);
        }
        
        // Initialize soft skills multi-select
        try {
          initSoftSkillsFilter();
        } catch (error) {
          console.error("Error initializing soft skills filter:", error);
        }
        
        // Initialize institution suggestions
        if (institutionInput && institutionSuggestions) {
          // Load institutions data
          let institutions = [];
          fetch('/assets/api/us-colleges-and-universities.json')
            .then(response => {
              if (!response.ok) {
                throw new Error(`Failed to load institutions data: ${response.status}`);
              }
              return response.json();
            })
            .then(data => {
              if (Array.isArray(data) && data.length > 0) {
                console.log(`Successfully loaded ${data.length} institutions`);
                institutions = data;
              } else {
                console.warn('Institutions data loaded but may be invalid:', data);
              }
            })
            .catch(error => {
              console.error('Error loading institutions data:', error);
              // Enable manual entry for institutions in case of load failure
              if (institutionInput) {
                institutionInput.setAttribute('placeholder', 'Type your institution name manually');
                institutionInput.setAttribute('data-manual-mode', 'true');
              }
            });
            
          // Handle input event for institution search
          institutionInput.addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            if (searchTerm.length < 2) {
              institutionSuggestions.style.display = 'none';
              return;
            }
            
            const filteredInstitutions = institutions.filter(inst => 
              inst.name.toLowerCase().includes(searchTerm) || 
              inst.city.toLowerCase().includes(searchTerm)
            ).slice(0, 10); // Limit to 10 suggestions
            
            if (filteredInstitutions.length > 0) {
              institutionSuggestions.innerHTML = filteredInstitutions.map(inst => 
                `<a href="#" class="list-group-item list-group-item-action" 
                  data-name="${inst.name}" 
                  data-city="${inst.city}"
                  data-state="${inst.state}"
                  data-ipedsid="${inst.ipedsid}">
                  ${inst.name} | ${inst.city}, ${inst.state}
                </a>`
              ).join('');
              institutionSuggestions.style.display = 'block';
            } else {
              institutionSuggestions.style.display = 'none';
            }
          });
          
          // Handle suggestion selection
          institutionSuggestions.addEventListener('click', function(e) {
            if (e.target.classList.contains('list-group-item')) {
              const name = e.target.dataset.name;
              const city = e.target.dataset.city;
              const state = e.target.dataset.state;
              const ipedsid = e.target.dataset.ipedsid;
              institutionInput.value = `${name} | ${city}, ${state}`;
              institutionInput.setAttribute('data-ipedsid', ipedsid);
              institutionSuggestions.style.display = 'none';
            }
          });
          
          // Click outside to close suggestions
          document.addEventListener('click', function(e) {
            if (!institutionInput.contains(e.target) && !institutionSuggestions.contains(e.target)) {
              institutionSuggestions.style.display = 'none';
            }
          });
        }
        
        // Handle apply filters button
        applyBtn.addEventListener('click', function(e) {
          e.preventDefault();
          
          // Get selected gender value
          const selectedGender = document.getElementById('gender-filter').value;
          
          // Get institution value
          const selectedInstitutionFull = institutionInput ? institutionInput.value.trim() : '';
          
          // Get year of study value
          const selectedYearOfStudy = document.getElementById('year-of-study-filter').value;
          
          // Get state value
          const selectedState = document.getElementById('state-filter').value;
          
          // Get major type value
          const selectedMajorType = document.getElementById('major-type-filter').value;
          
          // Get area of study value
          const selectedMajorCategory = document.getElementById('major-filter').value;
          
          // Get industry values
          const industryHiddenInput = document.getElementById('industry-hidden-input');
          let selectedIndustries = [];
          if (industryHiddenInput && industryHiddenInput.value) {
            try {
              // Detailed debugging for the industry input value
              console.log('RAW industry input value:', industryHiddenInput.value);
              
              // Try parsing as JSON first
              if (industryHiddenInput.value.startsWith('[') && industryHiddenInput.value.endsWith(']')) {
                selectedIndustries = JSON.parse(industryHiddenInput.value);
                console.log('Parsed industry values as JSON array:', selectedIndustries);
              } 
              // If it's a comma-separated string, split it
              else if (industryHiddenInput.value.includes(',')) {
                selectedIndustries = industryHiddenInput.value.split(',').map(val => val.trim());
                console.log('Parsed industry values as comma-separated list:', selectedIndustries);
              }
              // Single value
              else if (industryHiddenInput.value.trim()) {
                selectedIndustries = [industryHiddenInput.value.trim()];
                console.log('Using single industry value:', selectedIndustries);
              }
              
              // Ensure we have an array even if the value parsed to something else
              if (!Array.isArray(selectedIndustries)) {
                console.warn("Industry input value was not an array, resetting to empty array");
                selectedIndustries = [];
              }
            } catch (e) {
              console.error("Error parsing industry values:", e, "Raw value:", industryHiddenInput.value);
              // Try to recover by treating as single value if JSON parsing failed
              if (industryHiddenInput.value.trim()) {
                selectedIndustries = [industryHiddenInput.value.trim()];
                console.log('Fallback to using raw value as single industry:', selectedIndustries);
              }
            }
          }
          
          // Get technical skills values
          const technicalSkillsHiddenInput = document.getElementById('technical-skills-hidden-input');
          let selectedTechnicalSkills = [];
          if (technicalSkillsHiddenInput && technicalSkillsHiddenInput.value) {
            try {
              // Detailed debugging for the technical skills input value
              console.log('RAW technical skills input value:', technicalSkillsHiddenInput.value);
              
              // Try parsing as JSON first
              if (technicalSkillsHiddenInput.value.startsWith('[') && technicalSkillsHiddenInput.value.endsWith(']')) {
                selectedTechnicalSkills = JSON.parse(technicalSkillsHiddenInput.value);
                console.log('Parsed technical skills values as JSON array:', selectedTechnicalSkills);
              } 
              // If it's a comma-separated string, split it
              else if (technicalSkillsHiddenInput.value.includes(',')) {
                selectedTechnicalSkills = technicalSkillsHiddenInput.value.split(',').map(val => val.trim());
                console.log('Parsed technical skills values as comma-separated list:', selectedTechnicalSkills);
              }
              // Single value
              else if (technicalSkillsHiddenInput.value.trim()) {
                selectedTechnicalSkills = [technicalSkillsHiddenInput.value.trim()];
                console.log('Using single technical skill value:', selectedTechnicalSkills);
              }
              
              // Ensure we have an array even if the value parsed to something else
              if (!Array.isArray(selectedTechnicalSkills)) {
                console.warn("Technical skills input value was not an array, resetting to empty array");
                selectedTechnicalSkills = [];
              }
            } catch (e) {
              console.error("Error parsing technical skills values:", e, "Raw value:", technicalSkillsHiddenInput.value);
              // Try to recover by treating as single value if JSON parsing failed
              if (technicalSkillsHiddenInput.value.trim()) {
                selectedTechnicalSkills = [technicalSkillsHiddenInput.value.trim()];
                console.log('Fallback to using raw value as single technical skill:', selectedTechnicalSkills);
              }
            }
          }
          
          // Get soft skills values
          const softSkillsHiddenInput = document.getElementById('soft-skills-hidden-input');
          let selectedSoftSkills = [];
          if (softSkillsHiddenInput && softSkillsHiddenInput.value) {
            try {
              // Detailed debugging for the soft skills input value
              console.log('RAW soft skills input value:', softSkillsHiddenInput.value);
              
              // Try parsing as JSON first
              if (softSkillsHiddenInput.value.startsWith('[') && softSkillsHiddenInput.value.endsWith(']')) {
                selectedSoftSkills = JSON.parse(softSkillsHiddenInput.value);
                console.log('Parsed soft skills values as JSON array:', selectedSoftSkills);
              } 
              // If it's a comma-separated string, split it
              else if (softSkillsHiddenInput.value.includes(',')) {
                selectedSoftSkills = softSkillsHiddenInput.value.split(',').map(val => val.trim());
                console.log('Parsed soft skills values as comma-separated list:', selectedSoftSkills);
              }
              // Single value
              else if (softSkillsHiddenInput.value.trim()) {
                selectedSoftSkills = [softSkillsHiddenInput.value.trim()];
                console.log('Using single soft skill value:', selectedSoftSkills);
              }
              
              // Ensure we have an array even if the value parsed to something else
              if (!Array.isArray(selectedSoftSkills)) {
                console.warn("Soft skills input value was not an array, resetting to empty array");
                selectedSoftSkills = [];
              }
            } catch (e) {
              console.error("Error parsing soft skills values:", e, "Raw value:", softSkillsHiddenInput.value);
              // Try to recover by treating as single value if JSON parsing failed
              if (softSkillsHiddenInput.value.trim()) {
                selectedSoftSkills = [softSkillsHiddenInput.value.trim()];
                console.log('Fallback to using raw value as single soft skill:', selectedSoftSkills);
              }
            }
          }
          
          // Handle no institution selected case
          if (!selectedInstitutionFull) {
              console.log('No institution selected');
          }
          
          // For debugging - log the raw input
          console.log('Raw institution input:', {
              value: selectedInstitutionFull,
              ipeds: institutionInput ? institutionInput.getAttribute('data-ipedsid') : 'none'
          });
          
          // Extract just the institution name from the combined format "Name | City, State"
          let selectedInstitution = selectedInstitutionFull;
          if (selectedInstitutionFull.includes('|')) {
            selectedInstitution = selectedInstitutionFull.split('|')[0].trim();
            console.log('Extracted institution name from full value:', selectedInstitution);
          } else {
            console.log('Using institution name as is:', selectedInstitution);
          }
          
          // Check if filters are active
          const isAllGenderSelected = !selectedGender;
          const hasInstitutionFilter = selectedInstitution !== '';
          const hasYearOfStudyFilter = selectedYearOfStudy !== '';
          const hasStateFilter = selectedState !== '';
          const hasMajorTypeFilter = selectedMajorType !== '';
          const hasMajorCategoryFilter = selectedMajorCategory !== '';
          const hasIndustryFilter = selectedIndustries.length > 0;
          const hasTechnicalSkillsFilter = selectedTechnicalSkills.length > 0;
          const hasSoftSkillsFilter = selectedSoftSkills.length > 0;
          
          // Log filter info - critical for debugging
          if (hasInstitutionFilter) {
            console.log('Institution filter is active with:', {
              selectedInstitution,
              selectedInstitutionFull,
              ipeds: institutionInput.getAttribute('data-ipedsid') || 'none'
            });
          }
          
          if (hasMajorTypeFilter) {
            console.log('Major type filter is active with:', selectedMajorType);
          }
          
          // Log the selected filters
          console.log('Applying filters with gender:', selectedGender || 'All', 
                     'institution:', selectedInstitution || 'All',
                     'state:', selectedState || 'All',
                     'year of study:', selectedYearOfStudy || 'All',
                     'major type:', selectedMajorType || 'All',
                     'area of study:', selectedMajorCategory || 'All',
                     'industries:', selectedIndustries.length > 0 ? selectedIndustries.join(', ') : 'All',
                     'technical skills:', selectedTechnicalSkills.length > 0 ? selectedTechnicalSkills.join(', ') : 'All',
                     'soft skills:', selectedSoftSkills.length > 0 ? selectedSoftSkills.join(', ') : 'All');
                     
          // Debug - Log the raw industry input value
          console.log('Raw industry input value:', industryHiddenInput ? industryHiddenInput.value : 'null');
          
          // Filter the profiles based on gender and institution
          if (window.profiles && Array.isArray(window.profiles)) {
            let filteredProfiles = [...window.profiles];
            
                          // Apply gender filter if specific gender is selected
            if (!isAllGenderSelected) {
              // For debugging, log a sample profile structure
              if (window.profiles.length > 0) {
                console.log('Sample profile structure:', JSON.stringify(window.profiles[0].gender, null, 2));
              }
              
              filteredProfiles = filteredProfiles.filter(profile => {
                // No gender field at all, exclude when specific gender is selected
                if (!profile.gender) return false;
                
                // Handle nested gender object format from database
                if (typeof profile.gender === 'object' && profile.gender !== null) {
                  // Nested value property (from database format)
                  if (profile.gender.value) {
                    return profile.gender.value === selectedGender;
                  }
                } 
                // Handle direct string format
                else if (typeof profile.gender === 'string') {
                  return profile.gender === selectedGender;
                }
                
                // If we reached here, the profile doesn't match the gender filter
                return false;
              });
            }
            
            // Apply year of study filter if specific year is selected
            if (hasYearOfStudyFilter) {
              console.log('Filtering by year of study:', selectedYearOfStudy);
              
              // For debugging, log a sample profile structure
              if (filteredProfiles.length > 0) {
                console.log('Sample profile year_of_study data:', JSON.stringify({
                  year_of_study: filteredProfiles[0].year_of_study,
                  fullProfile: filteredProfiles[0].name
                }, null, 2));
              }
              
              filteredProfiles = filteredProfiles.filter(profile => {
                // Check various fields for year of study information
                
                // First check if profile has year_of_study field directly
                if (profile.year_of_study) {
                  // Handle object format (from database)
                  if (typeof profile.year_of_study === 'object' && profile.year_of_study !== null) {
                    if (profile.year_of_study.value) {
                      return profile.year_of_study.value === selectedYearOfStudy;
                    }
                  }
                  // Handle direct string format
                  else if (typeof profile.year_of_study === 'string') {
                    return profile.year_of_study === selectedYearOfStudy;
                  }
                }
                
                // Also check any alternate field names
                if (profile.yearOfStudy) {
                  // Handle object format
                  if (typeof profile.yearOfStudy === 'object' && profile.yearOfStudy !== null) {
                    if (profile.yearOfStudy.value) {
                      return profile.yearOfStudy.value === selectedYearOfStudy;
                    }
                  }
                  // Handle direct string format
                  else if (typeof profile.yearOfStudy === 'string') {
                    return profile.yearOfStudy === selectedYearOfStudy;
                  }
                }
                
                // If we reached here, the profile doesn't match the year of study filter
                return false;
              });
              
              console.log(`Year of study filter applied, ${filteredProfiles.length} profiles match`);
            }
            
            // Apply state filter if specific state is selected
            if (hasStateFilter) {
              console.log('Filtering by state:', selectedState);
              
              // For debugging, log a sample profile structure
              if (filteredProfiles.length > 0) {
                console.log('Sample profile state data:', JSON.stringify({
                  location: filteredProfiles[0].location,
                  state: filteredProfiles[0].state,
                  profile: filteredProfiles[0].name
                }, null, 2));
              }
              
              filteredProfiles = filteredProfiles.filter(profile => {
                // Check various fields for state information
                
                // First check if profile has state field directly
                if (profile.state) {
                  // Handle object format (from database)
                  if (typeof profile.state === 'object' && profile.state !== null) {
                    if (profile.state.value) {
                      return profile.state.value === selectedState;
                    }
                  }
                  // Handle direct string format
                  else if (typeof profile.state === 'string') {
                    return profile.state === selectedState;
                  }
                }
                
                // Check in location field which might contain state information
                if (profile.location) {
                  // Handle object format
                  if (typeof profile.location === 'object' && profile.location !== null) {
                    // Check state property inside location
                    if (profile.location.state) {
                      if (typeof profile.location.state === 'object' && profile.location.state.value) {
                        return profile.location.state.value === selectedState;
                      } else if (typeof profile.location.state === 'string') {
                        return profile.location.state === selectedState;
                      }
                    }
                    
                    // Check value property for full location string
                    if (profile.location.value && typeof profile.location.value === 'string') {
                      // Location might be in format "City, State" or just "State"
                      const locationParts = profile.location.value.split(',');
                      // If we have a state part, check it
                      if (locationParts.length > 1) {
                        const statePart = locationParts[1].trim();
                        return statePart === selectedState;
                      } else if (locationParts.length === 1) {
                        // Single value might be just the state
                        return locationParts[0].trim() === selectedState;
                      }
                    }
                  }
                  // Handle direct string format
                  else if (typeof profile.location === 'string') {
                    // Location might be in format "City, State" or just "State"
                    const locationParts = profile.location.split(',');
                    // If we have a state part, check it
                    if (locationParts.length > 1) {
                      const statePart = locationParts[1].trim();
                      return statePart === selectedState;
                    } else if (locationParts.length === 1) {
                      // Single value might be just the state
                      return locationParts[0].trim() === selectedState;
                    }
                  }
                }
                
                // Check in institution which might contain state information
                if (profile.institution) {
                  // Handle object format
                  if (typeof profile.institution === 'object' && profile.institution !== null) {
                    // Check for institution value in format "University | City, State"
                    if (profile.institution.value && typeof profile.institution.value === 'string') {
                      const parts = profile.institution.value.split('|');
                      if (parts.length > 1) {
                        const locationPart = parts[1].trim();
                        const locationParts = locationPart.split(',');
                        if (locationParts.length > 1) {
                          const statePart = locationParts[1].trim();
                          return statePart === selectedState;
                        }
                      }
                    }
                  }
                }
                
                // If we reached here, the profile doesn't match the state filter
                return false;
              });
              
              console.log(`State filter applied, ${filteredProfiles.length} profiles match`);
            }
            
            // Apply major type filter if specific major type is selected
            if (hasMajorTypeFilter) {
              console.log('Filtering by major type:', selectedMajorType);
              
              // For debugging, log sample profile structure with major type
              if (filteredProfiles.length > 0) {
                console.log('Sample profile major data:', JSON.stringify({
                  major_category: filteredProfiles[0].major_category,
                  major_type: filteredProfiles[0].major_type,
                  title: filteredProfiles[0].title
                }, null, 2));
              }
              
              filteredProfiles = filteredProfiles.filter(profile => {
                // Check various fields for major type information
                
                // First check if profile has major_type field directly
                if (profile.major_type) {
                  const majorTypeValue = typeof profile.major_type === 'object' ? 
                    profile.major_type.value : profile.major_type;
                  
                  if (typeof majorTypeValue === 'string') {
                    // Case-insensitive comparison
                    return majorTypeValue.toLowerCase() === selectedMajorType.toLowerCase();
                  }
                }
                
                // Check if the major category might indicate technical vs non-technical
                // Specific keywords that indicate technical fields
                const technicalMajors = ['Engineering', 'Computer Science', 'Data Science', 'Information Technology', 
                                       'Software', 'Programming', 'Development', 'Cybersecurity', 'Robotics', 
                                       'Artificial Intelligence', 'Machine Learning', 'Technical', 'Coding',
                                       'Web Development', 'Mobile Development', 'DevOps', 'IT', 'Systems', 
                                       'Network', 'Database', 'Cloud Computing'];
                                       
                // Specific keywords that indicate non-technical fields
                const nonTechnicalMajors = ['Business', 'Marketing', 'Liberal Arts', 'Education', 'Psychology', 
                                          'Communications', 'Fine Arts', 'Management', 'Economics', 'Finance',
                                          'Humanities', 'Social Sciences', 'Design', 'Non-Technical',
                                          'Accounting', 'Sales', 'Law', 'Political Science', 'Journalism',
                                          'Philosophy', 'History', 'Sociology', 'Anthropology'];
                
                let majorCategoryValue = '';
                let majorSubCategoryValue = '';
                let titleValue = profile.title || '';
                
                // Extract major category from nested object if needed
                if (profile.major_category) {
                  if (typeof profile.major_category === 'object' && profile.major_category.value) {
                    majorCategoryValue = profile.major_category.value;
                  } else if (typeof profile.major_category === 'string') {
                    majorCategoryValue = profile.major_category;
                  }
                }
                
                // Also check major sub category for additional clues
                if (profile.major_sub_category) {
                  if (typeof profile.major_sub_category === 'object' && profile.major_sub_category.value) {
                    majorSubCategoryValue = profile.major_sub_category.value;
                  } else if (typeof profile.major_sub_category === 'string') {
                    majorSubCategoryValue = profile.major_sub_category;
                  }
                }
                
                // For debugging
                console.log(`Checking major for ${profile.name}:`, {
                  majorCategoryValue,
                  majorSubCategoryValue,
                  titleValue
                });
                
                // Helper function to check if a string matches any term from the list
                const matchesAnyTerm = (value, termList) => {
                  if (!value) return false;
                  
                  // Skip "N/A" values, placeholders, and generic strings
                  if (value === "N/A" || 
                      value === "n/a" || 
                      value === "Not specified" || 
                      value === "Not Applicable" ||
                      value === "No Area of Study Listed" ||
                      value === "Location not specified") {
                    return false;
                  }
                  
                  const lowerValue = value.toLowerCase();
                  return termList.some(term => lowerValue.includes(term.toLowerCase()));
                };
                
                // Check all available fields for technical/non-technical indicators
                if (selectedMajorType === 'Technical') {
                  // Check various fields for technical terms
                  if (matchesAnyTerm(majorCategoryValue, technicalMajors)) {
                    console.log(`Match in major category for ${profile.name}: ${majorCategoryValue}`);
                    return true;
                  }
                  
                  if (matchesAnyTerm(majorSubCategoryValue, technicalMajors)) {
                    console.log(`Match in major sub-category for ${profile.name}: ${majorSubCategoryValue}`);
                    return true;
                  }
                  
                  if (matchesAnyTerm(titleValue, technicalMajors)) {
                    console.log(`Match in title for ${profile.name}: ${titleValue}`);
                    return true;
                  }
                  
                  // Also check tags which might contain technical skills
                  if (Array.isArray(profile.tags)) {
                    const technicalTags = profile.tags.filter(tag => 
                      matchesAnyTerm(tag, technicalMajors)
                    );
                    
                    if (technicalTags.length > 0) {
                      console.log(`Match in tags for ${profile.name}: ${technicalTags.join(', ')}`);
                      return true;
                    }
                  }
                  
                  // No technical indicators found
                  return false;
                } 
                else if (selectedMajorType === 'Non-Technical') {
                  // Check various fields for non-technical terms
                  if (matchesAnyTerm(majorCategoryValue, nonTechnicalMajors)) {
                    console.log(`Match in major category for ${profile.name}: ${majorCategoryValue}`);
                    return true;
                  }
                  
                  if (matchesAnyTerm(majorSubCategoryValue, nonTechnicalMajors)) {
                    console.log(`Match in major sub-category for ${profile.name}: ${majorSubCategoryValue}`);
                    return true;
                  }
                  
                  if (matchesAnyTerm(titleValue, nonTechnicalMajors)) {
                    console.log(`Match in title for ${profile.name}: ${titleValue}`);
                    return true;
                  }
                  
                  // Also check tags which might contain non-technical skills
                  if (Array.isArray(profile.tags)) {
                    const nonTechnicalTags = profile.tags.filter(tag => 
                      matchesAnyTerm(tag, nonTechnicalMajors)
                    );
                    
                    if (nonTechnicalTags.length > 0) {
                      console.log(`Match in tags for ${profile.name}: ${nonTechnicalTags.join(', ')}`);
                      return true;
                    }
                  }
                  
                  // No non-technical indicators found
                  return false;
                }
                
                // If we can't determine the major type or have no major data, exclude from filtered results
                console.log('Could not determine major type for:', profile.name, {
                  major_type: profile.major_type,
                  major_category: profile.major_category,
                  major_sub_category: profile.major_sub_category,
                  title: profile.title,
                  tags: profile.tags
                });
                return false;
              });
              
              console.log(`Major type filter applied, ${filteredProfiles.length} profiles match`);
            }
            
            // Apply area of study filter if specific area is selected
            if (hasMajorCategoryFilter) {
              console.log('Filtering by area of study:', selectedMajorCategory);
              
              // For debugging, log a sample profile structure
              if (filteredProfiles.length > 0) {
                console.log('Sample profile major_category data:', JSON.stringify({
                  major_category: filteredProfiles[0].major_category,
                  name: filteredProfiles[0].name
                }, null, 2));
              }
              
              filteredProfiles = filteredProfiles.filter(profile => {
                // Check various fields for area of study information
                
                // First check if profile has major_category field directly
                if (profile.major_category) {
                  // Handle object format (from database)
                  if (typeof profile.major_category === 'object' && profile.major_category !== null) {
                    if (profile.major_category.value) {
                      return profile.major_category.value === selectedMajorCategory;
                    }
                  }
                  // Handle direct string format
                  else if (typeof profile.major_category === 'string') {
                    return profile.major_category === selectedMajorCategory;
                  }
                }
                
                // Also check title field which might contain area of study
                if (profile.title && typeof profile.title === 'string') {
                  // Simple check if title contains the area of study
                  if (profile.title.includes(selectedMajorCategory)) {
                    return true;
                  }
                }
                
                // If we reached here, the profile doesn't match the area of study filter
                return false;
              });
              
              console.log(`Area of study filter applied, ${filteredProfiles.length} profiles match`);
            }
            
            // Apply industry filter if industries are selected
                        if (hasIndustryFilter) {
              console.log('Filtering by industries:', selectedIndustries);
              
              // For debugging, log a sample profile structure
              if (filteredProfiles.length > 0) {
                console.log('Sample profile industry data:', JSON.stringify({
                  my_interests: filteredProfiles[0].my_interests,
                  name: filteredProfiles[0].name
                }, null, 2));
              }
              
              filteredProfiles = filteredProfiles.filter(profile => {
                // ===================================================================
                // STRICT INDUSTRY FILTER: MATCHES ONLY FROM my_interests FIELD
                // Will NOT match if the industry is in skills, tags, or other fields
                // ===================================================================
                console.log(`STRICT FILTER: Checking if ${profile.name || 'unknown'} has industry "${selectedIndustries.join(', ')}" in their my_interests FIELD ONLY`);
                console.log(`INFO: This filter WILL ignore matches in skills, tags, or other fields - ONLY my_interests field is checked`);
                
                // Check if we need to filter out this profile immediately
                if (!profile) {
                  console.log("Skipping null/undefined profile");
                  return false;
                }
                
                // CRITICAL DEBUG: Carefully examine profile structure to find my_interests
                console.log(`COMPLETE PROFILE DUMP for ${profile.name || 'unknown'}:`, profile);
                
                // Log critical interest-related fields - focus on my_interests
                console.log(`INTEREST FIELDS for ${profile.name || 'unknown'}:`, {
                  // Check original my_interests array
                  my_interests: profile.my_interests,
                  my_interests_type: typeof profile.my_interests,
                  my_interests_isArray: Array.isArray(profile.my_interests),
                  
                  // Check matchingMyInterests field (which is mapped during profile processing)
                  matchingMyInterests: profile.matchingMyInterests,
                  matchingMyInterests_type: typeof profile.matchingMyInterests,
                  matchingMyInterests_isArray: Array.isArray(profile.matchingMyInterests),
                  
                  // Check tags array (which sometimes contains interest data)
                  tags: profile.tags,
                  tags_isArray: Array.isArray(profile.tags)
                });
                
                // NEVER skip a profile - we'll try to extract interests in multiple ways
                // Instead of skipping, we'll try various approaches to find interests
                
                // Enhanced profile structure inspection with targeted debugging
                const profileName = profile.name || profile.full_name || 'unknown';
                console.log(`PROFILE STRUCTURE for ${profileName}:`, {
                  id: profile._id || profile.id,
                  name: profileName,
                  my_interests: profile.my_interests,
                  interests_looking_in_others: profile.interests_looking_in_others,
                  majorFields: {
                    major_category: profile.major_category,
                    major_sub_category: profile.major_sub_category,
                    major_type: profile.major_type
                  },
                  // Show interest-related fields
                  interestFields: {
                    hasMyInterests: !!profile.my_interests,
                    myInterestsType: typeof profile.my_interests,
                    myInterestsIsArray: Array.isArray(profile.my_interests),
                    myInterestsLength: Array.isArray(profile.my_interests) ? profile.my_interests.length : 'N/A',
                    hasInterestsLookingIn: !!profile.interests_looking_in_others,
                    interestsLookingInType: typeof profile.interests_looking_in_others,
                  }
                });
                
                // Don't skip ANY profiles anymore - let's try to work with what we have
                // This ensures we handle potential alternate field structures
                // We'll extract everything in the next step
                
                // DETAILED DEBUG: Show exactly what's in the my_interests field
                console.log(`DETAILED DEBUG for ${profile.name}:`, {
                  my_interests: profile.my_interests,
                  type: Array.isArray(profile.my_interests) ? 'array' : typeof profile.my_interests,
                  length: Array.isArray(profile.my_interests) ? profile.my_interests.length : 'N/A',
                  raw: JSON.stringify(profile.my_interests)
                });
                
                // SUPER FLEXIBLE handling of my_interests field - try ALL possible structures
                let interestsArray = [];
                
                // Function to extract interests from any type of data structure
                const extractInterestsFromAny = (data) => {
                  const results = [];
                  
                  // Handle null/undefined case
                  if (!data) return results;
                  
                  console.log(`Extracting interests from data type: ${typeof data}`, data);
                  
                  // Array case (most common for my_interests)
                  if (Array.isArray(data)) {
                    // Process each item in the array and convert to string
                    data.forEach(item => {
                      if (typeof item === 'string') {
                        results.push(item);
                      } else if (item && typeof item === 'object' && item.value) {
                        results.push(String(item.value));
                      } else if (item) {
                        results.push(String(item));
                      }
                    });
                    
                    console.log(`Extracted ${results.length} interests from array:`, results);
                  }
                  // String case - split by comma or other delimiters
                  else if (typeof data === 'string') {
                    // Try multiple delimiters - comma, semicolon, or pipe
                    const delimiters = [',', ';', '|'];
                    let useDelimiter = ','; // default
                    
                    // Try to determine the best delimiter to use
                    for (const delimiter of delimiters) {
                      if (data.includes(delimiter)) {
                        useDelimiter = delimiter;
                        break;
                      }
                    }
                    
                    data.split(useDelimiter).forEach(item => {
                      const trimmed = item.trim();
                      if (trimmed) results.push(trimmed);
                    });
                    
                    console.log(`Extracted ${results.length} interests from string using delimiter "${useDelimiter}":`, results);
                    
                    // If no delimiters found and no results, treat the whole string as one interest
                    if (results.length === 0 && data.trim()) {
                      results.push(data.trim());
                      console.log(`Added entire string as a single interest:`, results);
                    }
                  }
                  // Object case
                  else if (typeof data === 'object') {
                    console.log(`Processing object data with keys:`, Object.keys(data));
                    
                    // Try common patterns like .value, .items, .interests
                    if (data.value) {
                      const extracted = extractInterestsFromAny(data.value);
                      if (extracted.length > 0) {
                        console.log(`Found interests in .value property:`, extracted);
                        return extracted;
                      }
                    }
                    if (data.items) {
                      const extracted = extractInterestsFromAny(data.items);
                      if (extracted.length > 0) {
                        console.log(`Found interests in .items property:`, extracted);
                        return extracted;
                      }
                    }
                    if (data.interests) {
                      const extracted = extractInterestsFromAny(data.interests);
                      if (extracted.length > 0) {
                        console.log(`Found interests in .interests property:`, extracted);
                        return extracted;
                      }
                    }
                    
                    // Look for any array properties that might contain interests
                    for (const key of Object.keys(data)) {
                      if (Array.isArray(data[key])) {
                        const arrayResults = [];
                        data[key].forEach(item => {
                          if (typeof item === 'string') arrayResults.push(item);
                          else if (item && typeof item === 'object' && item.value) arrayResults.push(item.value);
                        });
                        
                        if (arrayResults.length > 0) {
                          console.log(`Found ${arrayResults.length} interests in array property "${key}":`, arrayResults);
                          results.push(...arrayResults);
                        }
                      }
                    }
                    
                    // Last resort: try all string properties
                    if (results.length === 0) {
                      Object.keys(data).forEach(key => {
                        if (typeof data[key] === 'string') {
                          results.push(data[key]);
                          console.log(`Adding string property "${key}" as interest:`, data[key]);
                        }
                      });
                    }
                  }
                  
                  return results;
                };
                
                // COMPREHENSIVE EXTRACTION: Try ALL possible ways to extract my_interests
                interestsArray = [];  // Start with empty array
                
                // Method 1: Direct access if it's already an array
                if (profile.my_interests && Array.isArray(profile.my_interests)) {
                  console.log(`FOUND (Method 1): Direct array access for ${profile.name}:`, profile.my_interests);
                  interestsArray = [...profile.my_interests];
                }
                // Method 2: Check if it's a string that needs to be parsed
                else if (profile.my_interests && typeof profile.my_interests === 'string') {
                  // Try to parse as JSON if it starts with [ and ends with ]
                  if (profile.my_interests.trim().startsWith('[') && profile.my_interests.trim().endsWith(']')) {
                    try {
                      const parsed = JSON.parse(profile.my_interests);
                      if (Array.isArray(parsed)) {
                        console.log(`FOUND (Method 2A): Parsed JSON array for ${profile.name}:`, parsed);
                        interestsArray = parsed;
                      }
                    } catch (e) {
                      console.log(`Failed to parse JSON string:`, profile.my_interests);
                    }
                  }
                  // Otherwise split by comma
                  else {
                    const split = profile.my_interests.split(',').map(i => i.trim()).filter(i => i);
                    console.log(`FOUND (Method 2B): Split string for ${profile.name}:`, split);
                    interestsArray = split;
                  }
                }
                // Method 3: If my_interests is an object, try to extract from it
                else if (profile.my_interests && typeof profile.my_interests === 'object') {
                  // If the object has numeric keys, it might be an array-like object
                  const keys = Object.keys(profile.my_interests);
                  if (keys.every(k => !isNaN(parseInt(k)))) {
                    console.log(`FOUND (Method 3A): Array-like object for ${profile.name}:`, profile.my_interests);
                    interestsArray = keys.map(k => profile.my_interests[k]);
                  }
                  // Otherwise check for common properties
                  else if (profile.my_interests.value) {
                    console.log(`FOUND (Method 3B): Object with value property for ${profile.name}:`, profile.my_interests.value);
                    if (Array.isArray(profile.my_interests.value)) {
                      interestsArray = [...profile.my_interests.value];
                    } else if (typeof profile.my_interests.value === 'string') {
                      interestsArray = [profile.my_interests.value];
                    }
                  }
                }
                
                // Method 4: Alternative field names
                if (interestsArray.length === 0) {
                  if (profile.myInterests && Array.isArray(profile.myInterests)) {
                    console.log(`FOUND (Method 4): Alternative field name for ${profile.name}:`, profile.myInterests);
                    interestsArray = [...profile.myInterests];
                  }
                }
                
                // Method 5: Check if the interests might be nested deeper in the structure
                if (interestsArray.length === 0 && typeof profile === 'object' && profile !== null) {
                  // Look for nested my_interests property
                  Object.keys(profile).forEach(key => {
                    if (profile[key] && typeof profile[key] === 'object' && profile[key].my_interests) {
                      if (Array.isArray(profile[key].my_interests)) {
                        console.log(`FOUND (Method 5): Nested my_interests in ${key} for ${profile.name}:`, profile[key].my_interests);
                        interestsArray = [...profile[key].my_interests];
                      }
                    }
                  });
                }
                
                // Deduplicate and clean the interests
                interestsArray = [...new Set(interestsArray)]
                  .filter(item => item !== null && item !== undefined)
                  .map(item => typeof item === 'string' ? item : String(item));
                
                // Log final results
                console.log(`FINAL INTERESTS for ${profile.name}:`, interestsArray);
                
                console.log(`Final interests for ${profile.name}:`, interestsArray);
                
                // Extra verification - make sure we extracted some interests
                if (interestsArray.length === 0) {
                  console.warn(`WARNING: No interests could be extracted from profile ${profile.name || profile.full_name || 'unknown'}`);
                  
                  // CRITICAL FIX: Add detailed debug logging for interest extraction failures
                  console.log('INTEREST EXTRACTION FAILURE DETAILS:', {
                    profileId: profile.id || profile._id,
                    profileName: profile.name || profile.full_name || 'unknown',
                    hasMyInterests: !!profile.my_interests,
                    myInterestsType: typeof profile.my_interests,
                    myInterestsValue: profile.my_interests,
                    rawKeys: Object.keys(profile)
                  });
                  
                  // STRICT FILTER: ONLY use my_interests or its mapped field
                  // DO NOT check skills, tags, or any other fields
                  // This ensures we ONLY match interests that were directly set by the user
                  
                  // ONLY allowed fields for matching: direct my_interests or matchingMyInterests
                  // matchingMyInterests is the most reliable as it contains data from the original my_interests
                  
                  // Use matchingMyInterests (most reliable method)
                  if (profile.matchingMyInterests && Array.isArray(profile.matchingMyInterests)) {
                    console.log(`✅ STRICT MATCHING: Using matchingMyInterests array for ${profile.name}:`, profile.matchingMyInterests);
                    interestsArray = [...profile.matchingMyInterests];
                  }
                  // Direct access to my_interests as backup
                  else if (profile.my_interests && Array.isArray(profile.my_interests)) {
                    console.log(`✅ STRICT MATCHING: Using direct my_interests array for ${profile.name}:`, profile.my_interests);
                    interestsArray = [...profile.my_interests];
                  }
                  
                  // DO NOT USE ANY OTHER FIELDS FOR MATCHING
                  // No skills, no tags, no matchingTheirInterests - STRICTLY my_interests only
                  
                  // Log if we still couldn't get interests
                  if (interestsArray.length === 0) {
                    console.log(`IMPORTANT: Could not extract any interests from any field for ${profile.name || profile.full_name || 'unknown'}`);
                  }
                }
                
                // Define mappings for commonly confused industry terms
                const industryPairs = {
                  'ai': ['ai', 'artificial intelligence', 'machine learning'],
                  'artificial intelligence': ['ai', 'artificial intelligence', 'machine learning'],
                  'web3': ['web3', 'blockchain', 'crypto'],
                  'blockchain': ['blockchain', 'web3', 'crypto'],
                  'crypto': ['crypto', 'cryptocurrency', 'blockchain', 'web3'],
                  'fintech': ['fintech', 'financial technology'],
                  'cybersecurity': ['cybersecurity', 'cyber security', 'security'],
                  'cloud': ['cloud', 'cloud computing', 'aws', 'azure'],
                  'healthcare': ['healthcare', 'health care', 'medical'],
                  'iot': ['iot', 'internet of things'],
                  'enterprise': ['enterprise', 'b2b'],
                  'consumer': ['consumer', 'b2c']
                };
                
                // ULTRA-FLEXIBLE MATCHING: For each selected industry, try to find ANY match in interests
                for (const industry of selectedIndustries) {
                  // Enhanced normalization for custom-entered values
                  // Step 1: Basic cleanup - lowercase, trim, normalize spacing
                  let normalizedIndustry = (industry || '').toString().toLowerCase().trim();
                  // Step 2: Replace multiple spaces with single space
                  normalizedIndustry = normalizedIndustry.replace(/\s+/g, ' ');
                  // Step 3: Remove special characters that might cause matching issues
                  normalizedIndustry = normalizedIndustry.replace(/[^\w\s-]/g, '');
                  
                  console.log(`Checking for industry: "${industry}" (normalized: "${normalizedIndustry}")`);
                  
                  if (!normalizedIndustry) continue; // Skip empty industry values
                  
                  // Special handling for common industry terms
                  if (industryPairs[normalizedIndustry]) {
                    // Check if profile has this industry specifically in any of its accepted forms
                    const validForms = industryPairs[normalizedIndustry];
                    
                    const hasIndustry = interestsArray.some(interest => {
                      if (!interest) return false;
                      const interestStr = (typeof interest === 'string' ? interest : 
                                       typeof interest === 'object' && interest !== null && interest.value ? 
                                       interest.value : String(interest)).trim();
                      const lowercaseInterest = interestStr.toLowerCase();
                      
                      return validForms.some(form => 
                        lowercaseInterest === form || 
                        lowercaseInterest.startsWith(form + ' ') || 
                        lowercaseInterest.includes(' ' + form + ' ') || 
                        lowercaseInterest.endsWith(' ' + form)
                      );
                    });
                    
                    // If profile has the exact industry, it's a match
                    if (hasIndustry) {
                      console.log(`✓ Profile "${profile.name}" has ${normalizedIndustry} explicitly - good match`);
                      return true; // Found a match
                    }
                  }
                  
                  // Generate multiple search variations for better matching with custom values
                  const searchTerms = [normalizedIndustry];
                  
                  // For custom values with multiple words, also add each significant word individually
                  // This helps match "artificial intelligence" with just "intelligence" in interests
                  if (normalizedIndustry.includes(' ')) {
                    const words = normalizedIndustry.split(' ').filter(word => word.length > 3);
                    if (words.length > 1) {
                      console.log(`Custom multi-word term detected - adding individual words for better matching:`, words);
                      searchTerms.push(...words);
                    }
                  }
                  
                  // Log the search terms we're using
                  console.log(`Looking for matches using terms:`, searchTerms);
                  
                  
                  // Check against all interests in the profile
                  for (const interest of interestsArray) {
                    if (!interest) continue; // Skip null/empty values
                    
                    // Normalize the interest string
                    const interestStr = (typeof interest === 'string' ? interest : 
                                     typeof interest === 'object' && interest !== null && interest.value ? 
                                     interest.value : String(interest)).trim();
                    
                    if (!interestStr) continue; // Skip empty strings
                    
                    const lowercaseInterest = interestStr.toLowerCase();
                    console.log(`Comparing with interest: "${interestStr}" (normalized: "${lowercaseInterest}")`);
                    
                    // Check against all search terms for this industry
                    let matched = false;
                    for (const term of searchTerms) {
                          // ENHANCED MATCHING: More flexible for custom values
                      
                      // Method 1: Exact match (most reliable)
                      if (lowercaseInterest.trim() === term.trim()) {
                        console.log(`✓ EXACT MATCH for ${profile.name || profile.full_name}: "${industry}" exactly matches "${interestStr}" in my_interests`);
                        console.log(`MATCH INFO: User ${profile.name || profile.full_name} - my_interests contains "${interestStr}" which exactly matches search term "${industry}"`);
                        matched = true;
                        break;
                      }
                      
                      // Method 2: Case-insensitive contains (for custom values) - ONE WAY ONLY
                      // Only match if the interest contains the search term, not the other way around
                      // This prevents false matches like "AI" matching "AirBnB" 
                      if (lowercaseInterest.includes(term) && 
                          // Check word boundaries to prevent partial matches
                          (lowercaseInterest === term || 
                          lowercaseInterest.startsWith(term + ' ') || 
                          lowercaseInterest.includes(' ' + term + ' ') || 
                          lowercaseInterest.endsWith(' ' + term) ||
                          // Allow longer terms to match partially
                          (term.length > 4 && lowercaseInterest.includes(term)))) {
                        
                        // Avoid common false positives for ambiguous industry terms
                        const ambiguousPairs = [
                          { search: 'ai', avoid: ['airbnb', 'airtable', 'airflow'] },
                          { search: 'hr', avoid: ['hr tech', 'chrome', 'through'] },
                          { search: 'ar', avoid: ['ar/vr', 'virtual', 'market'] },
                          { search: 'ml', avoid: ['html', 'xml', 'yaml'] }
                        ];
                        
                        // Check if we're dealing with a potentially ambiguous term
                        const ambiguousMatch = ambiguousPairs.find(pair => 
                          pair.search === term && (
                            Array.isArray(pair.avoid) 
                              ? pair.avoid.some(avoid => lowercaseInterest.includes(avoid))
                              : lowercaseInterest.includes(pair.avoid)
                          )
                        );
                        
                        if (ambiguousMatch) {
                          console.log(`⚠️ Avoiding ambiguous match: "${term}" in "${lowercaseInterest}" matched ambiguous pattern - NOT a match`);
                          continue;
                        }
                        
                        console.log(`✓ PARTIAL MATCH for ${profile.name || profile.full_name}: "${industry}" partially matches "${interestStr}" in my_interests`);
                        console.log(`MATCH INFO: User ${profile.name || profile.full_name} - my_interests contains "${interestStr}" which partially matches search term "${industry}"`);
                        matched = true;
                        break;
                      }
                      
                      // Method 3: Word comparison (for multi-word interests) with improved accuracy
                      // Split both strings into words and check if any words match
                      const interestWords = lowercaseInterest.split(/\s+/).map(w => w.trim()).filter(w => w.length > 2);
                      const termWords = term.split(/\s+/).map(w => w.trim()).filter(w => w.length > 2);
                      
                      // Protect from ambiguous short word matches in industries
                      const commonWords = ['tech', 'technology', 'service', 'app', 'group', 'solution', 'system', 'platform'];
                      const meaningfulWords = termWords.filter(word => !commonWords.includes(word) && word.length > 3);
                      
                      // Only match if we have meaningful words to compare
                      if (meaningfulWords.length > 0) {
                        const matchingWords = interestWords.filter(word => 
                          // Require exact matches for short words (4 chars or less)
                          meaningfulWords.some(termWord => 
                            (word.length <= 4 && word === termWord) || 
                            // Allow partial matches for longer words
                            (word.length > 4 && termWord.length > 4 && 
                             (word === termWord || 
                              // For longer words, require substantial overlap
                              (word.includes(termWord) && termWord.length > 4) || 
                              (termWord.includes(word) && word.length > 4))
                            )
                          )
                        );
                        
                        if (matchingWords.length > 0) {
                          console.log(`✓ WORD MATCH for ${profile.name || profile.full_name}: "${industry}" matches "${interestStr}" by words: ${matchingWords.join(', ')}`);
                          console.log(`MATCH INFO: User ${profile.name || profile.full_name} - Found matching words: ${matchingWords.join(', ')}`);
                          matched = true;
                          break;
                        }
                      }
                    }
                    
                    if (matched) return true;
                  }
                  
                  // LAST CHANCE: If we got this far, try a more careful matching for short terms
                  if (normalizedIndustry.length <= 4) {
                    // For very short industry terms, be more careful with word boundaries
                    for (const interest of interestsArray) {
                      const interestStr = String(interest || '').toLowerCase();
                      
                      // Only match short terms at word boundaries
                      if (interestStr === normalizedIndustry || 
                          interestStr.startsWith(normalizedIndustry + ' ') || 
                          interestStr.includes(' ' + normalizedIndustry + ' ') || 
                          interestStr.endsWith(' ' + normalizedIndustry)) {
                        
                        // List of short ambiguous industry acronyms to be careful with
                        const ambiguousShortTerms = ['ai', 'ar', 'vr', 'hr', 'ml', 'ui', 'ux'];
                        
                        // For potentially ambiguous terms, perform extra checks
                        if (ambiguousShortTerms.includes(normalizedIndustry)) {
                          // Check if it's a valid match or a false positive
                          const isValidMatch = (
                            // Handle common abbreviations correctly
                            (normalizedIndustry === 'ai' && /\b(ai|artificial intelligence)\b/.test(interestStr)) ||
                            (normalizedIndustry === 'ar' && /\b(ar|augmented reality)\b/.test(interestStr)) ||
                            (normalizedIndustry === 'vr' && /\b(vr|virtual reality)\b/.test(interestStr)) ||
                            (normalizedIndustry === 'hr' && /\b(hr|human resources)\b/.test(interestStr)) ||
                            (normalizedIndustry === 'ml' && /\b(ml|machine learning)\b/.test(interestStr)) ||
                            // For all other cases, use word boundary check
                            !ambiguousShortTerms.includes(normalizedIndustry)
                          );
                          
                          if (!isValidMatch) {
                            continue; // Skip this match, it's likely a false positive
                          }
                        }
                        
                        console.log(`✓ LAST CHANCE MATCH: "${normalizedIndustry}" found as a distinct term in "${interestStr}"`);
                        return true;
                      }
                    }
                  }
                }
                
                // Check if the term exists in tags/skills but NOT in my_interests
                // This helps explain why some profiles are being skipped even though they seem to match
                if (profile.tags && Array.isArray(profile.tags)) {
                  for (const industry of selectedIndustries) {
                    const lowercaseIndustry = industry.toLowerCase();
                    const matchesInTags = profile.tags.some(tag => 
                      tag.toLowerCase() === lowercaseIndustry || 
                      tag.toLowerCase().includes(lowercaseIndustry)
                    );
                    
                    if (matchesInTags) {
                      console.log(`⚠️ INTENTIONALLY SKIPPING ${profile.name || profile.full_name}: "${industry}" found in tags but NOT in my_interests!`);
                      console.log(`   This profile has "${industry}" in tags/skills, but industry filter ONLY matches my_interests field.`);
                    }
                  }
                }
                
                // No match found for any of the selected industries
                console.log(`❌ NO MATCH for ${profile.name || profile.full_name}: None of the interests in my_interests match "${selectedIndustries.join(', ')}"`);
                return false;
              });
              
              console.log(`Industry filter applied, ${filteredProfiles.length} profiles match`);
            }
            
            // Apply technical skills filter if technical skills are selected
            if (hasTechnicalSkillsFilter) {
              console.log('Filtering by technical skills:', selectedTechnicalSkills);
              
              // For debugging, log a sample profile structure
              if (filteredProfiles.length > 0) {
                console.log('Sample profile technical skills data:', JSON.stringify({
                  technical_skills: filteredProfiles[0].technical_skills,
                  name: filteredProfiles[0].name
                }, null, 2));
              }
              
              filteredProfiles = filteredProfiles.filter(profile => {
                console.log(`Checking if ${profile.name || 'unknown'} has technical skills "${selectedTechnicalSkills.join(', ')}"`);
                
                if (!profile) {
                  console.log("Skipping null/undefined profile");
                  return false;
                }
                
                // Extract technical skills from profile
                let skillsArray = [];
                
                // Try various ways to access technical skills
                if (profile.technical_skills && Array.isArray(profile.technical_skills)) {
                  console.log(`Found technical skills as array for ${profile.name}:`, profile.technical_skills);
                  skillsArray = [...profile.technical_skills];
                }
                else if (profile.technical_skills && typeof profile.technical_skills === 'string') {
                  try {
                    if (profile.technical_skills.trim().startsWith('[') && profile.technical_skills.trim().endsWith(']')) {
                      const parsed = JSON.parse(profile.technical_skills);
                      if (Array.isArray(parsed)) {
                        console.log(`Parsed technical skills JSON array for ${profile.name}:`, parsed);
                        skillsArray = parsed;
                      }
                    } else {
                      const split = profile.technical_skills.split(',').map(s => s.trim()).filter(s => s);
                      console.log(`Split technical skills string for ${profile.name}:`, split);
                      skillsArray = split;
                    }
                  } catch (e) {
                    console.log(`Failed to parse technical skills string:`, profile.technical_skills);
                  }
                }
                else if (profile.skills && Array.isArray(profile.skills)) {
                  console.log(`Using skills array as fallback for ${profile.name}:`, profile.skills);
                  skillsArray = [...profile.skills];
                }
                
                // Clean and normalize skills
                skillsArray = [...new Set(skillsArray)]
                  .filter(item => item !== null && item !== undefined)
                  .map(item => typeof item === 'string' ? item : String(item));
                
                console.log(`Final technical skills for ${profile.name}:`, skillsArray);
                
                // Check if we have any match with the selected technical skills
                // Check for additional skills fields in the profile
                if (skillsArray.length === 0) {
                  console.log(`No skills found in primary fields, checking additional fields for ${profile.name}`);
                  
                  // Check additional fields that might contain skills
                  const additionalFields = ['skills', 'skill', 'user_skills', 'skillset', 'abilities', 'expertise'];
                  
                  for (const field of additionalFields) {
                    if (profile[field]) {
                      let fieldValue = profile[field];
                      console.log(`Found potential skills in field "${field}" for ${profile.name}:`, fieldValue);
                      
                      if (Array.isArray(fieldValue)) {
                        skillsArray = [...skillsArray, ...fieldValue];
                      } else if (typeof fieldValue === 'string') {
                        try {
                          // Try to parse as JSON
                          if (fieldValue.trim().startsWith('[') && fieldValue.trim().endsWith(']')) {
                            const parsed = JSON.parse(fieldValue);
                            if (Array.isArray(parsed)) {
                              skillsArray = [...skillsArray, ...parsed];
                            }
                          } else {
                            // Split by comma
                            const split = fieldValue.split(',').map(s => s.trim()).filter(s => s);
                            skillsArray = [...skillsArray, ...split];
                          }
                        } catch (e) {
                          // Add as a single value if parsing fails
                          skillsArray.push(fieldValue);
                        }
                      } else if (typeof fieldValue === 'object' && fieldValue !== null) {
                        // Extract values from object
                        Object.values(fieldValue).forEach(val => {
                          if (val) skillsArray.push(String(val));
                        });
                      }
                    }
                  }
                }
                
                // Also check profile.tags which often contains skills
                if (profile.tags && Array.isArray(profile.tags) && profile.tags.length > 0) {
                  console.log(`Adding tags as potential skills for ${profile.name}:`, profile.tags);
                  skillsArray = [...skillsArray, ...profile.tags];
                }
                
                // Also check description or bio for skill mentions as last resort
                const textFields = ['description', 'bio', 'about', 'summary'];
                for (const field of textFields) {
                  if (profile[field] && typeof profile[field] === 'string' && skillsArray.length === 0) {
                    // Search for each selected skill in the text
                    for (const skill of selectedTechnicalSkills) {
                      if (profile[field].toLowerCase().includes(skill.toLowerCase())) {
                        console.log(`Found skill "${skill}" mentioned in ${field} for ${profile.name}`);
                        skillsArray.push(skill);
                      }
                    }
                  }
                }
                
                // Clean and normalize skills again after adding from additional fields
                skillsArray = [...new Set(skillsArray)]
                  .filter(item => item !== null && item !== undefined)
                  .map(item => typeof item === 'string' ? item : String(item));
                
                console.log(`FINAL technical skills for ${profile.name} after checking all fields:`, skillsArray);
                
                // Don't filter out users if no skills found - return true for these users
                if (skillsArray.length === 0) {
                  console.log(`⚠️ No skills found for ${profile.name} in any field - NOT filtering this profile out`);
                  return true; // Allow profiles without skills to still appear
                }
                
                let matchedAny = false;
                
                for (const skill of selectedTechnicalSkills) {
                  let normalizedSkill = (skill || '').toString().toLowerCase().trim();
                  normalizedSkill = normalizedSkill.replace(/\s+/g, ' ');
                  
                  console.log(`Checking for technical skill: "${skill}" (normalized: "${normalizedSkill}")`);
                  
                  if (!normalizedSkill) continue;
                  
                  // Generate search variations (more flexible)
                  const searchTerms = [normalizedSkill];
                  
                  // Add single word variations
                  if (normalizedSkill.includes(' ')) {
                    const words = normalizedSkill.split(/\s+/).filter(word => word.length > 2);
                    searchTerms.push(...words);
                  }
                  
                  // Special handling for common programming language confusion
                  // Define mappings for commonly confused programming languages
                  const languagePairs = {
                    'javascript': ['javascript', 'js', 'ecmascript'],
                    'typescript': ['typescript', 'ts'],
                    'python': ['python', 'py'],
                    'c++': ['c++', 'cpp'],
                    'c#': ['c#', 'csharp'],
                    'java': ['java'],
                    'php': ['php'],
                    'ruby': ['ruby'],
                    'go': ['go', 'golang']
                  };
                  
                  // If we're searching for a language that has specific forms
                  if (languagePairs[normalizedSkill]) {
                    // Check if profile has this language specifically in any of its accepted forms
                    const validForms = languagePairs[normalizedSkill];
                    
                    const hasLanguage = skillsArray.some(s => {
                      const str = String(s || '').trim().toLowerCase();
                      return validForms.some(form => str === form || str.includes(form));
                    });
                    
                    // If profile has the exact language, it's a match
                    if (hasLanguage) {
                      console.log(`✓ Profile "${profile.name}" has ${normalizedSkill} explicitly - good match`);
                      matchedAny = true;
                      break; // Found a match, no need to check further
                    }
                  }
                  
                  // Check against all skills in the profile
                  for (const profileSkill of skillsArray) {
                    if (!profileSkill) continue;
                    
                    const skillStr = (typeof profileSkill === 'string' ? profileSkill : String(profileSkill)).trim();
                    if (!skillStr) continue;
                    
                    const lowercaseSkill = skillStr.toLowerCase();
                    
                    for (const term of searchTerms) {
                      // Exact match
                      if (lowercaseSkill === term) {
                        console.log(`✓ EXACT MATCH for ${profile.name}: "${skill}" exactly matches "${skillStr}" in skills`);
                        matchedAny = true;
                        break;
                      }
                      
                      // Partial match - ONE WAY ONLY to prevent Java matching JavaScript
                      // Only match if the skill contains the search term, not the other way around
                      if (lowercaseSkill.includes(term) && 
                          // Prevent Java matching JavaScript - check word boundaries
                          (lowercaseSkill === term || 
                           lowercaseSkill.startsWith(term + ' ') || 
                           lowercaseSkill.includes(' ' + term + ' ') || 
                           lowercaseSkill.endsWith(' ' + term) ||
                           // Special check for compound technical terms like JavaScript
                           (term.length > 4 && lowercaseSkill.includes(term)))) {
                        console.log(`✓ PARTIAL MATCH for ${profile.name}: "${skill}" partially matches "${skillStr}" in skills`);
                        matchedAny = true;
                        break;
                      }
                      
                      // Word boundary match - for matching whole words only
                      try {
                        // Escape special regex characters first
                        const escapedTerm = term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                        const skillRegex = new RegExp(`\\b${escapedTerm}\\b`, 'i');
                        if (skillRegex.test(lowercaseSkill)) {
                          console.log(`✓ WORD BOUNDARY MATCH for ${profile.name}: "${skill}" matches "${skillStr}" as a whole word`);
                          matchedAny = true;
                          break;
                        }
                      } catch (e) {
                        console.log(`Regex error with term "${term}": ${e.message}`);
                        // Try a simpler comparison as fallback
                        if (lowercaseSkill === term || (' ' + lowercaseSkill + ' ').includes(' ' + term + ' ')) {
                          console.log(`✓ FALLBACK MATCH for ${profile.name}: "${skill}" matches "${skillStr}" with fallback method`);
                          matchedAny = true;
                          break;
                        }
                      }
                      
                      // Substring match - with specific boundaries for technical skills
                      if (term.length > 2 && lowercaseSkill.includes(term)) {
                        // For technical skills, we need to be more careful about boundaries
                        // Check that we're not matching a substring that's actually part of a different language name
                        
                        // Common prefix/suffix patterns in programming languages
                        const commonPrefixes = ['node', 'react', 'angular', 'vue', 'ruby', 'python', 'perl', 'php', 'go', 'c', 'r'];
                        const commonSuffixes = ['js', 'script', 'sharp', '++', '#', '.net', 'lang', 'on', 'py'];
                        
                        // Avoid common false positives for programming languages (Java/JavaScript etc.)
                        const potentiallyAmbiguous = [
                          // Normal ambiguity is handled by exact matches
                          // These are only used in substring matching contexts
                          { search: 'type', avoid: 'typescript' },
                          { search: 'c', avoid: ['c++', 'c#', 'objective-c'] },
                          { search: 'r', avoid: 'rust' }
                        ];
                        
                        // Check if we're dealing with a potentially ambiguous term
                        const ambiguousMatch = potentiallyAmbiguous.find(pair => 
                          pair.search === term && (
                            Array.isArray(pair.avoid) 
                              ? pair.avoid.some(avoid => lowercaseSkill === avoid)
                              : lowercaseSkill === pair.avoid
                          )
                        );
                        
                        if (ambiguousMatch) {
                          console.log(`⚠️ Avoiding ambiguous match: "${term}" is part of "${lowercaseSkill}" - NOT a match`);
                          continue;
                        }
                        
                        // Check if this is a standalone match or part of a compound term
                        const isPotentiallyFalseMatch = 
                          // Check if it's part of a programming language with prefix
                          commonPrefixes.some(prefix => lowercaseSkill === prefix + term && term !== lowercaseSkill) ||
                          // Check if it's part of a programming language with suffix
                          commonSuffixes.some(suffix => lowercaseSkill === term + suffix && term !== lowercaseSkill);
                        
                        if (isPotentiallyFalseMatch) {
                          console.log(`⚠️ Potential false match: "${term}" is part of compound term "${lowercaseSkill}" - skipping`);
                          continue;
                        }
                        
                        console.log(`✓ SUBSTRING MATCH for ${profile.name}: "${skill}" substring found in "${skillStr}"`);
                        matchedAny = true;
                        break;
                      }
                      
                      // Special handling for very short skill names like "C++" or "PHP" or "AAA"
                      if (term.length <= 3 && (
                          lowercaseSkill === term || 
                          lowercaseSkill.startsWith(term + ' ') || 
                          lowercaseSkill.includes(' ' + term + ' ') || 
                          lowercaseSkill.endsWith(' ' + term))) {
                        console.log(`✓ SHORT SKILL MATCH for ${profile.name}: Short skill "${skill}" found in "${skillStr}"`);
                        matchedAny = true;
                        break;
                      }
                    }
                    
                    if (matchedAny) break;
                  }
                  
                  if (matchedAny) break;
                }
                
                return matchedAny;
              });
              
              console.log(`Technical skills filter applied, ${filteredProfiles.length} profiles match`);
            }
            
            // Apply soft skills filter if soft skills are selected
            if (hasSoftSkillsFilter) {
              console.log('Filtering by soft skills:', selectedSoftSkills);
              
              // For debugging, log a sample profile structure
              if (filteredProfiles.length > 0) {
                console.log('Sample profile soft skills data:', JSON.stringify({
                  soft_skills: filteredProfiles[0].soft_skills,
                  name: filteredProfiles[0].name
                }, null, 2));
              }
              
              filteredProfiles = filteredProfiles.filter(profile => {
                console.log(`Checking if ${profile.name || 'unknown'} has soft skills "${selectedSoftSkills.join(', ')}"`);
                
                if (!profile) {
                  console.log("Skipping null/undefined profile");
                  return false;
                }
                
                // Extract soft skills from profile
                let skillsArray = [];
                
                // Try various ways to access soft skills
                if (profile.soft_skills && Array.isArray(profile.soft_skills)) {
                  console.log(`Found soft skills as array for ${profile.name}:`, profile.soft_skills);
                  skillsArray = [...profile.soft_skills];
                }
                else if (profile.soft_skills && typeof profile.soft_skills === 'string') {
                  try {
                    if (profile.soft_skills.trim().startsWith('[') && profile.soft_skills.trim().endsWith(']')) {
                      const parsed = JSON.parse(profile.soft_skills);
                      if (Array.isArray(parsed)) {
                        console.log(`Parsed soft skills JSON array for ${profile.name}:`, parsed);
                        skillsArray = parsed;
                      }
                    } else {
                      const split = profile.soft_skills.split(',').map(s => s.trim()).filter(s => s);
                      console.log(`Split soft skills string for ${profile.name}:`, split);
                      skillsArray = split;
                    }
                  } catch (e) {
                    console.log(`Failed to parse soft skills string:`, profile.soft_skills);
                  }
                }
                else if (profile.skills && Array.isArray(profile.skills)) {
                  console.log(`Using skills array as fallback for ${profile.name}:`, profile.skills);
                  skillsArray = [...profile.skills];
                }
                
                // Clean and normalize skills
                skillsArray = [...new Set(skillsArray)]
                  .filter(item => item !== null && item !== undefined)
                  .map(item => typeof item === 'string' ? item : String(item));
                
                console.log(`Final soft skills for ${profile.name}:`, skillsArray);
                
                // Check if we have any match with the selected soft skills
                // Check for additional skills fields in the profile
                if (skillsArray.length === 0) {
                  console.log(`No skills found in primary fields, checking additional fields for ${profile.name}`);
                  
                  // Check additional fields that might contain skills
                  const additionalFields = ['skills', 'skill', 'user_skills', 'skillset', 'abilities', 'expertise'];
                  
                  for (const field of additionalFields) {
                    if (profile[field]) {
                      let fieldValue = profile[field];
                      console.log(`Found potential skills in field "${field}" for ${profile.name}:`, fieldValue);
                      
                      if (Array.isArray(fieldValue)) {
                        skillsArray = [...skillsArray, ...fieldValue];
                      } else if (typeof fieldValue === 'string') {
                        try {
                          // Try to parse as JSON
                          if (fieldValue.trim().startsWith('[') && fieldValue.trim().endsWith(']')) {
                            const parsed = JSON.parse(fieldValue);
                            if (Array.isArray(parsed)) {
                              skillsArray = [...skillsArray, ...parsed];
                            }
                          } else {
                            // Split by comma
                            const split = fieldValue.split(',').map(s => s.trim()).filter(s => s);
                            skillsArray = [...skillsArray, ...split];
                          }
                        } catch (e) {
                          // Add as a single value if parsing fails
                          skillsArray.push(fieldValue);
                        }
                      } else if (typeof fieldValue === 'object' && fieldValue !== null) {
                        // Extract values from object
                        Object.values(fieldValue).forEach(val => {
                          if (val) skillsArray.push(String(val));
                        });
                      }
                    }
                  }
                }
                
                // Also check profile.tags which often contains skills
                if (profile.tags && Array.isArray(profile.tags) && profile.tags.length > 0) {
                  console.log(`Adding tags as potential skills for ${profile.name}:`, profile.tags);
                  skillsArray = [...skillsArray, ...profile.tags];
                }
                
                // Also check description or bio for skill mentions as last resort
                const textFields = ['description', 'bio', 'about', 'summary'];
                for (const field of textFields) {
                  if (profile[field] && typeof profile[field] === 'string' && skillsArray.length === 0) {
                    // Search for each selected skill in the text
                    for (const skill of selectedSoftSkills) {
                      if (profile[field].toLowerCase().includes(skill.toLowerCase())) {
                        console.log(`Found skill "${skill}" mentioned in ${field} for ${profile.name}`);
                        skillsArray.push(skill);
                      }
                    }
                  }
                }
                
                // Clean and normalize skills again after adding from additional fields
                skillsArray = [...new Set(skillsArray)]
                  .filter(item => item !== null && item !== undefined)
                  .map(item => typeof item === 'string' ? item : String(item));
                
                console.log(`FINAL soft skills for ${profile.name} after checking all fields:`, skillsArray);
                
                // Don't filter out users if no skills found - return true for these users
                if (skillsArray.length === 0) {
                  console.log(`⚠️ No skills found for ${profile.name} in any field - NOT filtering this profile out`);
                  return true; // Allow profiles without skills to still appear
                }
                
                let matchedAny = false;
                
                for (const skill of selectedSoftSkills) {
                  let normalizedSkill = (skill || '').toString().toLowerCase().trim();
                  normalizedSkill = normalizedSkill.replace(/\s+/g, ' ');
                  
                  console.log(`Checking for soft skill: "${skill}" (normalized: "${normalizedSkill}")`);
                  
                  if (!normalizedSkill) continue;
                  
                  // Generate search variations (more flexible)
                  const searchTerms = [normalizedSkill];
                  
                  // Add single word variations
                  if (normalizedSkill.includes(' ')) {
                    const words = normalizedSkill.split(/\s+/).filter(word => word.length > 2);
                    searchTerms.push(...words);
                  }
                  
                  // Special handling for common programming language confusion
                  // Define mappings for commonly confused programming languages
                  const languagePairs = {
                    'javascript': ['javascript', 'js', 'ecmascript'],
                    'typescript': ['typescript', 'ts'],
                    'python': ['python', 'py'],
                    'c++': ['c++', 'cpp'],
                    'c#': ['c#', 'csharp'],
                    'java': ['java'],
                    'php': ['php'],
                    'ruby': ['ruby'],
                    'go': ['go', 'golang']
                  };
                  
                  // If we're searching for a language that has specific forms
                  if (languagePairs[normalizedSkill]) {
                    // Check if profile has this language specifically in any of its accepted forms
                    const validForms = languagePairs[normalizedSkill];
                    
                    const hasLanguage = skillsArray.some(s => {
                      const str = String(s || '').trim().toLowerCase();
                      return validForms.some(form => str === form || str.includes(form));
                    });
                    
                    // If profile has the exact language, it's a match
                    if (hasLanguage) {
                      console.log(`✓ Profile "${profile.name}" has ${normalizedSkill} explicitly - good match`);
                      matchedAny = true;
                      break; // Found a match, no need to check further
                    }
                  }
                  
                  // Check against all skills in the profile
                  for (const profileSkill of skillsArray) {
                    if (!profileSkill) continue;
                    
                    const skillStr = (typeof profileSkill === 'string' ? profileSkill : String(profileSkill)).trim();
                    if (!skillStr) continue;
                    
                    const lowercaseSkill = skillStr.toLowerCase();
                    
                    for (const term of searchTerms) {
                      // Exact match
                      if (lowercaseSkill === term) {
                        console.log(`✓ EXACT MATCH for ${profile.name}: "${skill}" exactly matches "${skillStr}" in skills`);
                        matchedAny = true;
                        break;
                      }
                      
                      // Partial match - ONE WAY ONLY to prevent Java matching JavaScript
                      // Only match if the skill contains the search term, not the other way around
                      if (lowercaseSkill.includes(term) && 
                          // Prevent Java matching JavaScript - check word boundaries
                          (lowercaseSkill === term || 
                           lowercaseSkill.startsWith(term + ' ') || 
                           lowercaseSkill.includes(' ' + term + ' ') || 
                           lowercaseSkill.endsWith(' ' + term) ||
                           // Special check for compound technical terms like JavaScript
                           (term.length > 4 && lowercaseSkill.includes(term)))) {
                        console.log(`✓ PARTIAL MATCH for ${profile.name}: "${skill}" partially matches "${skillStr}" in skills`);
                        matchedAny = true;
                        break;
                      }
                      
                      // Word boundary match - for matching whole words only
                      try {
                        // Escape special regex characters first
                        const escapedTerm = term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                        const skillRegex = new RegExp(`\\b${escapedTerm}\\b`, 'i');
                        if (skillRegex.test(lowercaseSkill)) {
                          console.log(`✓ WORD BOUNDARY MATCH for ${profile.name}: "${skill}" matches "${skillStr}" as a whole word`);
                          matchedAny = true;
                          break;
                        }
                      } catch (e) {
                        console.log(`Regex error with term "${term}": ${e.message}`);
                        // Try a simpler comparison as fallback
                        if (lowercaseSkill === term || (' ' + lowercaseSkill + ' ').includes(' ' + term + ' ')) {
                          console.log(`✓ FALLBACK MATCH for ${profile.name}: "${skill}" matches "${skillStr}" with fallback method`);
                          matchedAny = true;
                          break;
                        }
                      }
                      
                      // Substring match - with specific boundaries for technical skills
                      if (term.length > 2 && lowercaseSkill.includes(term)) {
                        // For technical skills, we need to be more careful about boundaries
                        // Check that we're not matching a substring that's actually part of a different language name
                        
                        // Common prefix/suffix patterns in programming languages
                        const commonPrefixes = ['node', 'react', 'angular', 'vue', 'ruby', 'python', 'perl', 'php', 'go', 'c', 'r'];
                        const commonSuffixes = ['js', 'script', 'sharp', '++', '#', '.net', 'lang', 'on', 'py'];
                        
                        // Avoid common false positives for programming languages (Java/JavaScript etc.)
                        const potentiallyAmbiguous = [
                          // Normal ambiguity is handled by exact matches
                          // These are only used in substring matching contexts
                          { search: 'type', avoid: 'typescript' },
                          { search: 'c', avoid: ['c++', 'c#', 'objective-c'] },
                          { search: 'r', avoid: 'rust' }
                        ];
                        
                        // Check if we're dealing with a potentially ambiguous term
                        const ambiguousMatch = potentiallyAmbiguous.find(pair => 
                          pair.search === term && (
                            Array.isArray(pair.avoid) 
                              ? pair.avoid.some(avoid => lowercaseSkill === avoid)
                              : lowercaseSkill === pair.avoid
                          )
                        );
                        
                        if (ambiguousMatch) {
                          console.log(`⚠️ Avoiding ambiguous match: "${term}" is part of "${lowercaseSkill}" - NOT a match`);
                          continue;
                        }
                        
                        // Check if this is a standalone match or part of a compound term
                        const isPotentiallyFalseMatch = 
                          // Check if it's part of a programming language with prefix
                          commonPrefixes.some(prefix => lowercaseSkill === prefix + term && term !== lowercaseSkill) ||
                          // Check if it's part of a programming language with suffix
                          commonSuffixes.some(suffix => lowercaseSkill === term + suffix && term !== lowercaseSkill);
                        
                        if (isPotentiallyFalseMatch) {
                          console.log(`⚠️ Potential false match: "${term}" is part of compound term "${lowercaseSkill}" - skipping`);
                          continue;
                        }
                        
                        console.log(`✓ SUBSTRING MATCH for ${profile.name}: "${skill}" substring found in "${skillStr}"`);
                        matchedAny = true;
                        break;
                      }
                      
                      // Special handling for very short skill names like "C++" or "PHP" or "AAA"
                      if (term.length <= 3 && (
                          lowercaseSkill === term || 
                          lowercaseSkill.startsWith(term + ' ') || 
                          lowercaseSkill.includes(' ' + term + ' ') || 
                          lowercaseSkill.endsWith(' ' + term))) {
                        console.log(`✓ SHORT SKILL MATCH for ${profile.name}: Short skill "${skill}" found in "${skillStr}"`);
                        matchedAny = true;
                        break;
                      }
                    }
                    
                    if (matchedAny) break;
                  }
                  
                  if (matchedAny) break;
                }
                
                return matchedAny;
              });
              
              console.log(`Soft skills filter applied, ${filteredProfiles.length} profiles match`);
            }
            
            // Sort profiles by match score (if available) or name
            filteredProfiles.sort((a, b) => {
              // First sort by match score if available (highest first)
              if (a.matchScore !== undefined && b.matchScore !== undefined) {
                if (a.matchScore !== b.matchScore) {
                  return b.matchScore - a.matchScore;
                }
              }
              
              // If institution filter is applied, prioritize exact institution matches
              if (hasInstitutionFilter) {
                const aInstitutionMatch = isExactInstitutionMatch(a, selectedInstitution, institutionInput.getAttribute('data-ipedsid'));
                const bInstitutionMatch = isExactInstitutionMatch(b, selectedInstitution, institutionInput.getAttribute('data-ipedsid'));
                
                if (aInstitutionMatch && !bInstitutionMatch) return -1;
                if (!aInstitutionMatch && bInstitutionMatch) return 1;
              }
              
              // Then sort alphabetically by name
              const nameA = a.name || a.full_name || '';
              const nameB = b.name || b.full_name || '';
              return nameA.localeCompare(nameB);
            });
            
            // Helper function to check for exact institution match
            function isExactInstitutionMatch(profile, searchTerm, ipedsid) {
              // Check for exact IPEDS ID match (most reliable)
              if (ipedsid && ipedsid !== 'manual-entry' && 
                  profile.institution && 
                  typeof profile.institution === 'object' && 
                  profile.institution.ipedsid === ipedsid) {
                console.log('Exact IPEDS match for profile:', profile.name);
                return true;
              }
              
              // Check multiple institution fields and formats
              if (profile.institution && typeof profile.institution === 'object') {
                // First check the value field (primary field)
                if (profile.institution.value) {
                  const valueField = profile.institution.value;
                  
                  // Direct full string comparison (exact match with full format)
                  if (valueField.toLowerCase() === searchTerm.toLowerCase()) {
                    console.log('Exact match with full institution value for:', profile.name);
                    return true;
                  }
                  
                  // Compare institution names (without location info)
                  let institutionName = valueField;
                  let cleanSearchTerm = searchTerm;
                  
                  // Extract institution name from pipe format if needed
                  if (institutionName.includes('|')) {
                    institutionName = institutionName.split('|')[0].trim();
                  }
                  
                  if (cleanSearchTerm.includes('|')) {
                    cleanSearchTerm = cleanSearchTerm.split('|')[0].trim();
                  }
                  
                  // Case insensitive comparison of just the institution names
                  const nameMatch = institutionName.toLowerCase() === cleanSearchTerm.toLowerCase();
                  if (nameMatch) {
                    console.log('Exact name match for:', profile.name, 'with institution:', institutionName);
                    return true;
                  }
                }
                
                // Also check custom field if different from value field
                if (profile.institution.custom && 
                    (!profile.institution.value || 
                     profile.institution.custom !== profile.institution.value)) {
                  
                  const customField = profile.institution.custom;
                  
                  // Direct full string comparison
                  if (customField.toLowerCase() === searchTerm.toLowerCase()) {
                    console.log('Exact match with full custom institution value for:', profile.name);
                    return true;
                  }
                  
                  // Compare institution names (without location info)
                  let customName = customField;
                  let cleanSearchTerm = searchTerm;
                  
                  // Extract institution name from pipe format
                  if (customName.includes('|')) {
                    customName = customName.split('|')[0].trim();
                  }
                  
                  if (cleanSearchTerm.includes('|')) {
                    cleanSearchTerm = cleanSearchTerm.split('|')[0].trim();
                  }
                  
                  // Case insensitive comparison
                  const customMatch = customName.toLowerCase() === cleanSearchTerm.toLowerCase();
                  if (customMatch) {
                    console.log('Exact custom field match for:', profile.name, 'with institution:', customName);
                    return true;
                  }
                }
                
                // No exact matches found in object format
                return false;
              } 
              else {
                // Legacy string format
                const institutionString = profile.institution || profile.institute || '';
                let cleanSearchTerm = searchTerm;
                
                // Extract name from pipe format if needed
                if (cleanSearchTerm.includes('|')) {
                  cleanSearchTerm = cleanSearchTerm.split('|')[0].trim();
                }
                
                // Case insensitive comparison
                const stringMatch = institutionString.toLowerCase() === cleanSearchTerm.toLowerCase();
                
                if (stringMatch) {
                  console.log('Exact string match for:', profile.name, 'with institution:', institutionString);
                }
                
                return stringMatch;
              }
            }
            
            // Update the UI to show only filtered profiles
            if (filteredProfiles.length === 0) {
              // Show "no profiles found" message
              const profileCard = document.getElementById('current-profile');
              if (profileCard) {
                profileCard.innerHTML = `
                  <div style="height: 100%; display: flex; align-items: center; justify-content: center; text-align: center; padding: 20px; background-color: white; border-radius: 15px;">
                    <div>
                      <h3>No profiles found</h3>
                      <p>No profiles match your filter criteria. Try different filter options.</p>
                      <button class="btn btn-primary mt-3" onclick="document.getElementById('reset-filters-btn').click()">Reset Filters</button>
                    </div>
                  </div>
                `;
              }
              
              // Clear the all users container
              const usersContainer = document.getElementById('all-users-container');
              if (usersContainer) {
                usersContainer.innerHTML = `
                  <div class="col-12 text-center py-5">
                    <div class="alert alert-info" role="alert">
                      <h4 class="alert-heading">No Matching Profiles</h4>
                      <p>There are no profiles that match your selected filters.</p>
                      <hr>
                      <button class="btn btn-primary" onclick="document.getElementById('reset-filters-btn').click()">Reset Filters</button>
                    </div>
                  </div>
                `;
              }
            } else {
              // Store the filtered profiles temporarily
              window.filteredProfiles = filteredProfiles;
              
              // Reset the current profile index
              window.currentProfileIndex = 0;
              
              // Update the main profile card
              loadProfile(currentProfileIndex);
              
              // Re-render the grid of profile cards
              renderFilteredUsersList();
            }
            
            // Show success message
            if (typeof showToast === 'function') {
              showToast(`Filters applied. Showing ${filteredProfiles.length} matching profiles.`, 'success');
            } else {
              alert(`Filters applied. Showing ${filteredProfiles.length} matching profiles.`);
            }
          } else {
            console.error('No profiles array available for filtering');
            alert('Error applying filters: No profiles available');
          }
        });
        
        // Handle reset filters button
        resetBtn.addEventListener('click', function(e) {
          e.preventDefault();
          
          // Reset form
          filterForm.reset();
          
          // Reset gender dropdown to "All"
          const genderSelect = document.getElementById('gender-filter');
          if (genderSelect) {
            genderSelect.value = '';
          }
          
          // Reset institution field
          if (institutionInput) {
            institutionInput.value = '';
            institutionInput.removeAttribute('data-ipedsid');
            institutionInput.removeAttribute('data-fullname');
          }
          
          // Reset state dropdown to "All"
          const stateSelect = document.getElementById('state-filter');
          if (stateSelect) {
            stateSelect.value = '';
          }
          
          // Reset year of study dropdown to "All"
          const yearOfStudySelect = document.getElementById('year-of-study-filter');
          if (yearOfStudySelect) {
            yearOfStudySelect.value = '';
          }
          
          // Reset major type dropdown to "All"
          const majorTypeSelect = document.getElementById('major-type-filter');
          if (majorTypeSelect) {
            majorTypeSelect.value = '';
          }
          
          // Reset area of study dropdown to "All"
          const majorCategorySelect = document.getElementById('major-filter');
          if (majorCategorySelect) {
            majorCategorySelect.value = '';
          }
          
          // Reset industry filter
          const industryTagsContainer = document.getElementById('industry-tags-container');
          const industryHiddenInput = document.getElementById('industry-hidden-input');
          if (industryTagsContainer) {
            // Remove all industry tags
            const tags = Array.from(industryTagsContainer.getElementsByClassName('industry-tag'));
            tags.forEach(tag => tag.remove());
            // Clear the hidden input
            if (industryHiddenInput) {
              industryHiddenInput.value = '';
            }
          }
          
          // Reset technical skills filter
          const technicalSkillsTagsContainer = document.getElementById('technical-skills-tags-container');
          const technicalSkillsHiddenInput = document.getElementById('technical-skills-hidden-input');
          if (technicalSkillsTagsContainer) {
            // Remove all technical skills tags
            const tags = Array.from(technicalSkillsTagsContainer.getElementsByClassName('industry-tag'));
            tags.forEach(tag => tag.remove());
            // Clear the hidden input
            if (technicalSkillsHiddenInput) {
              technicalSkillsHiddenInput.value = '';
            }
          }
          
          // Reset soft skills filter
          const softSkillsTagsContainer = document.getElementById('soft-skills-tags-container');
          const softSkillsHiddenInput = document.getElementById('soft-skills-hidden-input');
          if (softSkillsTagsContainer) {
            // Remove all soft skills tags
            const tags = Array.from(softSkillsTagsContainer.getElementsByClassName('industry-tag'));
            tags.forEach(tag => tag.remove());
            // Clear the hidden input
            if (softSkillsHiddenInput) {
              softSkillsHiddenInput.value = '';
            }
          }
          
          // Clear any filtering and show all profiles again
          if (window.profiles && Array.isArray(window.profiles)) {
            // Clear temporary filtered profiles
            window.filteredProfiles = null;
            
            // Reset current profile index
            window.currentProfileIndex = 0;
            
            // Update the main profile card
            loadProfile(currentProfileIndex);
            
            // Re-render the full grid of profile cards
            renderAllUsersList();
            
            // Show success message
            if (typeof showToast === 'function') {
              showToast('Filters reset. Showing all profiles.', 'info');
            } else {
              alert('Filters reset. Showing all profiles.');
            }
          }
        });
      }
      
      // Debug function to help troubleshoot filter fields
      function debugFilterFields() {
        
        
        // Check major/major type/major sub-category fields
        const majorFields = {
          majorFilter: document.getElementById('major-filter'),
          majorTypeFilter: document.getElementById('major-type-filter'),
          majorSubInput: document.getElementById('major-sub-filter'),
          majorSubHidden: document.getElementById('major-sub-filter-hidden'),
          majorSubContainer: document.getElementById('major-sub-filter-container'),
          majorSubDropdown: document.querySelector('.major-subcategory-dropdown')
        };
        
        console.log("Major Field Elements:", {
          majorFilter: majorFields.majorFilter ? "Found" : "Missing",
          majorTypeFilter: majorFields.majorTypeFilter ? "Found" : "Missing", 
          majorSubInput: majorFields.majorSubInput ? "Found" : "Missing",
          majorSubHidden: majorFields.majorSubHidden ? "Found" : "Missing",
          majorSubContainer: majorFields.majorSubContainer ? "Found" : "Missing",
          majorSubDropdown: majorFields.majorSubDropdown ? "Found" : "Missing"
        });
        
        if (majorFields.majorFilter) {
          console.log("Major Filter Options:", Array.from(majorFields.majorFilter.options).map(o => o.value));
        }
        
        if (majorFields.majorTypeFilter) {
          console.log("Major Type Filter Options:", Array.from(majorFields.majorTypeFilter.options).map(o => o.value));
        }
        
        if (majorFields.majorSubDropdown) {
          console.log("Major Sub Dropdown Items:", 
            Array.from(majorFields.majorSubDropdown.querySelectorAll('.major-subcategory-item:not(.major-subcategory-custom-option)'))
              .map(item => ({ value: item.getAttribute('data-value'), label: item.textContent }))
          );
        }
        
        // Current values
        console.log("Current Major Sub Values:", {
          inputValue: majorFields.majorSubInput ? majorFields.majorSubInput.value : 'N/A',
          hiddenValue: majorFields.majorSubHidden ? majorFields.majorSubHidden.value : 'N/A',
          isCustomMode: majorFields.majorSubInput ? 
            majorFields.majorSubInput.hasAttribute('data-custom-input-active') : false,
          isReadonly: majorFields.majorSubInput ? 
            majorFields.majorSubInput.hasAttribute('readonly') : 'N/A'
        });
        
        // Test populating major options
        if (majorFields.majorFilter && majorFields.majorTypeFilter) {
          const selectedMajor = majorFields.majorFilter.value;
          const selectedType = majorFields.majorTypeFilter.value;
          
          
          try {
            // Try to manually trigger the change events
            
            
            // Set test values
            majorFields.majorFilter.value = 'Engineering';
            majorFields.majorTypeFilter.value = 'Technical';
            
            // Trigger events
            const event = new Event('change', { bubbles: true });
            majorFields.majorFilter.dispatchEvent(event);
            majorFields.majorTypeFilter.dispatchEvent(event);
            
            // Check if dropdown items were populated
            setTimeout(() => {
              if (majorFields.majorSubDropdown) {
                const items = majorFields.majorSubDropdown.querySelectorAll('.major-subcategory-item:not(.major-subcategory-custom-option)');
                
                if (items.length > 0) {
                  console.log("Sample items:", 
                    Array.from(items).slice(0, 3).map(item => ({
                      value: item.getAttribute('data-value'),
                      label: item.textContent
                    }))
                  );
                }
              }
            }, 100);
          } catch (error) {
            console.error("Error simulating change events:", error);
          }
        }
        
        // Test dropdown visibility
        
        if (majorFields.majorSubDropdown) {
          
          
          // Test clicking the input to toggle dropdown
          try {
            
            majorFields.majorSubInput.click();
            
            setTimeout(() => {
              
              
              // Test clicking custom option
              const customOption = majorFields.majorSubDropdown.querySelector('.major-subcategory-custom-option');
              if (customOption) {
                
                customOption.click();
                
                setTimeout(() => {
                  console.log("After custom option click:", {
                    dropdownDisplay: majorFields.majorSubDropdown.style.display,
                    inputReadonly: majorFields.majorSubInput.getAttribute('readonly'),
                    customModeActive: majorFields.majorSubInput.hasAttribute('data-custom-input-active')
                  });
                }, 100);
              }
            }, 100);
          } catch (error) {
            console.error("Error testing dropdown visibility:", error);
          }
        }
        
        // Force initialize again
        
        initMajorDependentFields();
        
        // Alert to let user know debugging is done
        alert("Filter fields debug info has been logged to the console. Press F12 to view.");
      }
    </script>
  </body>
  <!-- [Body] end -->
</html> 

